---
import { resolveWidgetsMegaMenu } from './widgetsMegaMenu';
import { pragueT } from '../../../lib/i18n';
import { listPragueLocales } from '../../../lib/locales';

type Props = {
  title: string;
  locale: string;
  homeHref?: string;
  cta?: { label: string; href: string; variant?: 'primary' | 'secondary' };
  /** Overlay the nav on top of the page surface (hero background extends under it). */
  overlay?: boolean;
};

const { title, locale, homeHref = `/${locale}/`, cta, overlay = false } = Astro.props;
const ctaVariant = cta?.variant ?? 'secondary';

const widgetsLabel = await pragueT(locale, 'prague.nav.widgets');
const viewAllWidgetsLabel = await pragueT(locale, 'prague.nav.viewAllWidgets');

const mega = await resolveWidgetsMegaMenu({ locale });
const locales = listPragueLocales();
const currentPath = Astro.url?.pathname ?? `/${locale}/`;
const currentSearch = Astro.url?.search ?? '';
const localeHrefFor = (targetLocale: string) => {
  const prefix = `/${locale}`;
  if (currentPath === '/' || currentPath === '') return `/${targetLocale}/${currentSearch}`;
  if (currentPath === prefix) return `/${targetLocale}/${currentSearch}`;
  if (currentPath.startsWith(`${prefix}/`)) {
    const rest = currentPath.slice(prefix.length) || '/';
    return `/${targetLocale}${rest}${currentSearch}`;
  }
  return `/${targetLocale}/${currentSearch}`;
};
---

<div class:list={["ck-siteNavMount", overlay && "is-overlay"]}>
<header class="ck-siteNavHeader">
  <div class="ck-canvas ck-siteNavCanvas">
    <div class="ck-inline">
      <div class="ck-row ck-siteNav">
        <div class="ck-siteNav__brandGroup">
          <a href={homeHref} class="ck-brand" aria-label={title}>
            <img class="ck-brand__logo" src="/brand/clickeen-logo-full.svg" alt={title} />
          </a>
          <label class="ck-siteNav__locale">
            <select
              class="ck-siteNav__localeSelect label-s"
              aria-label="Switch locale"
              onChange="if (this.value) window.location.href = this.value"
            >
              {locales.map((loc) => (
                <option value={localeHrefFor(loc)} selected={loc === locale}>
                  {loc.toUpperCase()}
                </option>
              ))}
            </select>
          </label>
        </div>

        <nav aria-label="Primary" class="ck-siteNav__primary">
          <div class="ck-mega" data-ck-mega="widgets">
            <a href={mega.allWidgetsHref} class="label-s ck-siteNav__link ck-mega__trigger" aria-haspopup="true">
              {widgetsLabel}
            </a>

            <div class="ck-mega__panel" role="dialog" aria-label="Widgets menu">
              <div class="ck-inline">
                <div class="ck-mega__layout">
                  <div class="ck-mega__grid">
                    {mega.items.map((w) => (
                      <a class="ck-mega__item" href={w.href}>
                        <div class="label-s">{w.title}</div>
                        <div class="caption ck-mega__sub">{w.description}</div>
                      </a>
                    ))}
                  </div>
                  <div class="ck-mega__footer">
                    <a class="label-s ck-mega__footerLink" href={mega.allWidgetsHref}>
                      {viewAllWidgetsLabel}
                    </a>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </nav>

        <div class="ck-row ck-siteNav__actions">
          {cta ? (
            <a class={`ck-btn ck-btn--${ctaVariant} ck-btn--md label-m ck-siteNav__cta`} href={cta.href}>
              {cta.label}
            </a>
          ) : (
            <span aria-hidden="true" class="ck-siteNav__cta" />
          )}
        </div>
      </div>
    </div>
  </div>
</header>
</div>

<style is:global>
  /* Prague Global Nav (desktop-first)
     Desired behavior:
     - Rest state: transparent and scrolls away with the page
     - Hover/focus on dropdown trigger: show mega menu (CSS-only)
     - While mega menu is open: nav becomes sticky and stays open
  */

  :root {
    /* Used by top-of-page heroes to keep content clear of the overlay nav,
       while still allowing their background to extend underneath it.
       Keep this token-driven (no magic pixels) so it stays correct as controls/tokens evolve. */
    --ck-siteNavPadBlock: var(--space-5);
    --ck-siteNavControlMinH: var(--min-touch-target);
    --ck-siteNav-h: calc(var(--ck-siteNavPadBlock) * 2 + var(--ck-siteNavControlMinH));
  }

  .ck-siteNavMount {
    position: relative;
    width: 100%;
  }

  /* Overlay mode: nav is taken out of flow (hero surface can start at y=0). */
  .ck-siteNavMount.is-overlay {
    height: 0;
  }

  .ck-siteNavHeader {
    position: relative;
    z-index: 60;
    width: 100%;
  }

  .ck-siteNavMount.is-overlay .ck-siteNavHeader {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
  }

  .ck-siteNavCanvas {
    position: relative;
    padding-block: var(--ck-siteNavPadBlock);
    background: transparent;
    border-bottom: 1px solid transparent;
    overflow: visible;
    transition: background-color 160ms cubic-bezier(0.16, 1, 0.3, 1),
      border-color 160ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* When any mega is open (hover/focus), the nav pins and surfaces.
     - Normal mode: sticky (prevents layout shifts)
     - Overlay mode: fixed (nav is already out-of-flow)
  */
  .ck-siteNavHeader:has(.ck-mega__trigger:hover, .ck-mega__panel:hover, .ck-mega:focus-within) {
    position: sticky;
    top: 0;
  }

  .ck-siteNavMount.is-overlay .ck-siteNavHeader:has(.ck-mega__trigger:hover, .ck-mega__panel:hover, .ck-mega:focus-within) {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
  }

  .ck-siteNavHeader:has(.ck-mega__trigger:hover, .ck-mega__panel:hover, .ck-mega:focus-within) .ck-siteNavCanvas {
    background: var(--color-system-white);
    border-bottom-color: color-mix(in oklab, var(--color-system-black), transparent 90%);
  }

  .ck-siteNav {
    justify-content: space-between;
    gap: var(--space-6);
  }

  .ck-siteNav__brandGroup {
    display: inline-flex;
    align-items: center;
    gap: var(--space-3);
  }

  .ck-siteNav__locale {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
  }

  .ck-siteNav__localeSelect {
    --btn-bg: color-mix(in oklab, var(--color-system-black) 8%, transparent);
    --btn-hover-bg: color-mix(in oklab, var(--color-system-black) 35%, transparent);
    --btn-radius: var(--control-radius-sm);
    --btn-min-h: 2.25rem;
    --btn-px: calc(var(--control-padding-inline) - var(--space-1));

    appearance: none;
    border: 0;
    background: var(--btn-bg);
    border-radius: var(--btn-radius);
    padding-block: 0;
    padding-inline: var(--btn-px);
    padding-right: calc(var(--btn-px) + 16px);
    min-height: var(--btn-min-h);
    color: var(--color-system-black);
    cursor: pointer;
    letter-spacing: -0.02em;
    background-image: url("data:image/svg+xml,%3Csvg width='10' height='6' viewBox='0 0 10 6' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M1 1L5 5L9 1' stroke='black' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 8px center;
  }

  .ck-siteNav__localeSelect:hover {
    background-color: var(--btn-hover-bg);
  }

  .ck-siteNav__localeSelect:focus-visible {
    outline: 2px solid color-mix(in oklab, var(--color-system-black), transparent 70%);
    outline-offset: 2px;
  }

  .ck-siteNav__primary {
    display: flex;
    align-items: center;
    gap: var(--space-5);
  }

  .ck-siteNav__actions {
    align-items: center;
    gap: var(--space-3);
  }

  .ck-siteNav__link {
    text-decoration: none;
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
    transition: color 120ms ease-out;
  }

  .ck-siteNav__link:hover {
    color: var(--color-system-black);
  }

  .ck-siteNav__link.is-disabled {
    opacity: 0.55;
    cursor: default;
    user-select: none;
  }

  .ck-brand {
    display: inline-flex;
    align-items: center;
    text-decoration: none;
    color: inherit;
  }

  .ck-brand__logo {
    height: 22px;
    width: auto;
    display: block;
  }

  /* Mega menu */
  .ck-mega {
    position: static;
  }

  .ck-mega__trigger {
    position: relative;
    text-decoration: none;
    color: inherit;
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    user-select: none;
  }

  /* Expand hover hit-area without changing layout (prevents sticky toggle flicker). */
  .ck-mega__trigger::before {
    content: '';
    position: absolute;
    inset: calc(var(--space-2) * -1) calc(var(--space-3) * -1);
    background: transparent;
  }

  .ck-mega__panel {
    position: absolute;
    left: 0;
    right: 0;
    /* Anchor to the bottom of the nav row (canvas height minus its bottom padding). */
    top: calc(100% - var(--ck-siteNavPadBlock));
    z-index: 70;
    background: var(--color-system-white);
    border: 0;
    border-radius: 0;
    /* Downward-only shadow (avoid any top bleed that can read like nav opacity). */
    box-shadow:
      0 22px 64px -44px color-mix(in oklab, var(--color-system-black), transparent 78%),
      0 10px 22px -18px color-mix(in oklab, var(--color-system-black), transparent 88%);
    padding-block: var(--space-7);
    opacity: 0;
    transform: translateY(-8px) scale(0.99);
    pointer-events: none;
    transition: opacity 160ms cubic-bezier(0.16, 1, 0.3, 1),
      transform 160ms cubic-bezier(0.16, 1, 0.3, 1);
  }

  /* Invisible hover bridge: prevents a 1â€“8px "dead zone" from closing the menu. */
  .ck-mega__panel::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: calc(var(--space-3) * -1);
    height: var(--space-3);
    background: transparent;
  }

  .ck-mega:has(.ck-mega__trigger:hover, .ck-mega__panel:hover) .ck-mega__panel,
  .ck-mega:focus-within .ck-mega__panel {
    opacity: 1;
    transform: translateY(0) scale(1);
    pointer-events: auto;
  }

  @media (max-width: 900px) {
    :root {
      --ck-siteNavPadBlock: var(--space-4);
    }

    .ck-brand__logo {
      height: 20px;
    }

  }

  .ck-mega__layout {
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
  }

  .ck-mega__grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: var(--space-3);
  }

  .ck-mega__item {
    display: block;
    padding: var(--space-4);
    border-radius: var(--control-radius-lg);
    text-decoration: none;
    color: var(--color-system-black);
    background: color-mix(in oklab, var(--color-system-black), transparent 96%);
    transition: background 140ms ease-out, transform 140ms ease-out;
  }

  .ck-mega__item:hover {
    background: color-mix(in oklab, var(--color-system-black), transparent 92%);
  }

  .ck-mega__item:active {
    transform: scale(0.99);
  }

  .ck-mega__sub {
    margin-top: 6px;
    color: color-mix(in oklab, var(--color-system-black), transparent 55%);
  }

  .ck-mega__footer {
    display: flex;
    justify-content: flex-end;
    padding-top: var(--space-2);
  }

  .ck-mega__footerLink {
    text-decoration: none;
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
  }

  .ck-mega__footerLink:hover {
    color: var(--color-system-black);
    text-decoration: underline;
    text-underline-offset: 3px;
  }

  @media (prefers-reduced-motion: reduce) {
    .ck-siteNavCanvas,
    .ck-mega__panel {
      transition: none !important;
    }
  }
</style>
