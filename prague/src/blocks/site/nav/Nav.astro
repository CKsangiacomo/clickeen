---
import { resolveWidgetsMegaMenu } from './widgetsMegaMenu';
import { pragueT } from '../../../lib/i18n';

type Props = {
  title: string;
  locale: string;
  homeHref?: string;
  // Legacy escape hatch: some pages may still pass items, but the scalable default is system-owned nav.
  items?: { label: string; href: string }[];
  cta?: { label: string; href: string; variant?: 'primary' | 'secondary' };
  /**
   * Nav surface model:
   * - overlay: transparent at top-of-page; becomes surfaced when stuck (default)
   * - solid: always surfaced (use on non-hero pages if desired)
   */
  surface?: 'overlay' | 'solid';
  /** Enable sticky behavior (visual + position). Default true. */
  sticky?: boolean;
};

const { title, locale, homeHref = `/${locale}/`, items: itemsProp, cta } = Astro.props;
const ctaVariant = cta?.variant ?? 'secondary';
const navSurface = (Astro.props.surface ?? 'overlay') as NonNullable<Props['surface']>;
const navSticky = Astro.props.sticky !== false;

const pathname = Astro.url.pathname;

type WidgetSubpage = 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
const widgetMatch = pathname.match(/^\/[^/]+\/widgets\/([^/]+)(?:\/([^/]+))?\/?$/);
const widget = widgetMatch?.[1] ?? null;
const widgetPage = (widgetMatch?.[2] ?? 'overview') as WidgetSubpage;
const isWidgetPage = Boolean(widget);

const widgetsLabel = pragueT(locale, 'prague.nav.widgets');

const widgetTabs = widget
  ? ([
      { label: pragueT(locale, 'prague.tabs.overview'), href: `/${locale}/widgets/${widget}`, key: 'overview' },
      { label: pragueT(locale, 'prague.tabs.templates'), href: `/${locale}/widgets/${widget}/templates`, key: 'templates' },
      { label: pragueT(locale, 'prague.tabs.examples'), href: `/${locale}/widgets/${widget}/examples`, key: 'examples' },
      { label: pragueT(locale, 'prague.tabs.features'), href: `/${locale}/widgets/${widget}/features`, key: 'features' },
      { label: pragueT(locale, 'prague.tabs.pricing'), href: `/${locale}/widgets/${widget}/pricing`, key: 'pricing' },
    ] as const)
  : [];

const mega = await resolveWidgetsMegaMenu({ locale });

const primaryItems =
  itemsProp ??
  ([
    { label: widgetsLabel, href: mega.allWidgetsHref },
  ] as const);
---

<header
  class="ck-canvas ck-siteNavHeader"
  data-nav-surface={navSurface}
  data-nav-sticky={navSticky ? 'true' : 'false'}
  data-nav-stuck="false"
>
  <div class="ck-inline">
    <div class="ck-row ck-siteNav">
      <a href={homeHref} class="ck-brand" aria-label={title}>
        <img class="ck-brand__logo" src="/brand/clickeen-logo-full.svg" alt={title} />
      </a>

      <nav aria-label="Primary">
        <div class="ck-row ck-siteNav__primary">
          {primaryItems.map((item) =>
            item.href === mega.allWidgetsHref ? (
              <details class="ck-navWidgets">
                <summary
                  class="label-s ck-navWidgets__trigger"
                  aria-haspopup="true"
                >
                  {widgetsLabel}
                </summary>

                <div class="ck-navWidgets__menu" role="dialog" aria-label="Widgets menu">
                  <div class="ck-navWidgets__grid">
                    {mega.items.map((w) => (
                      <a class="ck-navWidgets__item" href={w.href}>
                        <div class="label-s">{w.headline}</div>
                        {w.subheadline ? (
                          <div class="caption ck-navWidgets__sub">{w.subheadline}</div>
                        ) : null}
                      </a>
                    ))}
                  </div>

                  <div class="ck-navWidgets__footer">
                    <a class="ck-btn ck-btn--secondary ck-btn--md label-m" href={mega.allWidgetsHref}>
                      {pragueT(locale, 'prague.nav.viewAllWidgets')}
                    </a>
                  </div>
                </div>
              </details>
            ) : (
              <a
                href={item.href}
                class="label-s ck-siteNav__link"
              >
                {item.label}
              </a>
            ),
          )}
        </div>
      </nav>

      {cta ? (
        <a class={`ck-btn ck-btn--${ctaVariant} ck-btn--md label-m`} href={cta.href}>
          {cta.label}
        </a>
      ) : (
        <span aria-hidden="true" />
      )}
    </div>

    {isWidgetPage ? (
      <div class="ck-row ck-siteNav__tabs">
        {widgetTabs.map((t) => {
          const isActive = t.key === widgetPage;
          return (
            <a
              href={t.href}
              class={`label-s ck-siteNav__tab${isActive ? ' is-active' : ''}`}
              aria-current={isActive ? 'page' : undefined}
            >
              {t.label}
            </a>
          );
        })}
      </div>
    ) : null}
  </div>
</header>

<style>
  .ck-siteNav { position: relative; }

  /* Nav state machine (global, scalable):
     - surface: overlay | solid
     - stuck: false | true
     This keeps page-level styling out of page templates and prevents drift. */
  .ck-siteNavHeader {
    padding-block: var(--space-5);
    position: sticky;
    top: 0;
    z-index: 60;

    /* Default (overlay) values */
    --ck-nav-bg: transparent;
    --ck-nav-border: transparent;
    --ck-nav-shadow: none;
    --ck-nav-backdrop: none;

    background: var(--ck-nav-bg);
    border-bottom: 1px solid var(--ck-nav-border);
    box-shadow: var(--ck-nav-shadow);
    backdrop-filter: var(--ck-nav-backdrop);
    -webkit-backdrop-filter: var(--ck-nav-backdrop);
  }

  .ck-siteNavHeader[data-nav-sticky="false"] {
    position: relative;
    top: auto;
  }

  /* Solid surface (always) */
  .ck-siteNavHeader[data-nav-surface="solid"] {
    --ck-nav-bg: color-mix(in oklab, var(--color-system-white), transparent 6%);
    --ck-nav-border: color-mix(in oklab, var(--color-system-black), transparent 90%);
    --ck-nav-shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
    --ck-nav-backdrop: blur(14px);
  }

  /* Overlay surface: becomes surfaced only when stuck */
  .ck-siteNavHeader[data-nav-surface="overlay"][data-nav-stuck="true"] {
    --ck-nav-bg: color-mix(in oklab, var(--color-system-white), transparent 6%);
    --ck-nav-border: color-mix(in oklab, var(--color-system-black), transparent 90%);
    --ck-nav-shadow: 0 8px 22px rgba(0, 0, 0, 0.06);
    --ck-nav-backdrop: blur(14px);
  }

  .ck-siteNav {
    justify-content: space-between;
    gap: var(--space-6);
  }

  .ck-siteNav__primary { gap: var(--space-5); }

  .ck-siteNav__link {
    text-decoration: none;
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
  }
  .ck-brand { display: inline-flex; align-items: center; text-decoration: none; color: inherit; }
  .ck-brand__logo { height: 22px; width: auto; display: block; }

  .ck-navWidgets { position: relative; }

  .ck-navWidgets__trigger {
    display: inline-flex;
    align-items: center;
    gap: var(--space-2);
    cursor: pointer;
    user-select: none;
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
  }

  .ck-navWidgets__trigger::-webkit-details-marker { display: none; }
  .ck-navWidgets__trigger::marker { content: ''; }

  .ck-navWidgets__menu {
    display: none;
    position: absolute;
    top: calc(100% + 12px);
    left: 50%;
    transform: translateX(-50%);
    width: min(920px, calc(100vw - 48px));
    background: var(--color-system-white);
    border-radius: var(--control-radius-xl);
    padding: var(--space-6);
    box-shadow: 0 20px 80px rgba(0, 0, 0, 0.12);
    z-index: 50;
  }

  /* Hover bridge: prevents the menu from closing while moving the cursor from the trigger to the menu. */
  .ck-navWidgets__menu::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: -12px;
    height: 12px;
  }

  .ck-navWidgets[open] .ck-navWidgets__menu,
  .ck-navWidgets:hover .ck-navWidgets__menu,
  .ck-navWidgets:focus-within .ck-navWidgets__menu {
    display: block;
  }

  .ck-navWidgets__grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: var(--space-3);
  }

  .ck-navWidgets__item {
    display: block;
    padding: var(--space-3);
    border-radius: var(--control-radius-lg);
    text-decoration: none;
    color: var(--color-system-black);
    background: color-mix(in oklab, var(--color-system-black), transparent 96%);
  }

  .ck-navWidgets__item:hover {
    background: color-mix(in oklab, var(--color-system-black), transparent 92%);
  }

  .ck-navWidgets__sub {
    margin-top: 4px;
    color: color-mix(in oklab, var(--color-system-black), transparent 55%);
  }

  .ck-siteNav__tabs {
    gap: var(--space-4);
    margin-top: var(--space-4);
  }

  .ck-siteNav__tab {
    text-decoration: none;
    padding: 6px 10px;
    border-radius: var(--control-radius-md);
    color: color-mix(in oklab, var(--color-system-black), transparent 35%);
  }

  .ck-siteNav__tab.is-active {
    color: var(--color-system-black);
    background: color-mix(in oklab, var(--color-system-black), transparent 92%);
  }

  .ck-navWidgets__footer {
    display: flex;
    justify-content: flex-end;
    margin-top: var(--space-5);
  }

  @media (max-width: 900px) {
    .ck-brand__logo { height: 20px; }
    .ck-navWidgets__grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  @media (max-width: 640px) {
    .ck-navWidgets__grid { grid-template-columns: 1fr; }
    .ck-navWidgets__menu { left: 0; transform: none; width: calc(100vw - 24px); }
  }
</style>

{navSticky ? (
  <script>
    {`
(() => {
  const header = document.querySelector('.ck-siteNavHeader[data-nav-sticky="true"]');
  if (!header) return;

  // Toggle "stuck" styling when the page scrolls. Keep the controller tiny and deterministic.
  const update = () => {
    const stuck = window.scrollY > 8;
    header.setAttribute('data-nav-stuck', stuck ? 'true' : 'false');
  };

  update();
  window.addEventListener('scroll', update, { passive: true });
})();
`}
  </script>
) : null}
