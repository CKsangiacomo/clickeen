---
type Props = {
  widgetType: string;
  page: string;
  blockId: string;
  locale: string;
  height?: string;
  title?: string;
};

const { widgetType, page, blockId, locale, height = '360px', title = 'Widget preview' } = Astro.props;

const VENICE_URL = import.meta.env.PUBLIC_VENICE_URL;
const creativeKey = `${widgetType}.${page}.${blockId}`;
const publicId = `wgt_web_${creativeKey}`;
const okWebsiteCreativePublicId = /^wgt_web_[a-z0-9]([a-z0-9_-]*[a-z0-9])?([.][a-z0-9]([a-z0-9_-]*[a-z0-9])?)*$/i.test(
  publicId,
);
if (!okWebsiteCreativePublicId) {
  throw new Error(
    `[Prague] Invalid website creative publicId '${publicId}' (website creatives are locale-free; locale is a runtime query param)`,
  );
}
const ts = import.meta.env.DEV ? `&ts=${Date.now()}` : '';
const iframeSrc = VENICE_URL
  ? `${VENICE_URL.replace(/\/+$/, '')}/e/${encodeURIComponent(publicId)}?theme=light&device=desktop&locale=${encodeURIComponent(locale)}${ts}`
  : null;

const anchorId = `ck-creative-${publicId.replace(/[^a-z0-9_-]+/gi, '-')}`;
---

<div class="ck-websiteCreative" id={anchorId} data-ck-creative-id={anchorId}>
  {iframeSrc ? (
    <>
      <iframe
        class="ck-websiteCreative__iframe"
        title={title}
        src={iframeSrc}
        style={`height: ${height};`}
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms"
      />

      {/* Global creative chrome (outside iframe): share bar (hover/focus reveal). */}
      <div class="ck-websiteCreative__topbar">
        <details class="ck-share">
          <summary class="ck-share__btn">
            <span class="ck-share__btnIcon" aria-hidden="true">
              <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 3v12"></path>
                <path d="M7 8l5-5 5 5"></path>
                <path d="M5 21h14"></path>
              </svg>
            </span>
            <span class="label-s">Share</span>
          </summary>

          <div class="ck-share__menu" role="menu" aria-label="Share options">
            <div class="ck-share__toast" role="status" aria-live="polite"></div>

            <div class="ck-share__group">
              <div class="ck-share__groupTitle label-xs">Quick</div>
              <button type="button" class="ck-share__item" data-action="native">
                <span class="ck-share__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M12 16V4"></path>
                    <path d="M7 9l5-5 5 5"></path>
                    <path d="M4 20h16"></path>
                  </svg>
                </span>
                <span class="ck-share__text">System share</span>
              </button>
              <button type="button" class="ck-share__item" data-action="copy">
                <span class="ck-share__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <rect x="9" y="9" width="13" height="13" rx="3"></rect>
                    <rect x="2" y="2" width="13" height="13" rx="3"></rect>
                  </svg>
                </span>
                <span class="ck-share__text">Copy link</span>
              </button>
            </div>

            <div class="ck-share__sep" aria-hidden="true"></div>

            <div class="ck-share__group">
              <div class="ck-share__groupTitle label-xs">Messages</div>
              <button type="button" class="ck-share__item" data-action="sms">
                <span class="ck-share__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15a4 4 0 0 1-4 4H8l-5 3V7a4 4 0 0 1 4-4h10a4 4 0 0 1 4 4z"></path>
                  </svg>
                </span>
                <span class="ck-share__text">Text (SMS)</span>
              </button>
              <button type="button" class="ck-share__item" data-action="email">
                <span class="ck-share__icon" aria-hidden="true">
                  <svg viewBox="0 0 24 24" width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 4h16v16H4z"></path>
                    <path d="M4 7l8 6 8-6"></path>
                  </svg>
                </span>
                <span class="ck-share__text">Email</span>
              </button>
              <button type="button" class="ck-share__item" data-action="whatsapp">
                <span class="ck-share__icon" aria-hidden="true">WA</span>
                <span class="ck-share__text">WhatsApp</span>
              </button>
              <button type="button" class="ck-share__item" data-action="telegram">
                <span class="ck-share__icon" aria-hidden="true">TG</span>
                <span class="ck-share__text">Telegram</span>
              </button>
              <button type="button" class="ck-share__item" data-action="signal">
                <span class="ck-share__icon" aria-hidden="true">SG</span>
                <span class="ck-share__text">Signal</span>
              </button>
              <button type="button" class="ck-share__item" data-action="messenger">
                <span class="ck-share__icon" aria-hidden="true">M</span>
                <span class="ck-share__text">Messenger</span>
              </button>
              <button type="button" class="ck-share__item" data-action="wechat">
                <span class="ck-share__icon" aria-hidden="true">WC</span>
                <span class="ck-share__text">WeChat</span>
              </button>
              <button type="button" class="ck-share__item" data-action="line">
                <span class="ck-share__icon" aria-hidden="true">LN</span>
                <span class="ck-share__text">LINE</span>
              </button>
              <button type="button" class="ck-share__item" data-action="slack">
                <span class="ck-share__icon" aria-hidden="true">S</span>
                <span class="ck-share__text">Slack</span>
              </button>
              <button type="button" class="ck-share__item" data-action="teams">
                <span class="ck-share__icon" aria-hidden="true">T</span>
                <span class="ck-share__text">Microsoft Teams</span>
              </button>
              <button type="button" class="ck-share__item" data-action="discord">
                <span class="ck-share__icon" aria-hidden="true">D</span>
                <span class="ck-share__text">Discord</span>
              </button>
            </div>

            <div class="ck-share__sep" aria-hidden="true"></div>

            <div class="ck-share__group">
              <div class="ck-share__groupTitle label-xs">Social</div>
              <button type="button" class="ck-share__item" data-action="x">
                <span class="ck-share__icon" aria-hidden="true">X</span>
                <span class="ck-share__text">X</span>
              </button>
              <button type="button" class="ck-share__item" data-action="linkedin">
                <span class="ck-share__icon" aria-hidden="true">in</span>
                <span class="ck-share__text">LinkedIn</span>
              </button>
              <button type="button" class="ck-share__item" data-action="facebook">
                <span class="ck-share__icon" aria-hidden="true">f</span>
                <span class="ck-share__text">Facebook</span>
              </button>
              <button type="button" class="ck-share__item" data-action="reddit">
                <span class="ck-share__icon" aria-hidden="true">r/</span>
                <span class="ck-share__text">Reddit</span>
              </button>
              <button type="button" class="ck-share__item" data-action="pinterest">
                <span class="ck-share__icon" aria-hidden="true">P</span>
                <span class="ck-share__text">Pinterest</span>
              </button>
              <button type="button" class="ck-share__item" data-action="instagram">
                <span class="ck-share__icon" aria-hidden="true">IG</span>
                <span class="ck-share__text">Instagram</span>
              </button>
              <button type="button" class="ck-share__item" data-action="tiktok">
                <span class="ck-share__icon" aria-hidden="true">TT</span>
                <span class="ck-share__text">TikTok</span>
              </button>
            </div>
          </div>
        </details>
      </div>
    </>
  ) : (
    <div class="ck-media ck-websiteCreative__stub">
      Missing <code>PUBLIC_VENICE_URL</code> — cannot embed {publicId}
    </div>
  )}
</div>

<style>
  .ck-websiteCreative {
    width: 100%;
    position: relative;
    isolation: isolate;
    border-radius: var(--control-radius-lg);
    overflow: hidden;
    background: var(--color-system-white);
    border: 0;
  }

  .ck-websiteCreative__topbar {
    position: absolute;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    top: 0;
    height: 44px;
    justify-content: flex-end;
    padding-inline: var(--space-4);
    background: linear-gradient(
      to bottom,
      color-mix(in oklab, var(--color-system-black), transparent 92%),
      transparent
    );
    z-index: 3;
    opacity: 0;
    transition: opacity var(--duration-base, 160ms);
  }

  .ck-websiteCreative:hover .ck-websiteCreative__topbar,
  .ck-websiteCreative:focus-within .ck-websiteCreative__topbar {
    opacity: 1;
  }

  .ck-share {
    position: relative;
  }

  .ck-share__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    height: 36px;
    padding-inline: 14px;
    border-radius: 999px;
    background: color-mix(in oklab, var(--color-system-white), transparent 8%);
    color: color-mix(in oklab, var(--color-system-black), transparent 20%);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.10);
    cursor: pointer;
    user-select: none;
    list-style: none;
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 90%);
  }

  .ck-share__btn::-webkit-details-marker { display: none; }
  .ck-share__btn::marker { content: ''; }

  .ck-share__btnIcon {
    display: inline-flex;
    width: 18px;
    height: 18px;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    color: color-mix(in oklab, var(--color-system-black), transparent 35%);
  }

  .ck-share__menu {
    position: absolute;
    top: calc(100% + 10px);
    right: 0;
    width: min(360px, calc(100vw - 48px));
    max-height: min(480px, calc(100vh - 120px));
    overflow: auto;
    background: color-mix(in oklab, var(--color-system-white), transparent 4%);
    border-radius: var(--control-radius-2xl);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 90%);
    box-shadow: 0 28px 90px rgba(0, 0, 0, 0.16);
    padding: var(--space-4);
    display: none;
  }

  .ck-share[open] .ck-share__menu { display: block; }

  .ck-share__toast {
    position: sticky;
    top: 0;
    display: none;
    padding: 10px 12px;
    margin-bottom: var(--space-3);
    border-radius: var(--control-radius-lg);
    background: color-mix(in oklab, var(--color-system-black), transparent 92%);
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
    font: 500 var(--fs-13)/1.2 var(--font-ui);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .ck-share__group { display: flex; flex-direction: column; gap: var(--space-2); }
  .ck-share__groupTitle {
    color: color-mix(in oklab, var(--color-system-black), transparent 55%);
    padding: 2px 8px;
  }

  .ck-share__item {
    width: 100%;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: 12px 14px;
    border-radius: var(--control-radius-xl);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 92%);
    background: color-mix(in oklab, var(--color-system-white), transparent 6%);
    color: var(--color-system-black);
    cursor: pointer;
    font: 600 var(--fs-14)/1.2 var(--font-ui);
    text-align: left;
  }

  .ck-share__item:hover {
    background: color-mix(in oklab, var(--color-system-black), transparent 94%);
    border-color: color-mix(in oklab, var(--color-system-black), transparent 88%);
  }

  .ck-share__sep {
    height: 1px;
    margin: var(--space-4) 6px;
    background: color-mix(in oklab, var(--color-system-black), transparent 90%);
  }

  .ck-share__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: 10px;
    background: color-mix(in oklab, var(--color-system-black), transparent 94%);
    color: color-mix(in oklab, var(--color-system-black), transparent 18%);
    font: 700 var(--fs-11)/1 var(--font-ui);
    flex: 0 0 auto;
  }

  .ck-share__text { flex: 1 1 auto; }

  .ck-websiteCreative__iframe {
    width: 100%;
    border: 0;
    display: block;
    background: var(--color-system-white);
    position: relative;
    z-index: 1;
  }

  .ck-websiteCreative__stub {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    padding: var(--space-6);
    text-align: center;
  }
</style>

<script>
  {`
(() => {
  const root = document.currentScript?.previousElementSibling;
  // The script is rendered after the <style>, so walk up to the creative wrapper.
  const creative = document.currentScript?.closest?.('.ck-websiteCreative');
  if (!(creative instanceof HTMLElement)) return;

  const anchorId = creative.getAttribute('data-ck-creative-id') || creative.id || '';
  const details = creative.querySelector('.ck-share');
  const menu = creative.querySelector('.ck-share__menu');
  const toast = creative.querySelector('.ck-share__toast');
  if (!(details instanceof HTMLDetailsElement) || !(menu instanceof HTMLElement)) return;

  const close = () => { details.open = false; };
  document.addEventListener('click', (e) => {
    if (!details.open) return;
    const t = e.target;
    if (t instanceof Node && details.contains(t)) return;
    close();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') close();
  });

  function shareUrlFor(channel) {
    const u = new URL(window.location.href);
    if (anchorId) u.hash = anchorId;
    if (channel) {
      u.searchParams.set('ref', 'share');
      u.searchParams.set('channel', channel);
    }
    return u.toString();
  }

  let toastTimer = 0;
  function showToast(msg) {
    if (!(toast instanceof HTMLElement)) return;
    toast.textContent = msg;
    toast.style.display = 'block';
    if (toastTimer) window.clearTimeout(toastTimer);
    toastTimer = window.setTimeout(() => {
      toast.style.display = 'none';
      toast.textContent = '';
      toastTimer = 0;
    }, 1600);
  }

  async function copy(text) {
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch {}
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch {}
    document.body.removeChild(ta);
    return true;
  }

  function openUrl(url) {
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  async function handle(action) {
    const url = shareUrlFor(action);
    const title = document.title || 'Clickeen';
    const text = title;

    if (action === 'native') {
      if (navigator.share) {
        try {
          await navigator.share({ title, text, url: shareUrlFor('native') });
          showToast('Shared');
        } catch {}
        return;
      }
      await copy(shareUrlFor('copy'));
      showToast('Link copied');
      return;
    }

    if (action === 'copy') { await copy(url); showToast('Link copied'); return; }

    if (action === 'email') {
      const mailto = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(url);
      window.location.href = mailto;
      showToast('Opening email…');
      return;
    }

    if (action === 'sms') {
      const sms = 'sms:?&body=' + encodeURIComponent(url);
      window.location.href = sms;
      showToast('Opening messages…');
      return;
    }

    if (action === 'whatsapp') { openUrl('https://wa.me/?text=' + encodeURIComponent(url)); showToast('Opening WhatsApp…'); return; }
    if (action === 'telegram') { openUrl('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(title)); showToast('Opening Telegram…'); return; }
    if (action === 'signal') { await copy(url); showToast('Link copied (paste in Signal)'); openUrl('https://signal.me/'); return; }

    if (action === 'x') { openUrl('https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(title)); showToast('Opening X…'); return; }
    if (action === 'linkedin') { openUrl('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url)); showToast('Opening LinkedIn…'); return; }
    if (action === 'facebook') { openUrl('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url)); showToast('Opening Facebook…'); return; }
    if (action === 'reddit') { openUrl('https://www.reddit.com/submit?url=' + encodeURIComponent(url) + '&title=' + encodeURIComponent(title)); showToast('Opening Reddit…'); return; }
    if (action === 'discord') { await copy(url); showToast('Link copied (paste in Discord)'); openUrl('https://discord.com/channels/@me'); return; }
    if (action === 'pinterest') { openUrl('https://pinterest.com/pin/create/button/?url=' + encodeURIComponent(url) + '&description=' + encodeURIComponent(title)); showToast('Opening Pinterest…'); return; }
    if (action === 'messenger') { await copy(url); showToast('Link copied (paste in Messenger)'); openUrl('https://www.messenger.com/'); return; }
    if (action === 'slack') { await copy(url); showToast('Link copied (paste in Slack)'); openUrl('https://slack.com/app'); return; }
    if (action === 'teams') { await copy(url); showToast('Link copied (paste in Teams)'); openUrl('https://teams.microsoft.com/'); return; }

    // Platforms without a reliable web intent: copy link + best-effort open.
    if (action === 'instagram') { await copy(url); showToast('Link copied (paste in Instagram)'); openUrl('https://www.instagram.com/'); return; }
    if (action === 'tiktok') { await copy(url); showToast('Link copied (paste in TikTok)'); openUrl('https://www.tiktok.com/'); return; }
    if (action === 'wechat') { await copy(url); showToast('Link copied (paste in WeChat)'); return; }
    if (action === 'line') { await copy(url); showToast('Link copied (paste in LINE)'); openUrl('https://line.me/'); return; }
  }

  menu.addEventListener('click', async (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    const btn = t.closest('[data-action]');
    if (!(btn instanceof HTMLElement)) return;
    const action = btn.getAttribute('data-action') || '';
    if (!action) return;
    e.preventDefault();
    try { await handle(action); } finally { close(); }
  });
})();
`}
</script>
