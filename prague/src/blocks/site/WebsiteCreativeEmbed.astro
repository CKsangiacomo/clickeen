---
type Props = {
  widgetType: string;
  page: string;
  blockId: string;
  locale: string;
  height?: string;
  title?: string;
};

const { widgetType, page, blockId, locale, height = '360px', title = 'Widget preview' } = Astro.props;

const VENICE_URL = import.meta.env.PUBLIC_VENICE_URL;
const creativeKey = `${widgetType}.${page}.${blockId}`;
const publicId = `wgt_web_${creativeKey}`;
const okWebsiteCreativePublicId = /^wgt_web_[a-z0-9]([a-z0-9_-]*[a-z0-9])?([.][a-z0-9]([a-z0-9_-]*[a-z0-9])?)*$/i.test(
  publicId,
);
if (!okWebsiteCreativePublicId) {
  throw new Error(
    `[Prague] Invalid website creative publicId '${publicId}' (website creatives are locale-free; locale is a runtime query param)`,
  );
}
const ts = import.meta.env.DEV ? `&ts=${Date.now()}` : '';
const iframeSrc = VENICE_URL
  ? `${VENICE_URL.replace(/\/+$/, '')}/e/${encodeURIComponent(publicId)}?theme=light&device=desktop&locale=${encodeURIComponent(locale)}${ts}`
  : null;
---

<div class="ck-websiteCreative">
  {iframeSrc ? (
    <iframe
      class="ck-websiteCreative__iframe"
      title={title}
      src={iframeSrc}
      style={`height: ${height};`}
      loading="lazy"
      referrerpolicy="no-referrer"
      sandbox="allow-scripts allow-same-origin allow-forms"
    />
  ) : (
    <div class="ck-media ck-websiteCreative__stub">
      Missing <code>PUBLIC_VENICE_URL</code> — cannot embed {publicId}
    </div>
  )}
</div>

<style>
  .ck-websiteCreative {
    width: 100%;
    position: relative;
    isolation: isolate;
    border-radius: var(--control-radius-lg);
    overflow: hidden;
    background: var(--color-system-white);
    border: 0;
  }

  /* “Preview chrome”: subtle top bars (no border), stronger on hover. */
  .ck-websiteCreative::before {
    content: '';
    position: absolute;
    left: 0;
    right: 0;
    top: 0;
    height: 36px;
    z-index: 2;
    pointer-events: none;
    background: linear-gradient(
      to bottom,
      color-mix(in oklab, var(--color-system-black), transparent 92%),
      transparent
    );
    opacity: 0.65;
    transition: opacity var(--duration-base, 160ms);
  }

  .ck-websiteCreative::after {
    content: '';
    position: absolute;
    left: 14px;
    top: 12px;
    width: 46px;
    height: 12px;
    z-index: 3;
    pointer-events: none;
    background:
      radial-gradient(circle, color-mix(in oklab, var(--color-system-black), transparent 70%) 6px, transparent 7px) 0 0/16px 12px no-repeat,
      radial-gradient(circle, color-mix(in oklab, var(--color-system-black), transparent 78%) 6px, transparent 7px) 16px 0/16px 12px no-repeat,
      radial-gradient(circle, color-mix(in oklab, var(--color-system-black), transparent 86%) 6px, transparent 7px) 32px 0/16px 12px no-repeat;
    opacity: 0.55;
    transition: opacity var(--duration-base, 160ms);
  }

  .ck-websiteCreative:hover::before,
  .ck-websiteCreative:hover::after {
    opacity: 0.9;
  }

  .ck-websiteCreative__iframe {
    width: 100%;
    border: 0;
    display: block;
    background: var(--color-system-white);
    position: relative;
    z-index: 1;
  }

  .ck-websiteCreative__stub {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    padding: var(--space-6);
    text-align: center;
  }
</style>
