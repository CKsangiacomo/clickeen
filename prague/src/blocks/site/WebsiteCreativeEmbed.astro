---
import Icon from './Icon.astro';

type Props = {
  widgetType: string;
  page: string;
  blockId: string;
  locale: string;
  height?: string;
  title?: string;
};

const { widgetType, page, blockId, locale, height = '360px', title = 'Widget preview' } = Astro.props;

const VENICE_URL = import.meta.env.PUBLIC_VENICE_URL;
const creativeKey = `${widgetType}.${page}.${blockId}`;
const publicId = `wgt_web_${creativeKey}`;
const okWebsiteCreativePublicId = /^wgt_web_[a-z0-9]([a-z0-9_-]*[a-z0-9])?([.][a-z0-9]([a-z0-9_-]*[a-z0-9])?)*$/i.test(
  publicId,
);
if (!okWebsiteCreativePublicId) {
  throw new Error(
    `[Prague] Invalid website creative publicId '${publicId}' (website creatives are locale-free; locale is a runtime query param)`,
  );
}
const ts = import.meta.env.DEV ? `&ts=${Date.now()}` : '';
const iframeSrc = VENICE_URL
  ? `${VENICE_URL.replace(/\/+$/, '')}/e/${encodeURIComponent(publicId)}?theme=light&device=desktop&locale=${encodeURIComponent(locale)}${ts}`
  : null;

const anchorId = `ck-creative-${publicId.replace(/[^a-z0-9_-]+/gi, '-')}`;
---

<div class="ck-websiteCreative" id={anchorId} data-ck-creative-id={anchorId}>
  {iframeSrc ? (
    <>
      <iframe
        class="ck-websiteCreative__iframe"
        title={title}
        src={iframeSrc}
        style={`height: ${height};`}
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms"
      />

      {/* Global creative chrome (outside iframe): share bar (hover/focus reveal). */}
      <div class="ck-websiteCreative__topbar">
        <details class="ck-share">
          <summary class="ck-share__btn">
            <span class="ck-share__btnIcon" aria-hidden="true">
              <Icon name="share" size={18} />
            </span>
            <span class="label-s">Share</span>
          </summary>

          <div class="ck-share__menu" role="menu" aria-label="Share options">
            <div class="ck-share__toast" role="status" aria-live="polite"></div>

            <div class="ck-share__sectionTitle label-s">Send as message</div>
            <div class="ck-share__grid">
              <button type="button" class="ck-shareCard" data-action="copy">
                <span class="ck-shareCard__icon" aria-hidden="true">
                  <Icon name="copy" size={18} />
                </span>
                <span class="ck-shareCard__label label-xs">Copy link</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="sms">
                <span class="ck-shareCard__icon" aria-hidden="true">
                  <Icon name="sms" size={18} />
                </span>
                <span class="ck-shareCard__label label-xs">SMS</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="email">
                <span class="ck-shareCard__icon" aria-hidden="true">
                  <Icon name="email" size={18} />
                </span>
                <span class="ck-shareCard__label label-xs">Email</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="whatsapp">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="whatsapp" size={18} /></span>
                <span class="ck-shareCard__label label-xs">WhatsApp</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="telegram">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="telegram" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Telegram</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="signal">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Signal</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="messenger">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Messenger</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="wechat">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">WeChat</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="line">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">LINE</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="slack">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Slack</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="teams">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Teams</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="discord">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Discord</span>
              </button>
            </div>

            <div class="ck-share__sep" aria-hidden="true"></div>

            <div class="ck-share__sectionTitle label-s">Share on Social</div>
            <div class="ck-share__grid">
              <button type="button" class="ck-shareCard" data-action="x">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="x" size={18} /></span>
                <span class="ck-shareCard__label label-xs">X</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="linkedin">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="linkedin" size={18} /></span>
                <span class="ck-shareCard__label label-xs">LinkedIn</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="facebook">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="facebook" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Facebook</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="reddit">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="reddit" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Reddit</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="pinterest">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Pinterest</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="instagram">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">Instagram</span>
              </button>
              <button type="button" class="ck-shareCard" data-action="tiktok">
                <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="more" size={18} /></span>
                <span class="ck-shareCard__label label-xs">TikTok</span>
              </button>
            </div>
          </div>
        </details>
      </div>
    </>
  ) : (
    <div class="ck-media ck-websiteCreative__stub">
      Missing <code>PUBLIC_VENICE_URL</code> — cannot embed {publicId}
    </div>
  )}
</div>

<style>
  .ck-websiteCreative {
    width: 100%;
    position: relative;
    isolation: isolate;
    border-radius: var(--control-radius-lg);
    overflow: hidden;
    background: var(--color-system-white);
    border: 0;
  }

  .ck-websiteCreative__topbar {
    position: absolute;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    top: 0;
    height: 44px;
    justify-content: flex-end;
    padding-inline: var(--space-4);
    background: linear-gradient(
      to bottom,
      color-mix(in oklab, var(--color-system-black), transparent 92%),
      transparent
    );
    z-index: 3;
    opacity: 0;
    transition: opacity var(--duration-base, 160ms);
  }

  .ck-websiteCreative:hover .ck-websiteCreative__topbar,
  .ck-websiteCreative:focus-within .ck-websiteCreative__topbar {
    opacity: 1;
  }

  .ck-share {
    /* Let the menu position relative to the topbar (not the tiny share button). */
    position: static;
  }

  .ck-share__btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    height: 36px;
    padding-inline: 14px;
    border-radius: 999px;
    background: color-mix(in oklab, var(--color-system-white), transparent 8%);
    color: color-mix(in oklab, var(--color-system-black), transparent 20%);
    box-shadow: 0 10px 30px color-mix(in oklab, var(--color-system-black), transparent 90%);
    cursor: pointer;
    user-select: none;
    list-style: none;
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 90%);
  }

  .ck-share__btn::-webkit-details-marker { display: none; }
  .ck-share__btn::marker { content: ''; }

  .ck-share__btnIcon {
    display: inline-flex;
    width: 18px;
    height: 18px;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    line-height: 1;
    color: color-mix(in oklab, var(--color-system-black), transparent 35%);
  }

  .ck-share__menu {
    position: absolute;
    /* Anchor to the creative/topbar surface, not the button width */
    top: calc(44px + 10px);
    right: var(--space-2);
    left: auto;
    width: min(760px, calc(100vw - 32px));
    max-height: min(520px, calc(100vh - 120px));
    overflow: auto;
    background: var(--color-system-white);
    border-radius: var(--control-radius-2xl);
    border: 0;
    box-shadow: 0 28px 90px color-mix(in oklab, var(--color-system-black), transparent 86%);
    padding: 10px;
    display: none;
  }

  .ck-share[open] .ck-share__menu { display: block; }

  .ck-share__toast {
    position: sticky;
    top: 0;
    display: none;
    padding: 9px 10px;
    margin-bottom: var(--space-2);
    border-radius: var(--control-radius-lg);
    background: color-mix(in oklab, var(--color-system-white), transparent 25%);
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
    font: 500 var(--fs-13)/1.2 var(--font-ui);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
  }

  .ck-share__grid {
    display: grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap: var(--space-1);
  }

  .ck-share__sectionTitle {
    margin: 2px 6px var(--space-1);
    color: color-mix(in oklab, var(--color-system-black), transparent 55%);
    white-space: nowrap;
  }

  @media (min-width: 560px) {
    .ck-share__grid { grid-template-columns: repeat(4, minmax(0, 1fr)); }
  }

  @media (min-width: 860px) {
    .ck-share__grid { grid-template-columns: repeat(5, minmax(0, 1fr)); }
  }

  .ck-shareCard {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 6px;
    padding: 10px 8px;
    border-radius: var(--control-radius-xl);
    border: 0;
    background: var(--color-system-gray-6);
    color: var(--color-system-black);
    cursor: pointer;
    text-align: center;
  }

  .ck-shareCard:hover {
    background: var(--color-system-gray-5);
  }

  .ck-share__sep {
    height: 1px;
    margin: var(--space-2) 6px;
    background: color-mix(in oklab, var(--color-system-black), transparent 92%);
  }

  .ck-shareCard__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 20px;
    height: 20px;
    border-radius: 0;
    background: transparent;
    color: color-mix(in oklab, var(--color-system-black), transparent 22%);
    font: 700 var(--fs-12)/1 var(--font-ui);
    flex: 0 0 auto;
  }

  .ck-shareCard__label {
    display: block;
    color: color-mix(in oklab, var(--color-system-black), transparent 30%);
    letter-spacing: -0.01em;
    line-height: 1.05;
    text-wrap: balance;
  }

  @media (max-width: 520px) {
    .ck-share__grid { grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }

  .ck-websiteCreative__iframe {
    width: 100%;
    border: 0;
    display: block;
    background: var(--color-system-white);
    position: relative;
    z-index: 1;
  }

  .ck-websiteCreative__stub {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    padding: var(--space-6);
    text-align: center;
  }
</style>

<script>
  {`
(() => {
  const root = document.currentScript?.previousElementSibling;
  // The script is rendered after the <style>, so walk up to the creative wrapper.
  const creative = document.currentScript?.closest?.('.ck-websiteCreative');
  if (!(creative instanceof HTMLElement)) return;

  const anchorId = creative.getAttribute('data-ck-creative-id') || creative.id || '';
  const details = creative.querySelector('.ck-share');
  const menu = creative.querySelector('.ck-share__menu');
  const toast = creative.querySelector('.ck-share__toast');
  if (!(details instanceof HTMLDetailsElement) || !(menu instanceof HTMLElement)) return;

  const close = () => { details.open = false; };
  document.addEventListener('click', (e) => {
    if (!details.open) return;
    const t = e.target;
    if (t instanceof Node && details.contains(t)) return;
    close();
  });
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') close();
  });

  function shareUrlFor(channel) {
    const u = new URL(window.location.href);
    if (anchorId) u.hash = anchorId;
    if (channel) {
      u.searchParams.set('ref', 'share');
      u.searchParams.set('channel', channel);
    }
    return u.toString();
  }

  let toastTimer = 0;
  function showToast(msg) {
    if (!(toast instanceof HTMLElement)) return;
    toast.textContent = msg;
    toast.style.display = 'block';
    if (toastTimer) window.clearTimeout(toastTimer);
    toastTimer = window.setTimeout(() => {
      toast.style.display = 'none';
      toast.textContent = '';
      toastTimer = 0;
    }, 1600);
  }

  async function copy(text) {
    try {
      if (navigator.clipboard?.writeText) {
        await navigator.clipboard.writeText(text);
        return true;
      }
    } catch {}
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position = 'fixed';
    ta.style.left = '-9999px';
    document.body.appendChild(ta);
    ta.select();
    try { document.execCommand('copy'); } catch {}
    document.body.removeChild(ta);
    return true;
  }

  function openUrl(url) {
    window.open(url, '_blank', 'noopener,noreferrer');
  }

  async function handle(action) {
    const url = shareUrlFor(action);
    const title = document.title || 'Clickeen';
    const text = title;

    if (action === 'copy') { await copy(url); showToast('Link copied'); return; }

    if (action === 'email') {
      const mailto = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(url);
      window.location.href = mailto;
      showToast('Opening email…');
      return;
    }

    if (action === 'sms') {
      const sms = 'sms:?&body=' + encodeURIComponent(url);
      window.location.href = sms;
      showToast('Opening messages…');
      return;
    }

    if (action === 'whatsapp') { openUrl('https://wa.me/?text=' + encodeURIComponent(url)); showToast('Opening WhatsApp…'); return; }
    if (action === 'telegram') { openUrl('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(title)); showToast('Opening Telegram…'); return; }
    if (action === 'signal') { await copy(url); showToast('Link copied (paste in Signal)'); openUrl('https://signal.me/'); return; }

    if (action === 'x') { openUrl('https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(title)); showToast('Opening X…'); return; }
    if (action === 'linkedin') { openUrl('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url)); showToast('Opening LinkedIn…'); return; }
    if (action === 'facebook') { openUrl('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url)); showToast('Opening Facebook…'); return; }
    if (action === 'reddit') { openUrl('https://www.reddit.com/submit?url=' + encodeURIComponent(url) + '&title=' + encodeURIComponent(title)); showToast('Opening Reddit…'); return; }
    if (action === 'discord') { await copy(url); showToast('Link copied (paste in Discord)'); openUrl('https://discord.com/channels/@me'); return; }
    if (action === 'pinterest') { openUrl('https://pinterest.com/pin/create/button/?url=' + encodeURIComponent(url) + '&description=' + encodeURIComponent(title)); showToast('Opening Pinterest…'); return; }
    if (action === 'messenger') { await copy(url); showToast('Link copied (paste in Messenger)'); openUrl('https://www.messenger.com/'); return; }
    if (action === 'slack') { await copy(url); showToast('Link copied (paste in Slack)'); openUrl('https://slack.com/app'); return; }
    if (action === 'teams') { await copy(url); showToast('Link copied (paste in Teams)'); openUrl('https://teams.microsoft.com/'); return; }

    // Platforms without a reliable web intent: copy link + best-effort open.
    if (action === 'instagram') { await copy(url); showToast('Link copied (paste in Instagram)'); openUrl('https://www.instagram.com/'); return; }
    if (action === 'tiktok') { await copy(url); showToast('Link copied (paste in TikTok)'); openUrl('https://www.tiktok.com/'); return; }
    if (action === 'wechat') { await copy(url); showToast('Link copied (paste in WeChat)'); return; }
    if (action === 'line') { await copy(url); showToast('Link copied (paste in LINE)'); openUrl('https://line.me/'); return; }
  }

  menu.addEventListener('click', async (e) => {
    const t = e.target;
    if (!(t instanceof HTMLElement)) return;
    const btn = t.closest('[data-action]');
    if (!(btn instanceof HTMLElement)) return;
    const action = btn.getAttribute('data-action') || '';
    if (!action) return;
    e.preventDefault();
    try { await handle(action); } finally { close(); }
  });
})();
`}
</script>
