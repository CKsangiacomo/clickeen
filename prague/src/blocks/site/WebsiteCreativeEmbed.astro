---
type Props = {
  widgetType: string;
  page: string;
  blockId: string;
  locale: string;
  height?: string;
  title?: string;
};

const { widgetType, page, blockId, locale, height = '360px', title = 'Widget preview' } = Astro.props;

const VENICE_URL = import.meta.env.PUBLIC_VENICE_URL;
const creativeKey = `${widgetType}.${page}.${blockId}`;
const publicId = `wgt_web_${creativeKey}`;
const okWebsiteCreativePublicId = /^wgt_web_[a-z0-9]([a-z0-9_-]*[a-z0-9])?([.][a-z0-9]([a-z0-9_-]*[a-z0-9])?)*$/i.test(
  publicId,
);
if (!okWebsiteCreativePublicId) {
  throw new Error(
    `[Prague] Invalid website creative publicId '${publicId}' (website creatives are locale-free; locale is a runtime query param)`,
  );
}
const ts = import.meta.env.DEV ? `&ts=${Date.now()}` : '';
const iframeSrc = VENICE_URL
  ? `${VENICE_URL.replace(/\/+$/, '')}/e/${encodeURIComponent(publicId)}?theme=light&device=desktop&locale=${encodeURIComponent(locale)}${ts}`
  : null;
---

<div class="ck-websiteCreative">
  {iframeSrc ? (
    <>
      <iframe
        class="ck-websiteCreative__iframe"
        title={title}
        src={iframeSrc}
        style={`height: ${height};`}
        loading="lazy"
        referrerpolicy="no-referrer"
        sandbox="allow-scripts allow-same-origin allow-forms"
      />

      {/* Visual-only preview chrome (no border): top share bar + bottom CTA bar */}
      <div class="ck-websiteCreative__chrome" aria-hidden="true">
        <div class="ck-websiteCreative__chromeTop">
          <div class="ck-websiteCreative__share">Share</div>
        </div>
        <div class="ck-websiteCreative__chromeBottom">
          <div class="ck-websiteCreative__cta">Open</div>
        </div>
      </div>
    </>
  ) : (
    <div class="ck-media ck-websiteCreative__stub">
      Missing <code>PUBLIC_VENICE_URL</code> â€” cannot embed {publicId}
    </div>
  )}
</div>

<style>
  .ck-websiteCreative {
    width: 100%;
    position: relative;
    isolation: isolate;
    border-radius: var(--control-radius-lg);
    overflow: hidden;
    background: var(--color-system-white);
    border: 0;
  }

  .ck-websiteCreative__chrome {
    position: absolute;
    inset: 0;
    z-index: 3;
    pointer-events: none; /* never block iframe interaction */
    opacity: 0;
    transition: opacity var(--duration-base, 160ms);
  }

  .ck-websiteCreative:hover .ck-websiteCreative__chrome,
  .ck-websiteCreative:focus-within .ck-websiteCreative__chrome {
    opacity: 1;
  }

  .ck-websiteCreative__chromeTop,
  .ck-websiteCreative__chromeBottom {
    position: absolute;
    left: 0;
    right: 0;
    display: flex;
    align-items: center;
    padding-inline: var(--space-4);
  }

  .ck-websiteCreative__chromeTop {
    top: 0;
    height: 44px;
    justify-content: flex-end;
    background: linear-gradient(
      to bottom,
      color-mix(in oklab, var(--color-system-black), transparent 92%),
      transparent
    );
  }

  .ck-websiteCreative__chromeBottom {
    bottom: 0;
    height: 56px;
    justify-content: flex-end;
    background: linear-gradient(
      to top,
      color-mix(in oklab, var(--color-system-black), transparent 92%),
      transparent
    );
  }

  .ck-websiteCreative__share,
  .ck-websiteCreative__cta {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    height: 32px;
    padding-inline: 12px;
    border-radius: 999px;
    background: color-mix(in oklab, var(--color-system-white), transparent 10%);
    color: color-mix(in oklab, var(--color-system-black), transparent 22%);
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.10);
    font: 600 var(--fs-12)/1 var(--font-ui);
    letter-spacing: -0.01em;
  }

  .ck-websiteCreative__cta {
    height: 36px;
    padding-inline: 14px;
  }

  .ck-websiteCreative__iframe {
    width: 100%;
    border: 0;
    display: block;
    background: var(--color-system-white);
    position: relative;
    z-index: 1;
  }

  .ck-websiteCreative__stub {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    padding: var(--space-6);
    text-align: center;
  }
</style>
