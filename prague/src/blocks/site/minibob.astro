---
type Props = {
  widget: string;
  locale: string;
  heading: string;
  subhead: string;
};

const { widget, locale, heading, subhead } = Astro.props;

const BOB_URL =
  import.meta.env.PUBLIC_BOB_URL || (import.meta.env.DEV ? 'http://localhost:3000' : 'https://app.clickeen.com');

const iframeSrc = `${BOB_URL.replace(/\/+$/, '')}/bob?minibob=true&locale=${encodeURIComponent(locale)}`;
const compiledUrl = `${BOB_URL.replace(/\/+$/, '')}/api/widgets/${encodeURIComponent(widget)}/compiled`;
const iframeId = `ck-minibob-${widget}-${locale}`.replace(/[^a-z0-9_-]/gi, '-');
---

<section id="minibob" class="ck-canvas">
  <div class="ck-minibobStage">
    <div class="heading-3">{heading}</div>
    <div class="body-m ck-minibobStage__subhead">{subhead}</div>
  </div>

  <div class="ck-inline">
    <iframe
      id={iframeId}
      class="ck-minibob__iframe"
      title="Minibob"
      src={iframeSrc}
      loading="lazy"
      referrerpolicy="no-referrer"
      sandbox="allow-scripts allow-same-origin allow-forms"
    />
  </div>
</section>

<script
  is:inline
  define:vars={{
    iframeId,
    widget,
    compiledUrl,
  }}
>
  (function () {
    var iframe = document.getElementById(iframeId);
    if (!iframe) return;

    var hasSent = false;
    function trySend() {
      if (hasSent) return;
      if (!iframe.contentWindow) return;
      hasSent = true;

      fetch(compiledUrl)
        .then(function (r) {
          if (!r.ok) throw new Error('Failed to load compiled widget');
          return r.json();
        })
        .then(function (compiled) {
          var msg = {
            type: 'devstudio:load-instance',
            widgetname: widget,
            compiled: compiled,
            instanceData: compiled && compiled.defaults ? structuredClone(compiled.defaults) : {},
            label: compiled && compiled.displayName ? compiled.displayName : widget,
          };
          iframe.contentWindow.postMessage(msg, '*');
        })
        .catch(function (err) {
          // Fail-visible in dev: leave Minibob empty rather than silently breaking the page.
          if (typeof console !== 'undefined') console.error('[prague/minibob] bootstrap failed', err);
          hasSent = false;
        });
    }

    function onMessage(e) {
      if (!e || !e.data || typeof e.data !== 'object') return;
      if (e.data.type !== 'bob:session-ready') return;
      trySend();
    }

    window.addEventListener('message', onMessage);
    iframe.addEventListener('load', trySend);
  })();
</script>

<style>
  #minibob.ck-canvas {
    background: var(--color-system-white);
  }

  .ck-minibobStage {
    max-width: var(--prague-max);
    margin-inline: auto;
    padding-inline: var(--prague-gutter);
    margin-bottom: var(--space-6);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    text-align: center;
  }

  .ck-minibobStage__subhead {
    color: color-mix(in oklab, var(--color-system-black), transparent 50%);
    margin: 0;
  }

  .ck-minibob__iframe {
    width: 100%;
    height: clamp(520px, 70vh, 860px);
    border: 0;
    border-radius: var(--control-radius-lg);
    box-shadow: none;
    background: var(--color-system-white);
  }

  @media (max-width: 900px) {
    .ck-minibobStage { margin-bottom: var(--space-5); }
    .ck-minibob__iframe { height: 640px; }
  }
</style>
