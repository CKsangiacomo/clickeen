---
type Props = {
  widget: string;
  locale: string;
  title?: string;
  subtitle?: string;
};

const { widget, locale, title = 'Try it live', subtitle = 'Edit a demo instance in Minibob. Publish when youâ€™re ready.' } = Astro.props;

const BOB_URL =
  import.meta.env.PUBLIC_BOB_URL || (import.meta.env.DEV ? 'http://localhost:3000' : 'https://app.clickeen.com');

const iframeSrc = `${BOB_URL.replace(/\/+$/, '')}/bob?minibob=true&locale=${encodeURIComponent(locale)}`;
const compiledUrl = `${BOB_URL.replace(/\/+$/, '')}/api/widgets/${encodeURIComponent(widget)}/compiled`;
const iframeId = `ck-minibob-${widget}-${locale}`.replace(/[^a-z0-9_-]/gi, '-');
---

<section id="minibob" class="ck-canvas">
  <div class="ck-inline">
    <div class="ck-card ck-minibob">
      <div class="ck-split ck-split--center ck-minibob__inner">
        <div class="ck-split__a ck-stack" style="gap: var(--space-2);">
          <div class="heading-3">{title}</div>
          <div class="body-m" style="color: color-mix(in oklab, var(--color-system-black), transparent 50%);">
            {subtitle}
          </div>
        </div>
        <div class="ck-split__b ck-minibob__frame">
          <iframe
            id={iframeId}
            class="ck-minibob__iframe"
            title="Minibob"
            src={iframeSrc}
            loading="lazy"
            referrerpolicy="no-referrer"
            sandbox="allow-scripts allow-same-origin allow-forms"
          />
        </div>
      </div>
    </div>
  </div>
</section>

<script
  is:inline
  define:vars={{
    iframeId,
    widget,
    compiledUrl,
  }}
>
  (function () {
    var iframe = document.getElementById(iframeId);
    if (!iframe) return;

    var hasSent = false;
    function trySend() {
      if (hasSent) return;
      if (!iframe.contentWindow) return;
      hasSent = true;

      fetch(compiledUrl)
        .then(function (r) {
          if (!r.ok) throw new Error('Failed to load compiled widget');
          return r.json();
        })
        .then(function (compiled) {
          var msg = {
            type: 'devstudio:load-instance',
            widgetname: widget,
            compiled: compiled,
            instanceData: compiled && compiled.defaults ? structuredClone(compiled.defaults) : {},
            label: compiled && compiled.displayName ? compiled.displayName : widget,
          };
          iframe.contentWindow.postMessage(msg, '*');
        })
        .catch(function (err) {
          // Fail-visible in dev: leave Minibob empty rather than silently breaking the page.
          if (typeof console !== 'undefined') console.error('[prague/minibob] bootstrap failed', err);
          hasSent = false;
        });
    }

    function onMessage(e) {
      if (!e || !e.data || typeof e.data !== 'object') return;
      if (e.data.type !== 'bob:session-ready') return;
      trySend();
    }

    window.addEventListener('message', onMessage);
    iframe.addEventListener('load', trySend);
  })();
</script>

<style>
  .ck-minibob__inner {
    padding: var(--space-8);
    gap: var(--space-8);
  }

  .ck-minibob__frame {
    flex: 0 0 min(640px, 48vw);
  }

  .ck-minibob__iframe {
    width: 100%;
    height: 420px;
    border: 0;
    border-radius: var(--control-radius-4xl);
    box-shadow: var(--shadow-floating);
    background: var(--color-system-white);
  }

  @media (max-width: 900px) {
    .ck-minibob__inner { padding: var(--space-6); gap: var(--space-6); }
    .ck-minibob__frame { flex-basis: auto; }
    .ck-minibob__iframe { height: 520px; }
  }
</style>
