---
type Props = {
  widget: string;
  locale: string;
  heading: string;
  subhead: string;
};

const { widget, locale, heading, subhead } = Astro.props;

const BOB_URL = import.meta.env.PUBLIC_BOB_URL;
if (!BOB_URL) {
  throw new Error('[prague] PUBLIC_BOB_URL is required (e.g. http://localhost:3000)');
}

const DEV_WORKSPACE_ID = '00000000-0000-0000-0000-000000000001';
const widgetKey = widget.toUpperCase().replace(/[^A-Z0-9]/g, '_');
const env = import.meta.env;
const workspaceId =
  (env[`PUBLIC_MINIBOB_WORKSPACE_ID_${widgetKey}`] ?? env.PUBLIC_MINIBOB_WORKSPACE_ID ?? DEV_WORKSPACE_ID).trim();
const publicId =
  (env[`PUBLIC_MINIBOB_PUBLIC_ID_${widgetKey}`] ?? env.PUBLIC_MINIBOB_PUBLIC_ID ?? `wgt_main_${widget}`).trim();
const iframeSrc = `${BOB_URL.replace(/\/+$/, '')}/bob?subject=minibob&minibob=true&workspaceId=${encodeURIComponent(workspaceId)}&publicId=${encodeURIComponent(publicId)}&locale=${encodeURIComponent(locale)}`;
const iframeId = `ck-minibob-${widget}-${locale}`.replace(/[^a-z0-9_-]/gi, '-');
---

<section id="minibob" class="ck-canvas">
  <div class="ck-minibobStage">
    <div class="heading-3">{heading}</div>
    <div class="body-xxl ck-minibobStage__subhead ck-text-muted">{subhead}</div>
  </div>

  <div class="ck-inline">
    <iframe
      id={iframeId}
      class="ck-minibob__iframe"
      title="Minibob"
      src={iframeSrc}
      loading="lazy"
      referrerpolicy="no-referrer"
      sandbox="allow-scripts allow-same-origin allow-forms"
    />
  </div>
</section>

<style>
  #minibob.ck-canvas {
    background: var(--color-system-white);
  }

  .ck-minibobStage {
    max-width: var(--prague-max);
    margin-inline: auto;
    padding-inline: var(--prague-gutter);
    margin-bottom: var(--space-6);
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
    text-align: center;
  }

  .ck-minibobStage__subhead {
    margin: 0;
  }

  .ck-minibob__iframe {
    width: 100%;
    height: clamp(520px, 70vh, 860px);
    border: 0;
    border-radius: var(--control-radius-lg);
    box-shadow: none;
    background: var(--color-system-white);
  }

  @media (max-width: 900px) {
    .ck-minibobStage { margin-bottom: var(--space-5); }
    .ck-minibob__iframe { height: 640px; }
  }
</style>
