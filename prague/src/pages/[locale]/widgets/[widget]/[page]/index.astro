---
import Base from '../../../../../layouts/Base.astro';
import Nav from '../../../../../blocks/site/nav/Nav.astro';
import Footer from '../../../../../blocks/site/footer.astro';
import WidgetBlocks from '../../../../../components/WidgetBlocks.astro';
import { listWidgets, listWidgetPages, loadRequiredWidgetPageJsonForLocale } from '../../../../../lib/markdown';
import { listPragueLocales } from '../../../../../lib/locales';
import { pragueT } from '../../../../../lib/i18n';
import { getPragueOverlayContext } from '../../../../../lib/requestContext';

const { locale, widget, page } = Astro.params;
export const prerender = false;

type WidgetSubpage = 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
const activeSubpage: WidgetSubpage =
  page === 'overview' || page === 'templates' || page === 'examples' || page === 'features' || page === 'pricing'
    ? (page as WidgetSubpage)
    : 'overview';

export async function getStaticPaths() {
  const widgets = await listWidgets();
  const locales = listPragueLocales();
  const out: { params: { locale: string; widget: string; page: string } }[] = [];

  for (const w of widgets) {
    const pages = await listWidgetPages(w);
    // Hard contract: every marketed widget must have all 4 page JSONs.
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'overview', locale: 'en' });
    for (const p of pages) {
      await loadRequiredWidgetPageJsonForLocale({ widget: w, page: p, locale: 'en' });
    }
    for (const l of locales) {
      for (const p of pages) out.push({ params: { locale: l, widget: w, page: p } });
    }
  }

  return out;
}

// Ensure the page contract exists (fail-fast) even though some blocks are still stubs.
const overlayContext = getPragueOverlayContext(Astro.request);
const pageJson = await loadRequiredWidgetPageJsonForLocale({ widget, page, locale, ...overlayContext });
const blocks = Array.isArray((pageJson as any).blocks) ? (pageJson as any).blocks : [];
const hasHero = blocks.some((b: any) => b && b.type === 'hero');
const pageMetaBlock = blocks.find((b: any) => b && b.type === 'page-meta');
const pageMeta = pageMetaBlock && typeof pageMetaBlock === 'object' ? (pageMetaBlock as any).copy : null;
const pageTitle = pageMeta && typeof pageMeta === 'object' ? String((pageMeta as any).title ?? '') : '';
const pageDescription = pageMeta && typeof pageMeta === 'object' ? String((pageMeta as any).description ?? '') : '';
if (!pageTitle || !pageDescription) {
  throw new Error(`[prague] Invalid tokyo/widgets/${widget}/pages/${page}.json (page-meta.copy.title/description required)`);
}
const createFreeLabel = await pragueT(locale, 'prague.cta.createFree');
---

<Base title={pageTitle} description={pageDescription} locale={locale}>
  <main>
    <Nav
      title="Clickeen"
      locale={locale}
      homeHref={`/${locale}/`}
      overlay={hasHero}
      cta={{ label: createFreeLabel, href: `/${locale}/create`, variant: 'primary' }}
    />

    <WidgetBlocks blocks={blocks} widget={widget} locale={locale} activeSubpage={activeSubpage} />

    <Footer locale={locale} />
  </main>
</Base>
