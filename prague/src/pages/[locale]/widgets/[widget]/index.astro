---
import Base from '../../../../layouts/Base.astro';
import Nav from '../../../../blocks/site/nav/Nav.astro';
import Footer from '../../../../blocks/site/footer.astro';
import WidgetBlocks from '../../../../components/WidgetBlocks.astro';
import { listWidgets, loadRequiredWidgetPageJsonForLocale } from '../../../../lib/markdown';
import { listPragueLocales } from '../../../../lib/locales';
import { pragueT } from '../../../../lib/i18n';
import { getPragueOverlayContext } from '../../../../lib/requestContext';

const { locale, widget } = Astro.params;
export const prerender = false;

export async function getStaticPaths() {
  const widgets = await listWidgets();
  const locales = listPragueLocales();
  // Hard contract: every widget must ship 4 page JSONs (overview/templates/examples/features).
  for (const w of widgets) {
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'overview', locale: 'en' });
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'templates', locale: 'en' });
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'examples', locale: 'en' });
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'features', locale: 'en' });
    await loadRequiredWidgetPageJsonForLocale({ widget: w, page: 'pricing', locale: 'en' });
  }
  return locales.flatMap((l) => widgets.map((w) => ({ params: { locale: l, widget: w } })));
}

const overlayContext = getPragueOverlayContext(Astro.request);
const overviewJson = await loadRequiredWidgetPageJsonForLocale({ widget, page: 'overview', locale, ...overlayContext });
const blocks = Array.isArray((overviewJson as any).blocks) ? (overviewJson as any).blocks : [];
const hasHero = blocks.some((b: any) => b && b.type === 'hero');
const pageMetaBlock = blocks.find((b: any) => b && b.type === 'page-meta');
const pageMeta = pageMetaBlock && typeof pageMetaBlock === 'object' ? (pageMetaBlock as any).copy : null;
const pageTitle = pageMeta && typeof pageMeta === 'object' ? String((pageMeta as any).title ?? '') : '';
const pageDescription = pageMeta && typeof pageMeta === 'object' ? String((pageMeta as any).description ?? '') : '';
if (!pageTitle || !pageDescription) {
  throw new Error(`[prague] Invalid tokyo/widgets/${widget}/pages/overview.json (page-meta.copy.title/description required)`);
}
const createFreeLabel = await pragueT(locale, 'prague.cta.createFree');
---

<Base title={pageTitle} description={pageDescription} locale={locale}>
  <main>
    <Nav
      title="Clickeen"
      locale={locale}
      homeHref={`/${locale}/`}
      overlay={hasHero}
      cta={{ label: createFreeLabel, href: `/${locale}/create`, variant: 'primary' }}
    />

    <WidgetBlocks blocks={blocks} widget={widget} locale={locale} activeSubpage="overview" />

    <Footer locale={locale} />
  </main>
</Base>
