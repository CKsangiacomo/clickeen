---
import Base from '../../../../layouts/Base.astro';
import Nav from '../../../../blocks/site/nav/Nav.astro';
import Footer from '../../../../blocks/site/footer.astro';
import Minibob from '../../../../blocks/site/minibob.astro';
import Hero from '../../../../blocks/widget-landing/hero.astro';
import Stats from '../../../../blocks/widget-landing/stats.astro';
import Steps from '../../../../blocks/widget-landing/steps.astro';
import Features from '../../../../blocks/widget-landing/features.astro';
import MetaFaq from '../../../../blocks/widget-landing/meta-faq.astro';
import Cta from '../../../../blocks/widget-landing/cta.astro';
import { listWidgets, loadWidgetPageJsonForLocale, loadWidgetPageMarkdown, parseMarkdownSections, parsePipeBullets } from '../../../../lib/markdown';
import { listPragueLocales } from '../../../../lib/locales';
import { resolvePragueHref } from '../../../../lib/links';
import { pragueT } from '../../../../lib/i18n';

const { locale, widget } = Astro.params;

export async function getStaticPaths() {
  const widgets = await listWidgets();
  const locales = listPragueLocales();
  return locales.flatMap((l) => widgets.map((w) => ({ params: { locale: l, widget: w } })));
}

const md = await loadWidgetPageMarkdown({ widget, page: 'landing' });
const overviewJson = await loadWidgetPageJsonForLocale({ widget, page: 'overview', locale });
const heroCopyFromJson =
  Boolean(overviewJson)
  && typeof overviewJson === 'object'
  && Array.isArray((overviewJson as any).blocks)
  ? (overviewJson as any).blocks.find((b: any) => b && b.id === 'hero' && b.kind === 'hero')?.copy
  : null;
const heroHeadlineFromJson = heroCopyFromJson && typeof heroCopyFromJson === 'object' ? (heroCopyFromJson as any).headline : null;
const heroSubheadlineFromJson = heroCopyFromJson && typeof heroCopyFromJson === 'object' ? (heroCopyFromJson as any).subheadline : null;
const heroWantsCreative =
  Boolean(overviewJson)
  && typeof overviewJson === 'object'
  && Array.isArray((overviewJson as any).blocks)
  && (overviewJson as any).blocks.some((b: any) => b && b.id === 'hero' && b.visual === true);

const sections = parseMarkdownSections(md);
const headline = (heroHeadlineFromJson && String(heroHeadlineFromJson)) || sections.get('headline');
const subheadline = (heroSubheadlineFromJson && String(heroSubheadlineFromJson)) || sections.get('subheadline');
if (!headline || !subheadline) {
  throw new Error(`[Prague] Missing required sections in tokyo/widgets/${widget}/pages/landing.md (Headline/Subheadline)`);
}

// Global CTA policy (applies across all widget pages):
// - "Create free" scrolls to MiniBob on the current page.
// - "See templates" navigates to the widget templates page (locale-prefixed).
const heroPrimaryCta = { label: pragueT(locale, 'prague.cta.createFree'), href: '#minibob' };
const heroSecondaryCta = {
  label: pragueT(locale, 'prague.cta.seeTemplates'),
  href: resolvePragueHref({ href: '/widgets/{widget}/templates', locale, widget }),
};

const statsRaw = sections.get('stats');
const stepsRaw = sections.get('steps');
const featuresRaw = sections.get('features');
const metaFaqRaw = sections.get('meta faq');
if (!statsRaw || !stepsRaw || !featuresRaw || !metaFaqRaw) {
  throw new Error(
    `[Prague] Missing required sections in tokyo/widgets/${widget}/pages/landing.md (Stats/Steps/Features/Meta FAQ)`,
  );
}

const stats = parsePipeBullets(statsRaw).map(([value, label]) => ({ value, label }));
const steps = parsePipeBullets(stepsRaw).map(([title, body]) => ({ title, body }));
const features = parsePipeBullets(featuresRaw).map(([title, body]) => ({ title, body }));
const metaFaq = parsePipeBullets(metaFaqRaw).map(([question, answer]) => ({ question, answer }));

const ctaRaw = sections.get('cta');
if (!ctaRaw) {
  throw new Error(`[Prague] Missing '## CTA' in tokyo/widgets/${widget}/pages/landing.md`);
}
const ctaLines = ctaRaw.split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
if (ctaLines.length < 2) {
  throw new Error(`[Prague] Missing '## CTA' (2 lines) in tokyo/widgets/${widget}/pages/landing.md`);
}
const ctaHeadline = ctaLines[0];
const ctaSubheadline = ctaLines[1];

const minibobLines = (sections.get('minibob') ?? '').split(/\r?\n/).map((l) => l.trim()).filter(Boolean);
if (minibobLines.length < 2) {
  throw new Error(`[Prague] Missing '## Minibob' (2 lines) in tokyo/widgets/${widget}/pages/landing.md`);
}
const minibobHeading = minibobLines[0];
const minibobSubhead = minibobLines[1];
---

<Base title={`${headline} â€” Clickeen`} locale={locale}>
  <main>
    <Nav
      title="Clickeen"
      locale={locale}
      homeHref={`/${locale}/`}
      cta={{ label: pragueT(locale, 'prague.cta.createFree'), href: `/${locale}/create`, variant: 'primary' }}
    />
    <Hero
      headline={headline}
      subheadline={subheadline}
      primaryCta={heroPrimaryCta}
      secondaryCta={heroSecondaryCta}
      websiteCreative={
        heroWantsCreative
          ? { widgetType: widget, locale, height: '640px', title: `${widget} overview hero` }
          : undefined
      }
    />
    <Minibob widget={widget} locale={locale} heading={minibobHeading} subhead={minibobSubhead} />
    {stats.length ? <Stats stats={stats} /> : null}
    {steps.length ? <Steps steps={steps} /> : null}
    {features.length ? <Features items={features} /> : null}
    {metaFaq.length ? <MetaFaq items={metaFaq} /> : null}
    <Cta
      headline={ctaHeadline}
      subheadline={ctaSubheadline}
      primaryLabel={pragueT(locale, 'prague.cta.createFree')}
      primaryHref={`/${locale}/create`}
    />
    <Footer locale={locale} />
  </main>
</Base>
