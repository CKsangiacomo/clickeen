---
import Base from '../../layouts/Base.astro';
import Nav from '../../blocks/site/nav/Nav.astro';
import Footer from '../../blocks/site/footer.astro';
import { listWidgets, loadRequiredWidgetPageJsonForLocale } from '../../lib/markdown';
import { listPragueLocales } from '../../lib/locales';

const { locale } = Astro.params;

export function getStaticPaths() {
  return listPragueLocales().map((locale) => ({ params: { locale } }));
}

const widgets = await listWidgets();
if (!widgets.length) {
  throw new Error('[prague] No widgets found in tokyo/widgets (expected at least one)');
}

const widgetCards = await Promise.all(
  widgets.map(async (widget) => {
    const overview = await loadRequiredWidgetPageJsonForLocale({ widget, page: 'overview', locale });
    const blocks = Array.isArray((overview as any)?.blocks) ? (overview as any).blocks : null;
    const hero = blocks ? blocks.find((b: any) => b && b.id === 'hero' && b.type === 'hero') : null;
    const copy = hero && typeof hero === 'object' ? (hero as any).copy : null;
    const headline = copy && typeof copy === 'object' ? String((copy as any).headline ?? '') : '';
    const subheadline = copy && typeof copy === 'object' ? String((copy as any).subheadline ?? '') : '';
    if (!headline || !subheadline) {
      throw new Error(`[prague] Invalid tokyo/widgets/${widget}/pages/overview.json (hero.copy.headline/subheadline required)`);
    }
    return { widget, headline, subheadline };
  }),
);
const widgetCardsSafe = widgetCards.filter(Boolean) as NonNullable<(typeof widgetCards)[number]>[];
---

<Base title="Clickeen" locale={locale}>
  <main>
    <Nav
      title="Clickeen"
      locale={locale}
      homeHref={`/${locale}/`}
      cta={{ label: 'Create free', href: `/${locale}/create`, variant: 'primary' }}
    />

    <section class="ck-canvas" style="padding-top: 0;">
      <div class="ck-inline ck-stack" style="gap: var(--space-8);">
        <div class="ck-stack" style="gap: var(--space-2);">
          <h1 class="heading-1" style="margin: 0; letter-spacing: -0.02em;">Widgets</h1>
          <p class="body-xxl" style="margin: 0; color: color-mix(in oklab, var(--color-system-black), transparent 56%);">
            Pick a widget to explore templates, pricing, and try it live.
          </p>
        </div>

        <div class="ck-stack" style="gap: var(--space-4);">
          {widgetCardsSafe.map((w) => (
            <a
              class="ck-card"
              href={`/${locale}/widgets/${w.widget}`}
              style="display: block; padding: var(--space-6); text-decoration: none; color: inherit;"
            >
              <div class="ck-stack" style="gap: var(--space-2);">
                <div class="label-m" style="text-transform: uppercase; letter-spacing: 0.08em; opacity: 0.65;">
                  {w.widget}
                </div>
                <div class="heading-3" style="margin: 0;">{w.headline}</div>
                <div class="body-xxl" style="margin: 0; color: color-mix(in oklab, var(--color-system-black), transparent 45%);">
                  {w.subheadline}
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </section>

    <Footer locale={locale} />
  </main>
</Base>
