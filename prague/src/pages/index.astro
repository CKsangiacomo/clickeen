---
export const prerender = false;

import { getPragueMarket, isValidLocaleForMarket, PRAGUE_MARKETS, resolveMarketFromCountry } from '../lib/markets';

type ParsedCookies = Record<string, string>;

function buildSetCookie(args: { name: string; value: string; secure: boolean }): string {
  const parts = [
    `${args.name}=${encodeURIComponent(args.value)}`,
    'Path=/',
    'Max-Age=31536000',
    'SameSite=Lax',
  ];
  if (args.secure) parts.push('Secure');
  return parts.join('; ');
}

function buildClearCookie(args: { name: string; secure: boolean }): string {
  const parts = [`${args.name}=`, 'Path=/', 'Max-Age=0', 'SameSite=Lax'];
  if (args.secure) parts.push('Secure');
  return parts.join('; ');
}

function parseCookies(header: string | null): ParsedCookies {
  if (!header) return {};
  return header.split(';').reduce<ParsedCookies>((acc, part) => {
    const [rawKey, ...rest] = part.split('=');
    const key = String(rawKey || '').trim();
    if (!key) return acc;
    const value = rest.join('=').trim();
    try {
      acc[key] = decodeURIComponent(value);
    } catch {
      acc[key] = value;
    }
    return acc;
  }, {});
}

const cookies = parseCookies(Astro.request.headers.get('cookie'));

const protocol = Astro.url.protocol;
const secureCookie = protocol === 'https:';

const reset = Astro.url.searchParams.get('reset');
if (reset === '1' || reset === 'true') {
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: 'ck_market', secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: 'ck_locale', secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'reset');
  const nextUrl = new URL(Astro.url.toString());
  nextUrl.searchParams.delete('reset');
  return Astro.redirect(`${nextUrl.pathname}${nextUrl.search}`, 302);
}

const queryMarket = String(Astro.url.searchParams.get('market') || Astro.url.searchParams.get('ck_market') || '')
  .trim()
  .toLowerCase();
const queryLocale = String(Astro.url.searchParams.get('locale') || Astro.url.searchParams.get('ck_locale') || '')
  .trim()
  .toLowerCase();
const queryMarketConfig = queryMarket ? getPragueMarket(queryMarket) : null;
if (queryMarketConfig) {
  const nextLocale =
    queryLocale && isValidLocaleForMarket({ market: queryMarketConfig.key, locale: queryLocale })
      ? queryLocale
      : queryMarketConfig.defaultLocale;

  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_market', value: queryMarketConfig.key, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_locale', value: nextLocale, secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'query');
  Astro.response.headers.set('X-Prague-Market', queryMarketConfig.key);
  Astro.response.headers.set('X-Prague-Locale', nextLocale);
  return Astro.redirect(`/${queryMarketConfig.key}/${nextLocale}/${Astro.url.search}`, 302);
}

const cookieMarket = String(cookies.ck_market || '').trim().toLowerCase();
const cookieLocale = String(cookies.ck_locale || '').trim().toLowerCase();

const cookieMarketConfig = cookieMarket ? getPragueMarket(cookieMarket) : null;
if (cookieMarketConfig) {
  Astro.response.headers.set('X-Prague-Market-Source', 'cookie');
  Astro.response.headers.set('X-Prague-Market', cookieMarketConfig.key);
  return Astro.redirect(
    `/${cookieMarketConfig.key}/${
      cookieLocale && isValidLocaleForMarket({ market: cookieMarketConfig.key, locale: cookieLocale })
        ? cookieLocale
        : cookieMarketConfig.defaultLocale
    }/${Astro.url.search}`,
    302,
  );
}

const country = Astro.request.headers.get('cf-ipcountry');
const geoMarket = resolveMarketFromCountry(country);
if (geoMarket) {
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_market', value: geoMarket.key, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_locale', value: geoMarket.defaultLocale, secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'geo');
  Astro.response.headers.set('X-Prague-Market', geoMarket.key);
  Astro.response.headers.set('X-Prague-Locale', geoMarket.defaultLocale);
  return Astro.redirect(`/${geoMarket.key}/${geoMarket.defaultLocale}/${Astro.url.search}`, 302);
}

const defaultMarket = getPragueMarket('us') ?? PRAGUE_MARKETS.markets[0] ?? null;
if (!defaultMarket) {
  throw new Error('[prague] No markets configured (expected at least one entry in config/markets.json)');
}
Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_market', value: defaultMarket.key, secure: secureCookie }));
Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: 'ck_locale', value: defaultMarket.defaultLocale, secure: secureCookie }));
Astro.response.headers.set('X-Prague-Market-Source', 'default');
Astro.response.headers.set('X-Prague-Market', defaultMarket.key);
Astro.response.headers.set('X-Prague-Locale', defaultMarket.defaultLocale);
return Astro.redirect(`/${defaultMarket.key}/${defaultMarket.defaultLocale}/${Astro.url.search}`, 302);
---
