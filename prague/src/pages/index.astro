---
export const prerender = false;

import { getPragueMarket, isValidLocaleForMarket, PRAGUE_MARKETS, resolveMarketFromCountry } from '../lib/markets';

type ParsedCookies = Record<string, string>;

const COOKIE_MARKET = 'ck_market';
const COOKIE_LOCALE = 'ck_locale';
const COOKIE_PREF_LOCK = 'ck_market_pref';

function buildSetCookie(args: { name: string; value: string; secure: boolean }): string {
  const parts = [
    `${args.name}=${encodeURIComponent(args.value)}`,
    'Path=/',
    'Max-Age=31536000',
    'SameSite=Lax',
  ];
  if (args.secure) parts.push('Secure');
  return parts.join('; ');
}

function buildClearCookie(args: { name: string; secure: boolean }): string {
  const parts = [`${args.name}=`, 'Path=/', 'Max-Age=0', 'SameSite=Lax'];
  if (args.secure) parts.push('Secure');
  return parts.join('; ');
}

function parseCookies(header: string | null): ParsedCookies {
  if (!header) return {};
  return header.split(';').reduce<ParsedCookies>((acc, part) => {
    const [rawKey, ...rest] = part.split('=');
    const key = String(rawKey || '').trim();
    if (!key) return acc;
    const value = rest.join('=').trim();
    try {
      acc[key] = decodeURIComponent(value);
    } catch {
      acc[key] = value;
    }
    return acc;
  }, {});
}

const cookies = parseCookies(Astro.request.headers.get('cookie'));

const protocol = Astro.url.protocol;
const secureCookie = protocol === 'https:';

const reset = Astro.url.searchParams.get('reset');
if (reset === '1' || reset === 'true') {
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_MARKET, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_LOCALE, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_PREF_LOCK, secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'reset');
  const nextUrl = new URL(Astro.url.toString());
  nextUrl.searchParams.delete('reset');
  return Astro.redirect(`${nextUrl.pathname}${nextUrl.search}`, 302);
}

const queryMarket = String(Astro.url.searchParams.get('market') || Astro.url.searchParams.get('ck_market') || '')
  .trim()
  .toLowerCase();
const queryLocale = String(Astro.url.searchParams.get('locale') || Astro.url.searchParams.get('ck_locale') || '')
  .trim()
  .toLowerCase();
const queryMarketConfig = queryMarket ? getPragueMarket(queryMarket) : null;
if (queryMarketConfig) {
  const nextLocale =
    queryLocale && isValidLocaleForMarket({ market: queryMarketConfig.key, locale: queryLocale })
      ? queryLocale
      : queryMarketConfig.defaultLocale;

  // Explicit user override: persist as a preference.
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: COOKIE_MARKET, value: queryMarketConfig.key, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: COOKIE_LOCALE, value: nextLocale, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildSetCookie({ name: COOKIE_PREF_LOCK, value: '1', secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'query');
  Astro.response.headers.set('X-Prague-Market', queryMarketConfig.key);
  Astro.response.headers.set('X-Prague-Locale', nextLocale);
  return Astro.redirect(`/${queryMarketConfig.key}/${nextLocale}/${Astro.url.search}`, 302);
}

const cookieMarket = String(cookies[COOKIE_MARKET] || '').trim().toLowerCase();
const cookieLocale = String(cookies[COOKIE_LOCALE] || '').trim().toLowerCase();
const cookiePrefLocked = String(cookies[COOKIE_PREF_LOCK] || '').trim() === '1';

const cookieMarketConfig = cookieMarket ? getPragueMarket(cookieMarket) : null;
if (cookiePrefLocked && cookieMarketConfig) {
  Astro.response.headers.set('X-Prague-Market-Source', 'cookie_pref');
  Astro.response.headers.set('X-Prague-Market', cookieMarketConfig.key);
  return Astro.redirect(
    `/${cookieMarketConfig.key}/${
      cookieLocale && isValidLocaleForMarket({ market: cookieMarketConfig.key, locale: cookieLocale })
        ? cookieLocale
        : cookieMarketConfig.defaultLocale
    }/${Astro.url.search}`,
    302,
  );
}

// Legacy behavior set cookies for geo/default redirects, which made markets "sticky" without an explicit user choice.
// If we find such cookies without the preference lock, clear them so geo/default can behave correctly.
if (!cookiePrefLocked && (cookieMarket || cookieLocale)) {
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_MARKET, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_LOCALE, secure: secureCookie }));
  Astro.response.headers.append('Set-Cookie', buildClearCookie({ name: COOKIE_PREF_LOCK, secure: secureCookie }));
  Astro.response.headers.set('X-Prague-Market-Source', 'legacy_cookie_cleared');
}

const country = Astro.request.headers.get('cf-ipcountry');
const geoMarket = resolveMarketFromCountry(country);
if (geoMarket) {
  Astro.response.headers.set('X-Prague-Market-Source', 'geo');
  Astro.response.headers.set('X-Prague-Market', geoMarket.key);
  Astro.response.headers.set('X-Prague-Locale', geoMarket.defaultLocale);
  return Astro.redirect(`/${geoMarket.key}/${geoMarket.defaultLocale}/${Astro.url.search}`, 302);
}

const defaultMarket = getPragueMarket('us') ?? PRAGUE_MARKETS.markets[0] ?? null;
if (!defaultMarket) {
  throw new Error('[prague] No markets configured (expected at least one entry in config/markets.json)');
}
Astro.response.headers.set('X-Prague-Market-Source', 'default');
Astro.response.headers.set('X-Prague-Market', defaultMarket.key);
Astro.response.headers.set('X-Prague-Locale', defaultMarket.defaultLocale);
return Astro.redirect(`/${defaultMarket.key}/${defaultMarket.defaultLocale}/${Astro.url.search}`, 302);
---
