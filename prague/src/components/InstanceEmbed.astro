---
import Icon from './Icon.astro';

type Props = {
  publicId: string;
  locale: string;
  localeOverride?: string;
  title?: string;
  loading?: 'lazy' | 'eager';
  embedMode?: 'iframe' | 'indexable';
  showShareChrome?: boolean;
};

const { publicId, locale, localeOverride, title = 'Widget preview', loading = 'lazy', embedMode = 'iframe' } =
  Astro.props;

const showShareChrome = (Astro.props as Props).showShareChrome !== false;
const PRAGUE_EMBED_MIN_HEIGHT = 420;
const PRAGUE_EMBED_MAX_HEIGHT = 800;

const VENICE_URL = import.meta.env.PUBLIC_VENICE_URL;

// Extract widget type from any valid publicId format
const widgetType = (() => {
  const raw = String(publicId || '').trim();

  if (raw.startsWith('wgt_main_')) {
    return raw.slice('wgt_main_'.length);
  }

  // Handle curated instances: wgt_curated_widgetname
  if (raw.startsWith('wgt_curated_')) {
    const rest = raw.slice('wgt_curated_'.length);
    const dot = rest.indexOf('.');
    return dot === -1 ? rest : rest.slice(0, dot);
  }

  // Handle user instances: wgt_user_widgetname_xyz or other patterns
  // Extract widget type from common patterns
  const patterns = [
    /^wgt_user_([^_]+)_/,     // wgt_user_faq_123 -> faq
    /^wgt_([^_]+)_u_/,        // wgt_faq_u_123 -> faq
    /^wgt_([^_]+)_/,          // wgt_faq_123 -> faq
  ];

  for (const pattern of patterns) {
    const match = raw.match(pattern);
    if (match && match[1]) {
      return match[1];
    }
  }

  // Fallback: Venice handles widget type internally
  return '';
})();

// Local-dev cache-bust only: production embeds should be CDN/snapshot cache-friendly by default.
const tsToken = import.meta.env.DEV ? String(Date.now()) : '';
const ts = tsToken ? `&ts=${encodeURIComponent(tsToken)}` : '';
const resolvedLocale = String(localeOverride || locale || 'en').trim();
const loaderSrc = VENICE_URL ? `${VENICE_URL.replace(/\/+$/, '')}/embed/latest/loader.js` : null;
const iframeSrc = VENICE_URL
  ? `${VENICE_URL.replace(/\/+$/, '')}/e/${encodeURIComponent(publicId)}?theme=light&device=desktop&locale=${encodeURIComponent(resolvedLocale)}${ts}`
  : null;

const anchorId = `ck-instance-${publicId.replace(/[^a-z0-9_-]+/gi, '-')}`;

// Brand icons we already ship in Tokyo, inlined here to keep this component self-contained.
// Source: tokyo/Assets/Global/share-icons/*.svg (normalized in CSS to currentColor).
const brandSvgs = {
  signal: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_25)"><path d="M12 4.85391e-06C11.3773 4.85391e-06 10.7673 0.0463382 10.17 0.139005L10.34 1.25C11.4403 1.08204 12.5597 1.08204 13.66 1.25L13.832 0.139005C13.2258 0.0459227 12.6133 -0.000546789 12 4.85391e-06ZM9.15201 0.340005C7.95961 0.631606 6.819 1.10444 5.77001 1.742L6.35401 2.703C7.30448 2.12424 8.33869 1.69585 9.42001 1.433L9.15201 0.340005ZM14.848 0.340005L14.58 1.434C15.6613 1.69685 16.6955 2.12524 17.646 2.704L18.23 1.742C17.181 1.10444 16.0404 0.631606 14.848 0.340005ZM12 2.25C10.3046 2.24973 8.63833 2.69158 7.16579 3.53195C5.69326 4.37231 4.46531 5.58214 3.60316 7.04203C2.741 8.50191 2.27443 10.1614 2.2495 11.8567C2.22458 13.5519 2.64215 15.2244 3.46101 16.709C3.53501 16.843 3.56101 17.001 3.52501 17.15L2.51201 21.488L6.85001 20.475C6.99986 20.4409 7.15702 20.4638 7.29101 20.539C8.73241 21.3359 10.353 21.7527 12 21.75C17.385 21.75 21.75 17.385 21.75 12C21.75 6.615 17.385 2.25 12 2.25ZM4.90801 2.318C3.91723 3.04372 3.04372 3.91722 2.31801 4.908L3.22701 5.572C3.88568 4.67632 4.67633 3.88567 5.57201 3.227L4.90801 2.318ZM19.092 2.318L18.428 3.227C19.3237 3.88567 20.1143 4.67632 20.773 5.572L21.682 4.908C20.9563 3.91722 20.0828 3.04372 19.092 2.318ZM1.74201 5.77C1.10445 6.81899 0.631614 7.9596 0.340012 9.15201L1.43401 9.42C1.69655 8.33874 2.1246 7.30453 2.70301 6.354L1.74201 5.77ZM22.258 5.77L21.297 6.354C21.8758 7.30447 22.3042 8.33868 22.567 9.42L23.66 9.15201C23.3685 7.95925 22.8957 6.8193 22.258 5.77ZM0.138012 10.168C0.045265 10.7742 -0.000870129 11.3867 1.24249e-05 12C1.24249e-05 12.6227 0.0463458 13.2327 0.139012 13.83L1.25001 13.66C1.16648 13.1106 1.12469 12.5557 1.12501 12C1.12501 11.4347 1.16668 10.8813 1.25001 10.34L0.138012 10.168ZM23.861 10.17L22.75 10.34C22.8333 10.8813 22.875 11.4347 22.875 12C22.875 12.848 22.833 13.12 22.75 13.66L23.861 13.832C24.0468 12.6184 24.0468 11.3836 23.861 10.17ZM1.43401 14.58L0.340012 14.848C0.559179 15.7458 0.881314 16.6152 1.30001 17.439L1.03501 18.579L2.13101 18.834L2.49101 17.295L2.30301 16.93C1.92281 16.1831 1.63085 15.3944 1.43301 14.58M22.566 14.58C22.3033 15.6617 21.8749 16.6962 21.296 17.647L22.258 18.231C22.8957 17.1817 23.3685 16.0408 23.66 14.848L22.566 14.58ZM20.773 18.428C20.1143 19.3237 19.3237 20.1143 18.428 20.773L19.092 21.682C20.0828 20.9563 20.9563 20.0828 21.682 19.092L20.773 18.428ZM0.814012 19.528L0.357012 21.48C0.287659 21.778 0.295396 22.0887 0.379494 22.3829C0.463592 22.677 0.621275 22.9449 0.837653 23.1611C1.05403 23.3774 1.32197 23.535 1.61615 23.6189C1.91034 23.7029 2.22107 23.7105 2.51901 23.641L4.47301 23.186L4.21701 22.091L2.26401 22.546C2.15237 22.5719 2.03599 22.5689 1.92581 22.5374C1.81564 22.5058 1.71531 22.4468 1.63428 22.3657C1.55324 22.2847 1.49418 22.1844 1.46264 22.0742C1.4311 21.964 1.42813 21.8476 1.45401 21.736L1.90801 19.782L0.814012 19.528ZM17.646 21.297C16.6955 21.8758 15.6613 22.3042 14.58 22.567L14.848 23.66C16.0404 23.3684 17.181 22.8956 18.23 22.258L17.646 21.297ZM6.70601 21.51L5.16601 21.87L5.42201 22.965L6.56101 22.699C7.37501 23.114 8.24401 23.439 9.15201 23.66L9.42001 22.566C8.60562 22.3685 7.81698 22.0769 7.07001 21.697L6.70601 21.51ZM10.34 22.75L10.168 23.861C11.3816 24.0468 12.6164 24.0468 13.83 23.861L13.66 22.75C13.1187 22.8333 12.5653 22.875 12 22.875C11.4443 22.8753 10.8894 22.8335 10.34 22.75Z" fill="black"/></g><defs><clipPath id="clip0_2549_25"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  messenger: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_17)"><path d="M12 0C5.24 0 0 4.952 0 11.64C0 15.139 1.434 18.161 3.769 20.25C3.86624 20.3361 3.945 20.441 4.00051 20.5584C4.05603 20.6758 4.08716 20.8032 4.092 20.933L4.157 23.068C4.16165 23.2253 4.20487 23.3789 4.28286 23.5156C4.36085 23.6522 4.47122 23.7676 4.60427 23.8515C4.73731 23.9355 4.88895 23.9854 5.04584 23.997C5.20273 24.0086 5.36006 23.9815 5.504 23.918L7.885 22.865C8.08704 22.7765 8.31339 22.7602 8.526 22.819C9.65789 23.1288 10.8265 23.2838 12 23.28C18.76 23.28 24 18.328 24 11.64C24 4.952 18.76 0 12 0ZM18.806 7.44C19.328 7.41 19.777 8.007 19.436 8.534L15.258 14.991C15.1559 15.148 14.9957 15.2581 14.8125 15.2971C14.6294 15.3361 14.4382 15.3008 14.281 15.199L10.411 12.695C10.3378 12.6474 10.2522 12.6227 10.1649 12.624C10.0777 12.6252 9.99278 12.6524 9.921 12.702L5.558 15.712C4.921 16.15 4.143 15.395 4.563 14.746L8.742 8.289C8.79231 8.211 8.8575 8.14368 8.93385 8.0909C9.0102 8.03812 9.09621 8.00091 9.18695 7.9814C9.2777 7.9619 9.3714 7.96048 9.46269 7.97723C9.55399 7.99397 9.64109 8.02856 9.719 8.079L13.589 10.584C13.739 10.681 13.933 10.678 14.08 10.577L18.442 7.569C18.5487 7.49236 18.6749 7.44831 18.806 7.44Z" fill="black"/></g><defs><clipPath id="clip0_2549_17"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  wechat: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M8.691 2.18799C3.891 2.18799 0 5.47599 0 9.52999C0 11.742 1.17 13.733 3.002 15.08C3.10366 15.1537 3.17913 15.258 3.21744 15.3776C3.25575 15.4972 3.2549 15.6259 3.215 15.745L2.825 17.225C2.806 17.295 2.777 17.366 2.777 17.438C2.777 17.601 2.907 17.733 3.067 17.733C3.12656 17.7306 3.18432 17.7119 3.234 17.679L5.137 16.565C5.24232 16.4978 5.36096 16.4542 5.48475 16.4373C5.60853 16.4204 5.73451 16.4305 5.854 16.467C6.77588 16.7347 7.73104 16.8704 8.691 16.87C8.967 16.87 9.234 16.843 9.502 16.82C8.645 14.242 9.659 11.848 11.434 10.374C13.137 8.95899 15.316 8.39399 17.287 8.53599C16.711 4.95299 13.091 2.18799 8.691 2.18799ZM5.785 5.99099C6.427 5.99099 6.947 6.51999 6.947 7.17099C6.94805 7.32464 6.91883 7.47699 6.86101 7.61934C6.80318 7.7617 6.71788 7.89127 6.60998 8.00065C6.50208 8.11004 6.37369 8.19711 6.23213 8.25687C6.09058 8.31664 5.93865 8.34794 5.785 8.34899C5.63127 8.34794 5.47925 8.31661 5.33763 8.25678C5.19602 8.19695 5.06758 8.1098 4.95966 8.0003C4.85175 7.89081 4.76647 7.76112 4.7087 7.61865C4.65094 7.47618 4.62181 7.32372 4.623 7.16999C4.623 6.51899 5.143 5.98999 5.785 5.98999V5.99099ZM11.598 5.99099C12.24 5.99099 12.76 6.51999 12.76 7.17099C12.7611 7.32464 12.7318 7.47699 12.674 7.61934C12.6162 7.7617 12.5309 7.89127 12.423 8.00065C12.3151 8.11004 12.1867 8.19711 12.0451 8.25687C11.9036 8.31664 11.7516 8.34794 11.598 8.34899C11.4444 8.34794 11.2924 8.31664 11.1509 8.25687C11.0093 8.19711 10.8809 8.11004 10.773 8.00065C10.6651 7.89127 10.5798 7.7617 10.522 7.61934C10.4642 7.47699 10.4349 7.32464 10.436 7.17099C10.436 6.51999 10.956 5.99099 11.598 5.99099ZM16.938 8.85799C15.141 8.80599 13.192 9.36999 11.658 10.644C9.938 12.072 8.971 14.364 9.878 16.864C10.82 19.317 13.544 21.093 16.762 21.093C17.588 21.093 18.384 20.973 19.123 20.757C19.2227 20.7267 19.3278 20.7183 19.431 20.7325C19.5342 20.7467 19.6331 20.783 19.721 20.839L21.305 21.765C21.3464 21.7933 21.3949 21.8095 21.445 21.812C21.579 21.812 21.685 21.701 21.685 21.565C21.685 21.505 21.662 21.445 21.647 21.388L21.32 20.155C21.3053 20.1043 21.2976 20.0518 21.297 19.999C21.2966 19.9215 21.3147 19.845 21.3496 19.7758C21.3845 19.7066 21.4354 19.6467 21.498 19.601C23.024 18.48 24 16.82 24 14.98C24 11.77 21.069 9.14299 17.344 8.89199V8.88999C17.209 8.87999 17.074 8.86299 16.937 8.85999L16.938 8.85799ZM14.408 12.132C14.943 12.132 15.377 12.572 15.377 13.114C15.3779 13.2422 15.3536 13.3693 15.3054 13.488C15.2572 13.6068 15.1861 13.7149 15.0961 13.8062C15.0061 13.8975 14.899 13.9701 14.781 14.02C14.6629 14.0699 14.5362 14.0961 14.408 14.097C14.2798 14.0961 14.1531 14.0699 14.035 14.02C13.917 13.9701 13.8099 13.8975 13.7199 13.8062C13.6299 13.7149 13.5588 13.6068 13.5106 13.488C13.4624 13.3693 13.4381 13.2422 13.439 13.114C13.439 12.572 13.873 12.132 14.409 12.132H14.408ZM19.252 12.132C19.787 12.132 20.221 12.572 20.221 13.114C20.2219 13.2422 20.1976 13.3693 20.1494 13.488C20.1012 13.6068 20.0301 13.7149 19.9401 13.8062C19.8501 13.8975 19.743 13.9701 19.625 14.02C19.5069 14.0699 19.3802 14.0961 19.252 14.097C19.1238 14.0961 18.9971 14.0699 18.879 14.02C18.761 13.9701 18.6539 13.8975 18.5639 13.8062C18.4739 13.7149 18.4028 13.6068 18.3546 13.488C18.3064 13.3693 18.2821 13.2422 18.283 13.114C18.283 12.572 18.717 12.132 19.252 12.132Z" fill="black"/></svg>`,
  line: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_12)"><path d="M19.365 9.86278C19.714 9.86278 19.995 10.1478 19.995 10.4938C19.995 10.8388 19.714 11.1238 19.365 11.1238H17.61V12.2488H19.365C19.714 12.2488 19.995 12.5318 19.995 12.8788C19.995 13.2228 19.714 13.5078 19.365 13.5078H16.979C16.634 13.5078 16.352 13.2228 16.352 12.8788V8.10778C16.352 7.76278 16.634 7.47778 16.982 7.47778H19.368C19.714 7.47778 19.995 7.76278 19.995 8.10778C19.995 8.45678 19.714 8.73778 19.365 8.73778H17.61V9.86278H19.365ZM15.51 12.8788C15.51 13.1488 15.336 13.3888 15.078 13.4748C15.014 13.4958 14.945 13.5058 14.879 13.5058C14.668 13.5058 14.488 13.4158 14.369 13.2558L11.926 9.93878V12.8788C11.926 13.2228 11.647 13.5078 11.295 13.5078C10.949 13.5078 10.669 13.2228 10.669 12.8788V8.10778C10.669 7.83778 10.842 7.59778 11.099 7.51278C11.159 7.48978 11.235 7.47978 11.293 7.47978C11.488 7.47978 11.668 7.58378 11.788 7.73378L14.25 11.0638V8.10778C14.25 7.76278 14.532 7.47778 14.88 7.47778C15.225 7.47778 15.51 7.76278 15.51 8.10778V12.8788ZM9.769 12.8788C9.769 13.2228 9.487 13.5078 9.138 13.5078C8.793 13.5078 8.511 13.2228 8.511 12.8788V8.10778C8.511 7.76278 8.793 7.47778 9.141 7.47778C9.487 7.47778 9.769 7.76278 9.769 8.10778V12.8788ZM7.303 13.5078H4.917C4.572 13.5078 4.287 13.2228 4.287 12.8788V8.10778C4.287 7.76278 4.572 7.47778 4.917 7.47778C5.265 7.47778 5.547 7.76278 5.547 8.10778V12.2488H7.303C7.651 12.2488 7.932 12.5318 7.932 12.8788C7.932 13.2228 7.65 13.5078 7.303 13.5078ZM24 10.3138C24 4.94278 18.615 0.571777 12 0.571777C5.385 0.571777 0 4.94278 0 10.3138C0 15.1248 4.27 19.1558 10.035 19.9218C10.426 20.0038 10.958 20.1798 11.093 20.5118C11.213 20.8128 11.172 21.2778 11.131 21.5918L10.967 22.6118C10.922 22.9128 10.727 23.7978 12.016 23.2568C13.307 22.7178 18.932 19.1788 21.452 16.2818C23.176 14.3928 24 12.4578 24 10.3138Z" fill="black"/></g><defs><clipPath id="clip0_2549_12"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  slack: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_27)"><path d="M5.06371 15.1719C5.06371 16.5669 3.93632 17.6942 2.54141 17.6942C1.1465 17.6942 0.0191067 16.5669 0.0191067 15.1719C0.0191067 13.777 1.1465 12.6496 2.54141 12.6496H5.06371V15.1719ZM6.32486 15.1719C6.32486 13.777 7.45225 12.6496 8.84716 12.6496C10.2421 12.6496 11.3695 13.777 11.3695 15.1719V21.4777C11.3695 22.8726 10.2421 24 8.84716 24C7.45225 24 6.32486 22.8726 6.32486 21.4777V15.1719Z" fill="black"/><path d="M8.84716 5.0446C7.45225 5.0446 6.32486 3.91721 6.32486 2.5223C6.32486 1.12739 7.45225 0 8.84716 0C10.2421 0 11.3695 1.12739 11.3695 2.5223V5.0446H8.84716ZM8.84716 6.32486C10.2421 6.32486 11.3695 7.45225 11.3695 8.84716C11.3695 10.2421 10.2421 11.3695 8.84716 11.3695H2.5223C1.12739 11.3695 0 10.2421 0 8.84716C0 7.45225 1.12739 6.32486 2.5223 6.32486H8.84716Z" fill="black"/><path d="M18.9555 8.84716C18.9555 7.45225 20.0829 6.32486 21.4778 6.32486C22.8727 6.32486 24.0001 7.45225 24.0001 8.84716C24.0001 10.2421 22.8727 11.3695 21.4778 11.3695H18.9555V8.84716ZM17.6943 8.84716C17.6943 10.2421 16.5669 11.3695 15.172 11.3695C13.7771 11.3695 12.6497 10.2421 12.6497 8.84716V2.5223C12.6497 1.12739 13.7771 0 15.172 0C16.5669 0 17.6943 1.12739 17.6943 2.5223V8.84716Z" fill="black"/><path d="M15.172 18.9554C16.5669 18.9554 17.6943 20.0828 17.6943 21.4777C17.6943 22.8726 16.5669 24 15.172 24C13.7771 24 12.6497 22.8726 12.6497 21.4777V18.9554H15.172ZM15.172 17.6942C13.7771 17.6942 12.6497 16.5669 12.6497 15.1719C12.6497 13.777 13.7771 12.6496 15.172 12.6496H21.4969C22.8918 12.6496 24.0192 13.777 24.0192 15.1719C24.0192 16.5669 22.8918 17.6942 21.4969 17.6942H15.172Z" fill="black"/></g><defs><clipPath id="clip0_2549_27"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  teams: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M22.9395 9.25003C23.5252 9.25004 24 9.71789 24 10.295V15.8594C24 17.9805 22.255 19.7 20.1025 19.7H20.0841C19.4921 19.7001 18.9311 19.5699 18.4286 19.3373C17.4665 21.4473 15.3403 22.9396 12.8372 23C8.53862 22.8963 7.03129 19.1501 7.18881 19.15H12.374C12.5063 19.15 12.6372 19.1238 12.7591 19.073C13.1418 18.9177 13.3926 18.5513 13.3954 18.1435V9.25003H22.9395Z" fill="black"/><path fill-rule="evenodd" clip-rule="evenodd" d="M11.2577 5.94997C11.2619 5.94998 11.2661 5.95026 11.2703 5.95033C11.8113 5.95767 12.2508 6.37861 12.2777 6.9069C12.2785 6.92333 12.279 6.93989 12.2791 6.95652V17.0419C12.2791 17.5986 11.821 18.05 11.256 18.05H1.0231C0.458076 18.05 2.31939e-06 17.5986 0 17.0419V6.95815C4.83201e-06 6.40137 0.458088 5.94997 1.0231 5.94997H11.2577ZM3.44705 9.78791H5.48318V15.2769H6.78644V9.78791H8.832V8.72316H3.44705V9.78791Z" fill="black"/><path d="M20.9302 3.19995C22.3174 3.19996 23.4419 4.30808 23.4419 5.67498C23.4419 7.04189 22.3174 8.15001 20.9302 8.15001C19.5431 8.15001 18.4186 7.04189 18.4186 5.67498C18.4186 4.30808 19.5431 3.19995 20.9302 3.19995Z" fill="black"/><path d="M13.1163 1C15.1199 1.00001 16.7441 2.60057 16.7442 4.57496C16.7442 6.54937 15.399 8.13899 13.3954 8.139V6.40647C13.3932 5.85147 12.9371 5.4021 12.3739 5.4H9.58887C9.58887 5.4 9.48834 4.80483 9.48834 4.57496C9.48837 2.60056 11.1127 1 13.1163 1Z" fill="black"/></svg>`,
  discord: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_4)"><path d="M20.317 4.36997C18.761 3.65574 17.119 3.14642 15.4319 2.85477C15.4166 2.85191 15.4007 2.85396 15.3867 2.86062C15.3726 2.86728 15.3609 2.87822 15.3534 2.89187C15.1424 3.26717 14.9087 3.75667 14.7451 4.14137C12.9004 3.86517 11.0651 3.86517 9.2583 4.14137C9.0947 3.74807 8.8525 3.26717 8.6406 2.89187C8.63276 2.87853 8.62107 2.86786 8.60706 2.86126C8.59306 2.85466 8.57739 2.85243 8.5621 2.85487C6.87488 3.14584 5.2327 3.65511 3.6769 4.36987C3.66359 4.37556 3.65238 4.38524 3.6448 4.39757C0.533404 9.04597 -0.318996 13.5801 0.099204 18.058C0.100386 18.0689 0.103757 18.0796 0.109116 18.0892C0.114476 18.0988 0.121714 18.1073 0.130404 18.1141C2.1832 19.6217 4.1717 20.5369 6.1233 21.1435C6.13848 21.148 6.15468 21.1478 6.16972 21.1429C6.18477 21.1379 6.19795 21.1285 6.2075 21.1159C6.6691 20.4855 7.0806 19.8207 7.4335 19.1217C7.43835 19.1121 7.44112 19.1016 7.44163 19.0909C7.44213 19.0802 7.44036 19.0695 7.43643 19.0595C7.4325 19.0495 7.4265 19.0405 7.41883 19.033C7.41115 19.0255 7.40198 19.0197 7.3919 19.016C6.7391 18.7684 6.1176 18.4665 5.5197 18.1237C5.5088 18.1173 5.49964 18.1083 5.49304 18.0975C5.48643 18.0867 5.48258 18.0745 5.48183 18.0619C5.48108 18.0492 5.48345 18.0366 5.48873 18.0251C5.49401 18.0136 5.50204 18.0036 5.5121 17.996C5.6379 17.9017 5.7638 17.8037 5.8839 17.7046C5.89458 17.6958 5.9075 17.6901 5.92121 17.6883C5.93492 17.6864 5.94887 17.6884 5.9615 17.6941C9.8893 19.4874 14.1415 19.4874 18.0229 17.6941C18.0355 17.6881 18.0496 17.6858 18.0635 17.6874C18.0774 17.6891 18.0906 17.6947 18.1014 17.7036C18.2216 17.8026 18.3474 17.9017 18.4742 17.996C18.4843 18.0035 18.4924 18.0135 18.4977 18.0249C18.5031 18.0364 18.5055 18.0489 18.5049 18.0615C18.5042 18.0741 18.5005 18.0864 18.494 18.0972C18.4875 18.108 18.4784 18.1171 18.4676 18.1236C17.8695 18.4729 17.2429 18.7711 16.5946 19.015C16.5845 19.0188 16.5754 19.0248 16.5678 19.0324C16.5602 19.04 16.5542 19.0492 16.5504 19.0592C16.5466 19.0693 16.5449 19.0801 16.5455 19.0908C16.5461 19.1016 16.549 19.1121 16.5539 19.1217C16.9143 19.8197 17.3258 20.4845 17.7789 21.1149C17.7882 21.1279 17.8013 21.1376 17.8164 21.1428C17.8315 21.1479 17.8478 21.1482 17.8631 21.1435C19.8241 20.5368 21.8126 19.6216 23.8654 18.1141C23.8742 18.1076 23.8816 18.0994 23.887 18.0898C23.8924 18.0803 23.8957 18.0698 23.8967 18.0589C24.3971 12.8819 23.0585 8.38497 20.3482 4.39847C20.3416 4.38552 20.3305 4.37548 20.317 4.36997ZM8.02 15.3314C6.8375 15.3314 5.8631 14.2457 5.8631 12.9124C5.8631 11.5792 6.8186 10.4935 8.0201 10.4935C9.2309 10.4935 10.1958 11.5887 10.1769 12.9125C10.1769 14.2457 9.2214 15.3314 8.02 15.3314ZM15.9948 15.3314C14.8123 15.3314 13.8379 14.2457 13.8379 12.9124C13.8379 11.5792 14.7933 10.4935 15.9948 10.4935C17.2056 10.4935 18.1705 11.5887 18.1516 12.9125C18.1516 14.2457 17.2056 15.3314 15.9948 15.3314Z" fill="black"/></g><defs><clipPath id="clip0_2549_4"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  instagram: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_10)"><path d="M7.03008 0.0840168C5.75328 0.144217 4.88138 0.348017 4.11908 0.647417C3.33028 0.954917 2.66158 1.36742 1.99628 2.03512C1.33108 2.70282 0.921282 3.37192 0.616082 4.16212C0.320682 4.92592 0.120482 5.79862 0.0640816 7.07612C0.00768159 8.35362 -0.00481841 8.76432 0.00148159 12.0231C0.00768159 15.2817 0.0220816 15.6902 0.0839816 16.9704C0.144982 18.2469 0.347982 19.1186 0.647482 19.8811C0.955482 20.67 1.36748 21.3384 2.03548 22.0039C2.70338 22.6694 3.37198 23.0782 4.16398 23.3839C4.92718 23.6789 5.80008 23.88 7.07738 23.9359C8.35468 23.9919 8.76578 24.0049 12.0236 23.9986C15.2814 23.9924 15.6916 23.9779 16.9714 23.9172C18.2514 23.8565 19.1184 23.652 19.8812 23.3539C20.6701 23.0453 21.339 22.6339 22.004 21.9658C22.669 21.2976 23.0785 20.628 23.3835 19.8374C23.6792 19.0742 23.8801 18.2014 23.9355 16.925C23.9915 15.6441 24.0047 15.2352 23.9985 11.977C23.9922 8.71872 23.9775 8.31022 23.9168 7.03052C23.8561 5.75082 23.6528 4.88182 23.3535 4.11882C23.0451 3.32992 22.6335 2.66202 21.9659 1.99602C21.2982 1.33002 20.628 0.920817 19.8378 0.616517C19.074 0.321017 18.2017 0.119717 16.9244 0.0645168C15.6471 0.00931678 15.236 -0.00498321 11.977 0.00141679C8.71798 0.00761679 8.30998 0.0216168 7.03008 0.0840168ZM7.17028 21.7771C6.00028 21.7262 5.36498 21.5318 4.94158 21.3691C4.38098 21.1531 3.98158 20.892 3.55968 20.4741C3.13768 20.0563 2.87858 19.6555 2.65968 19.0961C2.49528 18.6727 2.29728 18.0381 2.24258 16.8681C2.18308 15.6036 2.17058 15.2239 2.16358 12.0201C2.15658 8.81642 2.16888 8.43712 2.22428 7.17212C2.27428 6.00312 2.46988 5.36712 2.63228 4.94392C2.84828 4.38262 3.10848 3.98392 3.52728 3.56232C3.94608 3.14062 4.34568 2.88092 4.90558 2.66202C5.32858 2.49692 5.96308 2.30062 7.13258 2.24492C8.39808 2.18492 8.77728 2.17292 11.9806 2.16592C15.1839 2.15892 15.5641 2.17092 16.8301 2.22672C17.9991 2.27752 18.6354 2.47122 19.0581 2.63472C19.6189 2.85072 20.0181 3.11012 20.4397 3.52972C20.8614 3.94912 21.1213 4.34732 21.3402 4.90842C21.5055 5.33012 21.7019 5.96442 21.7571 7.13472C21.8173 8.40022 21.831 8.77972 21.8367 11.9827C21.8425 15.1857 21.8312 15.5661 21.7757 16.8307C21.7247 18.0007 21.5307 18.6362 21.3677 19.0601C21.1517 19.6205 20.8914 20.0201 20.4723 20.4415C20.0533 20.863 19.6542 21.1226 19.094 21.3415C18.6716 21.5064 18.0363 21.7032 16.8678 21.7589C15.6022 21.8184 15.223 21.8309 12.0185 21.8379C8.81398 21.8449 8.43578 21.8319 7.17028 21.7771ZM16.953 5.58642C16.9535 5.87125 17.0384 6.14954 17.197 6.38609C17.3557 6.62265 17.5809 6.80684 17.8443 6.91537C18.1076 7.02391 18.3972 7.05191 18.6765 6.99583C18.9557 6.93975 19.2121 6.80212 19.4131 6.60034C19.6141 6.39855 19.7508 6.14169 19.8058 5.86222C19.8609 5.58276 19.8318 5.29325 19.7223 5.03032C19.6128 4.76739 19.4277 4.54284 19.1906 4.38508C18.9534 4.22731 18.6748 4.14342 18.39 4.14402C18.0082 4.14481 17.6423 4.29721 17.3728 4.56769C17.1034 4.83818 16.9523 5.20461 16.953 5.58642ZM5.83848 12.012C5.84518 15.4152 8.60908 18.1677 12.0115 18.1613C15.4141 18.1548 18.1685 15.3912 18.1621 11.988C18.1556 8.58482 15.3911 5.83152 11.9881 5.83822C8.58508 5.84492 5.83208 8.60922 5.83848 12.012ZM7.99998 12.0077C7.99842 11.2166 8.23149 10.4428 8.66971 9.78412C9.10793 9.12546 9.73163 8.61154 10.4619 8.30735C11.1922 8.00315 11.9963 7.92234 12.7726 8.07514C13.5488 8.22794 14.2623 8.60749 14.8228 9.16578C15.3833 9.72408 15.7657 10.436 15.9216 11.2117C16.0774 11.9873 15.9998 12.7917 15.6985 13.5232C15.3972 14.2547 14.8858 14.8804 14.2289 15.3213C13.572 15.7621 12.7991 15.9982 12.008 15.9998C11.4827 16.0009 10.9623 15.8985 10.4766 15.6985C9.99082 15.4985 9.54925 15.2047 9.17706 14.834C8.80487 14.4633 8.50935 14.0229 8.30739 13.5379C8.10542 13.053 8.00097 12.533 7.99998 12.0077Z" fill="black"/></g><defs><clipPath id="clip0_2549_10"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
  tiktok: `<svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><g clip-path="url(#clip0_2549_54)"><path d="M12.525 0.02C13.835 0 15.135 0.01 16.435 0C16.515 1.53 17.065 3.09 18.185 4.17C19.305 5.28 20.885 5.79 22.425 5.96V9.99C20.985 9.94 19.535 9.64 18.225 9.02C17.655 8.76 17.125 8.43 16.605 8.09C16.595 11.01 16.615 13.93 16.585 16.84C16.505 18.24 16.045 19.63 15.235 20.78C13.925 22.7 11.655 23.95 9.325 23.99C7.895 24.07 6.465 23.68 5.245 22.96C3.225 21.77 1.805 19.59 1.595 17.25C1.575 16.75 1.565 16.25 1.585 15.76C1.765 13.86 2.705 12.04 4.165 10.8C5.825 9.36 8.145 8.67 10.315 9.08C10.335 10.56 10.275 12.04 10.275 13.52C9.285 13.2 8.125 13.29 7.255 13.89C6.625 14.3 6.145 14.93 5.895 15.64C5.685 16.15 5.745 16.71 5.755 17.25C5.995 18.89 7.575 20.27 9.255 20.12C10.375 20.11 11.445 19.46 12.025 18.51C12.215 18.18 12.425 17.84 12.435 17.45C12.535 15.66 12.495 13.88 12.505 12.09C12.515 8.06 12.495 4.04 12.525 0.02Z" fill="black"/></g><defs><clipPath id="clip0_2549_54"><rect width="24" height="24" fill="white"/></clipPath></defs></svg>`,
} as const;
---

<div
  class="ck-instanceEmbed"
  id={anchorId}
  data-ck-instance-id={anchorId}
  data-ck-widget-type={widgetType}
  data-ck-min-height={String(PRAGUE_EMBED_MIN_HEIGHT)}
  data-ck-max-height={String(PRAGUE_EMBED_MAX_HEIGHT)}
>
  {iframeSrc ? (
    <>
      {embedMode === 'indexable' && loaderSrc ? (
        <script
          src={loaderSrc}
          defer
          data-public-id={publicId}
          data-trigger="immediate"
          data-ck-optimization="seo-geo"
          data-theme="light"
          data-device="desktop"
          data-locale={resolvedLocale}
          data-max-width="0"
          data-min-height="420"
          data-width="100%"
          data-ts={tsToken}
        />
      ) : (
        <iframe
          class="ck-instanceEmbed__iframe"
          title={title}
          src={iframeSrc}
          loading={loading}
          referrerpolicy="no-referrer"
          sandbox="allow-scripts allow-same-origin allow-forms"
        />
      )}

      {showShareChrome ? (
        <>
          {/* Toast is anchored to the creative (not the fading topbar). */}
          <div class="ck-share__toast" role="status" aria-live="polite"></div>

          {/* Global creative chrome (outside iframe): share bar (hover/focus reveal). */}
          <div class="ck-instanceEmbed__topbar">
            <details class="ck-share">
              <summary class="ck-btn ck-btn--md label-s ck-share__btn">
                <span class="diet-btn-is__icon" aria-hidden="true">
                  <Icon name="share" size={18} />
                </span>
                <span class="diet-btn-is__label">Share</span>
              </summary>

              <div class="ck-share__menu" role="menu" aria-label="Share options">
                <div class="ck-share__sectionTitle eyebrow heading-5">Send this widget template as message</div>
                <div class="ck-share__grid">
                  <button type="button" class="ck-shareCard" data-action="copy">
                    <span class="ck-shareCard__icon" aria-hidden="true">
                      <Icon name="copy" size={18} />
                    </span>
                    <span class="ck-shareCard__label body-s">Copy link</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="sms">
                    <span class="ck-shareCard__icon" aria-hidden="true">
                      <Icon name="sms" size={18} />
                    </span>
                    <span class="ck-shareCard__label body-s">SMS</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="email">
                    <span class="ck-shareCard__icon" aria-hidden="true">
                      <Icon name="email" size={18} />
                    </span>
                    <span class="ck-shareCard__label body-s">Email</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="whatsapp">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="whatsapp" size={18} /></span>
                    <span class="ck-shareCard__label body-s">WhatsApp</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="telegram">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="telegram" size={18} /></span>
                    <span class="ck-shareCard__label body-s">Telegram</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="signal">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.signal} />
                    <span class="ck-shareCard__label body-s">Signal</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="messenger">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.messenger} />
                    <span class="ck-shareCard__label body-s">Messenger</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="wechat">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.wechat} />
                    <span class="ck-shareCard__label body-s">WeChat</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="line">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.line} />
                    <span class="ck-shareCard__label body-s">LINE</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="slack">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.slack} />
                    <span class="ck-shareCard__label body-s">Slack</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="teams">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.teams} />
                    <span class="ck-shareCard__label body-s">Teams</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="discord">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.discord} />
                    <span class="ck-shareCard__label body-s">Discord</span>
                  </button>
                </div>

                <div class="ck-share__sectionTitle eyebrow heading-5">Share this widget template on social</div>
                <div class="ck-share__grid">
                  <button type="button" class="ck-shareCard" data-action="x">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="x" size={18} /></span>
                    <span class="ck-shareCard__label body-s">X</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="linkedin">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="linkedin" size={18} /></span>
                    <span class="ck-shareCard__label body-s">LinkedIn</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="facebook">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="facebook" size={18} /></span>
                    <span class="ck-shareCard__label body-s">Facebook</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="reddit">
                    <span class="ck-shareCard__icon" aria-hidden="true"><Icon name="reddit" size={18} /></span>
                    <span class="ck-shareCard__label body-s">Reddit</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="instagram">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.instagram} />
                    <span class="ck-shareCard__label body-s">Instagram</span>
                  </button>
                  <button type="button" class="ck-shareCard" data-action="tiktok">
                    <span class="ck-shareCard__icon ck-shareCard__icon--brand" aria-hidden="true" set:html={brandSvgs.tiktok} />
                    <span class="ck-shareCard__label body-s">TikTok</span>
                  </button>
                </div>
              </div>
            </details>
          </div>
        </>
      ) : null}
    </>
  ) : (
    <div class="ck-media ck-instanceEmbed__stub">
      Missing <code>PUBLIC_VENICE_URL</code> — cannot embed {publicId}
    </div>
  )}
</div>

<style>
  .ck-instanceEmbed {
    width: 100%;
    position: relative;
    isolation: isolate;
    --ck-creative-chrome-inset: var(--space-4);
    --ck-embedChromeBtn-bg: color-mix(in oklab, var(--color-system-black) 80%, transparent);
    --ck-embedChromeBtn-color: var(--color-system-white);
    --ck-embedChromeBtn-border: 1px solid color-mix(in oklab, var(--color-system-white), transparent 84%);
    --ck-embedChromeBtn-hover-bg: color-mix(in oklab, var(--color-system-black) 86%, transparent);
    --ck-embedChromeBtn-clicked-bg: color-mix(in oklab, var(--color-system-black) 90%, transparent);
    border-radius: var(--control-radius-4xl);
    overflow: hidden;
    background: transparent;
    border: 0;
  }

  .ck-instanceEmbed__topbar {
    position: absolute;
    /* Button inset must match on top + right. */
    top: var(--ck-creative-chrome-inset);
    right: var(--ck-creative-chrome-inset);
    left: auto;
    width: auto;
    display: flex;
    align-items: center;
    justify-content: flex-end;
    padding: 0;
    z-index: 80;
    opacity: 0;
    transition: opacity var(--duration-base, 160ms);
  }

  /* Dark glass CTA (share) inside embed chrome — matches personalize, but ~20% smaller. */
  .ck-instanceEmbed__topbar .ck-share__btn {
    --ck-btn-bg: var(--ck-embedChromeBtn-bg);
    --ck-btn-color: var(--ck-embedChromeBtn-color);
    --ck-btn-border-w: 1px;
    --ck-btn-border-color: color-mix(in oklab, var(--color-system-white), transparent 84%);
    --ck-btn-hover-bg: var(--ck-embedChromeBtn-hover-bg);
    --ck-btn-hover-color: var(--ck-embedChromeBtn-color);
    --ck-btn-hover-border-color: color-mix(in oklab, var(--color-system-white), transparent 78%);
    --ck-btn-clicked-bg: var(--ck-embedChromeBtn-clicked-bg);
    --ck-btn-clicked-color: var(--ck-embedChromeBtn-color);
    --ck-btn-clicked-border-color: color-mix(in oklab, var(--color-system-white), transparent 72%);
    --ck-btn-radius: var(--control-radius-lg);
    --ck-btn-min-h: 2.6rem; /* 52px * 0.8 = 41.6px */
    /* Match the personalize CTA padding rhythm, scaled down ~20%. */
    --ck-btn-px: calc((var(--control-padding-inline) + var(--space-2)) * 0.8);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    gap: var(--control-inline-gap-sm);
    color: var(--ck-embedChromeBtn-color);
  }

  .ck-instanceEmbed:hover .ck-instanceEmbed__topbar,
  .ck-instanceEmbed:focus-within .ck-instanceEmbed__topbar {
    opacity: 1;
  }

  @media (hover: none) {
    .ck-instanceEmbed__topbar { opacity: 1; }
  }

  .ck-share {
    /* Let the menu anchor to the button itself. */
    position: relative;
  }

  .ck-share__btn {
    /* The trigger is a Dieter-aligned button; we only do details/marker hygiene here. */
    list-style: none;
  }

  .ck-share__btn::-webkit-details-marker { display: none; }
  .ck-share__btn::marker { content: ''; }

  .diet-btn-is__icon {
    display: inline-flex;
    width: 18px;
    height: 18px;
    align-items: center;
    justify-content: center;
    color: currentColor;
  }

  /* Ensure label utilities cannot override the button chrome color. */
  .ck-instanceEmbed__topbar .ck-share__btn .diet-btn-is__label {
    color: inherit;
  }

  .ck-share__menu {
    position: absolute;
    top: calc(100% + var(--space-3));
    right: 0;
    left: auto;
    width: min(760px, calc(100vw - 32px));
    max-height: min(520px, calc(100vh - 120px));
    overflow: auto;
    background: color-mix(in oklab, var(--color-system-white), transparent 8%);
    border-radius: var(--control-radius-2xl);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 90%);
    box-shadow: 0 28px 90px color-mix(in oklab, var(--color-system-black), transparent 86%);
    backdrop-filter: blur(18px);
    -webkit-backdrop-filter: blur(18px);
    padding: 16px;
    display: none;
  }

  .ck-share[open] .ck-share__menu { display: block; }

  .ck-share__toast {
    position: absolute;
    /* Show under the Share button regardless of topbar hover state. */
    top: calc(var(--ck-creative-chrome-inset) + 2.25rem + var(--space-3));
    right: var(--ck-creative-chrome-inset);
    left: auto;
    z-index: 70;
    display: none;
    padding: 9px 12px;
    border-radius: var(--control-radius-lg);
    background: color-mix(in oklab, var(--color-system-white), transparent 25%);
    color: color-mix(in oklab, var(--color-system-black), transparent 25%);
    font: 500 var(--fs-13)/1.2 var(--font-ui);
    backdrop-filter: blur(10px);
    -webkit-backdrop-filter: blur(10px);
    box-shadow: 0 20px 60px color-mix(in oklab, var(--color-system-black), transparent 92%);
    pointer-events: none;
  }

  .ck-share__grid {
    display: grid;
    /* Fixed layout: 6 items per row (as requested). */
    grid-template-columns: repeat(6, minmax(0, 1fr));
    gap: var(--space-2);
  }

  .ck-share__sectionTitle {
    margin: 10px 6px var(--space-3);
    color: var(--color-system-black);
    white-space: nowrap;
  }

  .ck-share__grid {
    margin-bottom: var(--space-5);
  }

  .ck-share__grid:last-of-type {
    margin-bottom: 0;
  }

  .ck-shareCard {
    width: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 16px 10px;
    min-height: 88px;
    border-radius: var(--control-radius-xl);
    border: 0;
    /* “gray-5.4” (Dieter ladder) — with a safe fallback so tokens never break layout. */
    background: var(--color-system-gray-5-step4, color-mix(in oklab, var(--color-system-black) 6%, transparent));
    color: var(--color-system-black);
    cursor: pointer;
    text-align: center;
    transition: background-color var(--duration-base, 160ms), border-color var(--duration-base, 160ms),
      color var(--duration-base, 160ms), transform var(--duration-base, 160ms);
  }

  .ck-shareCard:hover {
    background: color-mix(
      in oklab,
      var(--color-system-gray-5-step4, color-mix(in oklab, var(--color-system-black) 6%, transparent)),
      var(--color-system-black) 8%
    );
    color: var(--color-system-blue);
  }

  .ck-shareCard:active {
    transform: translateY(1px);
  }

  .ck-shareCard:focus-visible {
    outline: var(--focus-ring-width) solid var(--color-system-blue);
    outline-offset: 2px;
    color: var(--color-system-blue);
  }

  .ck-shareCard__icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 34px;
    height: 34px;
    /* No icon “badge” circle; icon sits directly on the card surface. */
    border-radius: 0;
    background: transparent;
    color: inherit;
    flex: 0 0 auto;
  }

  .ck-shareCard__icon svg {
    width: 20px;
    height: 20px;
    display: block;
    /* Ensure SVG uses the card's inherited color (Safari/WebKit consistency). */
    color: inherit;
  }

  /* If an SVG path carries a stroke attribute, normalize it to currentColor. */
  :global(.ck-shareCard__icon svg [stroke]) {
    stroke: currentColor;
  }

  /* If an SVG path carries a fill attribute, normalize it to currentColor. */
  :global(.ck-shareCard__icon svg [fill]) {
    fill: currentColor;
  }
  /* Brand SVGs are injected via `set:html` (no Astro scoping attrs), so must be global. */
  :global(.ck-shareCard__icon--brand svg path) {
    fill: currentColor;
  }

  .ck-shareCard__label {
    display: block;
    line-height: 1.05;
    text-wrap: balance;
    color: inherit;
  }


  .ck-instanceEmbed__iframe {
    width: 100%;
    border: 0;
    display: block;
    background: transparent;
    position: relative;
    z-index: 1;
    min-height: 420px;
    max-height: 800px;
    height: 420px;
  }

  .ck-instanceEmbed__stub {
    min-height: 240px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    padding: var(--space-6);
    text-align: center;
  }
</style>

<script is:inline>
(() => {
  // Do not rely on 'document.currentScript' (unreliable for module scripts in Astro).
  // This script may be emitted multiple times (one per instance), so dedupe per element.
  const instances = document.querySelectorAll('.ck-instanceEmbed');
  instances.forEach((instance) => {
    if (!(instance instanceof HTMLElement)) return;
    if (instance.dataset.ckShareBound === '1') return;
    instance.dataset.ckShareBound = '1';

    // Handle dynamic iframe resizing
    const iframe = instance.querySelector('.ck-instanceEmbed__iframe');
    if (iframe instanceof HTMLIFrameElement) {
      const resizeHandler = (event) => {
        if (event.source !== iframe.contentWindow) return;
        if (!event.data || typeof event.data !== 'object') return;
        if (event.data.type !== 'ck:resize') return;

        const height = event.data.height;
        const canvasMode = typeof event.data.canvasMode === 'string' ? event.data.canvasMode : '';
        if (typeof height === 'number' && height > 0) {
          const rawMin = Number(instance.getAttribute('data-ck-min-height'));
          const rawMax = Number(instance.getAttribute('data-ck-max-height'));
          const minHeight = Number.isFinite(rawMin) ? rawMin : 420;
          const maxHeight = Number.isFinite(rawMax) && rawMax > 0 ? rawMax : 800;
          let next = Math.min(maxHeight, Math.max(minHeight, Math.ceil(height)));
          if (canvasMode === 'viewport') {
            next = maxHeight;
          }
          iframe.style.height = `${next}px`;
        }
      };

      window.addEventListener('message', resizeHandler);
      instance.dataset.ckResizeBound = '1';
    }

    const anchorId = instance.getAttribute('data-ck-instance-id') || instance.id || '';
    const widgetType = instance.getAttribute('data-ck-widget-type') || '';
    const details = instance.querySelector('.ck-share');
    const menu = instance.querySelector('.ck-share__menu');
    const toast = instance.querySelector('.ck-share__toast');
    if (!(details instanceof HTMLDetailsElement) || !(menu instanceof HTMLElement)) return;

    const close = () => { details.open = false; };

    document.addEventListener('click', (e) => {
      if (!details.open) return;
      const t = e.target;
      if (t instanceof Node && details.contains(t)) return;
      close();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') close();
    });

    // Avoid the "opens on hover" perception caused by the topbar being hidden:
    // if the user clicks Share (menu opens) and then moves mouse away, close it
    // so it can't reappear later just by hovering the instance again.
    instance.addEventListener('pointerleave', () => close());

    function titleCaseWidgetType(input) {
      const s = String(input || '').trim();
      if (!s) return 'Widget';
      if (s.toLowerCase() === 'faq') return 'FAQ';

      const spaced = s
        .replace(/[_-]+/g, ' ')
        .replace(/([a-z0-9])([A-Z])/g, '$1 $2')
        .toLowerCase();

      return spaced.replace(/\b[a-z]/g, (m) => m.toUpperCase());
    }

    function shareUrlFor(channel) {
      const u = new URL(window.location.href);
      if (anchorId) u.hash = anchorId;
      if (channel) {
        u.searchParams.set('ref', 'share');
        u.searchParams.set('channel', channel);
      }
      return u.toString();
    }

    function shareCopyFor(action) {
      const widgetName = titleCaseWidgetType(widgetType);
      const sendMessageText = 'Check out this widget from Clickeen!';
      // IMPORTANT: this script is embedded inside an Astro backtick string, so do not use JS template literals here.
      const socialText = 'This Clickeen ' + widgetName + ' widget is awesome ❤️';

      const isSocial = ['x', 'linkedin', 'facebook', 'reddit', 'instagram', 'tiktok'].includes(action);
      return isSocial ? socialText : sendMessageText;
    }

    let toastTimer = 0;
    function showToast(msg) {
      if (!(toast instanceof HTMLElement)) return;
      toast.textContent = msg;
      toast.style.display = 'block';
      if (toastTimer) window.clearTimeout(toastTimer);
      toastTimer = window.setTimeout(() => {
        toast.style.display = 'none';
        toast.textContent = '';
        toastTimer = 0;
      }, 1600);
    }

    async function copy(text) {
      try {
        if (navigator.clipboard?.writeText) {
          await navigator.clipboard.writeText(text);
          return true;
        }
      } catch {}
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); } catch {}
      document.body.removeChild(ta);
      return true;
    }

    function openUrl(url) {
      // IMPORTANT:
      // Some browsers can return a falsy value even when a new tab actually opens.
      // If we "fallback" to same-tab navigation, we can end up opening BOTH.
      // So: never same-tab fallback here. If blocked, we degrade to "copy link" instead.
      try {
        const w = window.open(url, '_blank');
        if (w) {
          try { w.opener = null; } catch {}
          return true;
        }
      } catch {}
      return false;
    }

    async function handle(action) {
      const url = shareUrlFor(action);
      const title = document.title || 'Clickeen';
      const text = shareCopyFor(action);

      if (action === 'copy') { await copy(url); showToast('Link copied'); return; }

      if (action === 'email') {
        const mailto = 'mailto:?subject=' + encodeURIComponent(title) + '&body=' + encodeURIComponent(text + '\n\n' + url);
        window.location.href = mailto;
        showToast('Opening email…');
        return;
      }

      if (action === 'sms') {
        const sms = 'sms:?&body=' + encodeURIComponent(text + ' ' + url);
        window.location.href = sms;
        showToast('Opening messages…');
        return;
      }

      if (action === 'whatsapp') {
        const ok = openUrl('https://wa.me/?text=' + encodeURIComponent(text + '\n' + url));
        if (ok) showToast('Opening WhatsApp…');
        else { await copy(url); showToast('Link copied (paste in WhatsApp)'); }
        return;
      }
      if (action === 'telegram') {
        const ok = openUrl('https://t.me/share/url?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
        if (ok) showToast('Opening Telegram…');
        else { await copy(url); showToast('Link copied (paste in Telegram)'); }
        return;
      }
      if (action === 'signal') { await copy(url); showToast('Link copied (paste in Signal)'); openUrl('https://signal.me/'); return; }

      if (action === 'x') {
        const ok = openUrl('https://twitter.com/intent/tweet?url=' + encodeURIComponent(url) + '&text=' + encodeURIComponent(text));
        if (ok) showToast('Opening X…');
        else { await copy(url); showToast('Link copied'); }
        return;
      }
      if (action === 'linkedin') {
        // LinkedIn does not reliably support prefilled share text via URL params.
        // Best UX: copy the composed message + anchored URL, then open LinkedIn.
        await copy(text + '\n\n' + url);
        showToast('Copied (paste in LinkedIn)');
        // Let the toast paint before opening the new tab.
        window.setTimeout(() => {
          openUrl('https://www.linkedin.com/sharing/share-offsite/?url=' + encodeURIComponent(url));
        }, 50);
        return;
      }
      if (action === 'facebook') {
        const ok = openUrl('https://www.facebook.com/sharer/sharer.php?u=' + encodeURIComponent(url));
        if (ok) showToast('Opening Facebook…');
        else { await copy(url); showToast('Link copied'); }
        return;
      }
      if (action === 'reddit') {
        const ok = openUrl('https://www.reddit.com/submit?url=' + encodeURIComponent(url) + '&title=' + encodeURIComponent(text));
        if (ok) showToast('Opening Reddit…');
        else { await copy(url); showToast('Link copied'); }
        return;
      }
      if (action === 'discord') { await copy(url); showToast('Link copied (paste in Discord)'); openUrl('https://discord.com/channels/@me'); return; }
      if (action === 'messenger') { await copy(url); showToast('Link copied (paste in Messenger)'); openUrl('https://www.messenger.com/'); return; }
      if (action === 'slack') { await copy(url); showToast('Link copied (paste in Slack)'); openUrl('https://slack.com/app'); return; }
      if (action === 'teams') { await copy(url); showToast('Link copied (paste in Teams)'); openUrl('https://teams.microsoft.com/'); return; }

      // Platforms without a reliable web intent: copy link + best-effort open.
      if (action === 'instagram') { await copy(url); showToast('Link copied (paste in Instagram)'); openUrl('https://www.instagram.com/'); return; }
      if (action === 'tiktok') { await copy(url); showToast('Link copied (paste in TikTok)'); openUrl('https://www.tiktok.com/'); return; }
      if (action === 'wechat') { await copy(url); showToast('Link copied (paste in WeChat)'); return; }
      if (action === 'line') { await copy(url); showToast('Link copied (paste in LINE)'); openUrl('https://line.me/'); return; }
    }

    menu.addEventListener('click', async (e) => {
      const t = e.target;
      if (!(t instanceof Element)) return;
      const btn = t.closest('[data-action]');
      if (!(btn instanceof HTMLElement)) return;
      const action = btn.getAttribute('data-action') || '';
      if (!action) return;
      e.preventDefault();
      try { await handle(action); } finally { close(); }
    });
  });
})();
</script>
