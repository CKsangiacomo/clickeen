---
type CuratedSlot = {
  blockId: string;
  blockType: string;
  target: 'block' | 'item' | 'item-public-id';
  itemIndex?: number;
  label: string;
  currentPublicId: string;
};

type CuratedBlock = {
  blockId: string;
  blockType: string;
  blockIndex?: number;
  label?: string;
  slots: CuratedSlot[];
};

type Props = {
  widget: string;
  page: string;
  blocks: CuratedBlock[];
};

type NormalizedSlot = CuratedSlot & { slotIndex: number };
type NormalizedBlock = {
  blockId: string;
  blockType: string;
  blockIndex: number;
  label: string;
  slots: NormalizedSlot[];
};

const { widget, page, blocks } = Astro.props;
const localHosts = new Set(['localhost', '127.0.0.1', '::1']);
const isLocalDev = import.meta.env.DEV && localHosts.has(Astro.url.hostname);

let runningSlotIndex = 0;
const normalizedBlocks: NormalizedBlock[] = [];

if (Array.isArray(blocks)) {
  blocks.forEach((block, arrayIndex) => {
    const blockId = String(block?.blockId || '').trim();
    const blockType = String(block?.blockType || '').trim();
    if (!blockId || !blockType) return;

    const blockIndex = Number.isInteger(block?.blockIndex) ? Number(block.blockIndex) : arrayIndex;
    const blockLabelRaw = String(block?.label || '').trim();
    const blockLabel = blockLabelRaw || `${blockType} block`;
    const normalizedSlots: NormalizedSlot[] = [];
    const rawSlots = Array.isArray(block?.slots) ? block.slots : [];

    rawSlots.forEach((slot) => {
      const label = String(slot?.label || '').trim();
      if (!label) return;
      normalizedSlots.push({
        blockId,
        blockType,
        target:
          slot?.target === 'item' || slot?.target === 'item-public-id'
            ? slot.target
            : 'block',
        itemIndex: typeof slot?.itemIndex === 'number' ? slot.itemIndex : undefined,
        label,
        currentPublicId: String(slot?.currentPublicId || '').trim(),
        slotIndex: runningSlotIndex++,
      });
    });

    normalizedBlocks.push({
      blockId,
      blockType,
      blockIndex,
      label: blockLabel,
      slots: normalizedSlots,
    });
  });
}

const normalizedSlotCount = normalizedBlocks.reduce((sum, block) => sum + block.slots.length, 0);
const drawerContext = JSON.stringify({
  widget,
  page,
  blockCount: normalizedBlocks.length,
  slotCount: normalizedSlotCount,
});
---

{isLocalDev && normalizedSlotCount > 0 ? (
  <div class="ck-localCurated" data-ck-local-curated="true" data-context={drawerContext}>
    <button
      class="ck-btn ck-btn--glass ck-btn--md label-s ck-localCurated__trigger"
      type="button"
      data-action="open"
    >
      Curated
    </button>

    <div
      class="ck-localCurated__backdrop"
      data-action="close"
      hidden
    ></div>

    <aside class="ck-localCurated__panel" data-role="panel" hidden>
      <div class="ck-localCurated__header">
        <div>
          <p class="overline ck-m0 ck-text-muted">Local Prague Tool</p>
          <h2 class="heading-5 ck-m0">Assign curated instances</h2>
          <p class="body-3 ck-m0 ck-text-muted">{widget} / {page}</p>
        </div>
        <button
          class="ck-btn ck-btn--secondary ck-btn--sm label-s"
          type="button"
          data-action="close"
        >
          Close
        </button>
      </div>

      <div class="ck-localCurated__status body-3" data-role="status" data-tone="muted">
        Ready. Choose curated public IDs and save.
      </div>

      <div class="ck-localCurated__blocks" data-role="blocks">
        {normalizedBlocks.map((block) => (
          <section class="ck-localCurated__block">
            <div class="ck-localCurated__blockMeta">
              <p class="label-s ck-m0">{block.label}</p>
              <p class="caption ck-m0 ck-text-muted">{block.blockId}</p>
            </div>

            {block.slots.length > 0 ? (
              <div class="ck-localCurated__blockSlots">
                {block.slots.map((slot) => (
                  <section
                    class="ck-localCurated__slot"
                    data-slot-index={String(slot.slotIndex)}
                    data-block-id={slot.blockId}
                    data-block-type={slot.blockType}
                    data-target={slot.target}
                    data-item-index={typeof slot.itemIndex === 'number' ? String(slot.itemIndex) : ''}
                    data-original={slot.currentPublicId}
                  >
                    <label class="ck-localCurated__slotMeta" for={`ck-local-curated-slot-${slot.slotIndex}`}>
                      <span class="label-s">{slot.label}</span>
                    </label>
                    <select id={`ck-local-curated-slot-${slot.slotIndex}`} class="ck-localCurated__select body-3" data-role="select">
                      <option value={slot.currentPublicId}>{slot.currentPublicId || 'Select an instance'}</option>
                    </select>
                  </section>
                ))}
              </div>
            ) : (
              <p class="caption ck-m0 ck-localCurated__blockEmpty">No editable instance slot in this block.</p>
            )}
          </section>
        ))}
      </div>

      <div class="ck-localCurated__footer">
        <button class="ck-btn ck-btn--secondary ck-btn--sm label-s" type="button" data-action="refresh-options">
          Refresh list
        </button>
        <button class="ck-btn ck-btn--primary ck-btn--sm label-s" type="button" data-action="save" disabled>
          Save changes
        </button>
      </div>
    </aside>
  </div>
) : null}

<script>
  import { initLocalCuratedDrawers } from '../lib/localCuratedDrawerClient';

  initLocalCuratedDrawers();
</script>

<style>
  .ck-localCurated {
    position: static;
  }

  .ck-localCurated__trigger {
    position: fixed;
    top: 50%;
    right: var(--space-4);
    transform: translateY(-50%);
    z-index: 1000;
    min-height: 2.625rem;
    padding-inline: var(--space-5);
  }

  .ck-localCurated__backdrop {
    position: fixed;
    inset: 0;
    background: color-mix(in oklab, var(--color-system-black), transparent 76%);
    opacity: 0;
    transition: opacity 180ms ease;
    z-index: 998;
  }

  .ck-localCurated__panel {
    position: fixed;
    inset: 0 0 0 auto;
    width: min(26rem, 94vw);
    height: 100dvh;
    max-height: 100dvh;
    display: flex;
    flex-direction: column;
    gap: var(--space-4);
    padding: var(--space-5) var(--space-5) calc(var(--space-5) + env(safe-area-inset-bottom, 0px));
    box-sizing: border-box;
    overflow: hidden;
    background: color-mix(in oklab, var(--color-system-white), var(--color-system-gray-6) 10%);
    border-left: 1px solid color-mix(in oklab, var(--color-system-black), transparent 86%);
    box-shadow: var(--shadow-elevated);
    transform: translateX(100%);
    transition: transform 180ms ease;
    z-index: 999;
  }

  .ck-localCurated.is-open .ck-localCurated__panel {
    transform: translateX(0);
  }

  .ck-localCurated.is-open .ck-localCurated__backdrop {
    opacity: 1;
  }

  .ck-localCurated__header {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: var(--space-3);
  }

  .ck-localCurated__header > div {
    display: grid;
    gap: var(--space-1);
  }

  .ck-localCurated__status {
    padding: var(--space-3);
    border-radius: var(--control-radius-lg);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 88%);
    background: var(--color-system-white);
    color: var(--ck-text-muted);
  }

  .ck-localCurated__status[data-tone='ok'] {
    color: color-mix(in oklab, var(--color-system-black), var(--color-system-green) 35%);
  }

  .ck-localCurated__status[data-tone='warn'] {
    color: color-mix(in oklab, var(--color-system-black), var(--color-system-orange) 45%);
  }

  .ck-localCurated__status[data-tone='error'] {
    color: color-mix(in oklab, var(--color-system-black), var(--color-system-red) 45%);
  }

  .ck-localCurated__blocks {
    flex: 1 1 auto;
    min-height: 0;
    overflow: auto;
    display: grid;
    align-content: start;
    gap: var(--space-3);
    padding-right: var(--space-1);
  }

  .ck-localCurated__block {
    display: grid;
    gap: var(--space-2);
    padding: var(--space-3);
    border-radius: var(--control-radius-lg);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 88%);
    background: var(--color-system-white);
  }

  .ck-localCurated__blockMeta {
    display: grid;
    gap: 2px;
  }

  .ck-localCurated__blockSlots {
    display: grid;
    gap: var(--space-2);
  }

  .ck-localCurated__blockEmpty {
    color: var(--ck-text-muted);
    padding-top: 2px;
  }

  .ck-localCurated__slot {
    display: grid;
    gap: 6px;
  }

  .ck-localCurated__slotMeta {
    display: grid;
    gap: 2px;
    color: var(--color-system-black);
  }

  .ck-localCurated__select {
    width: 100%;
    box-sizing: border-box;
    min-height: 2.5rem;
    border-radius: var(--control-radius-md);
    border: 1px solid color-mix(in oklab, var(--color-system-black), transparent 80%);
    padding: 0 var(--space-3);
    color: var(--color-system-black);
    background: var(--color-system-white);
    appearance: auto;
    max-width: 100%;
  }

  .ck-localCurated__select:focus-visible {
    outline: var(--focus-ring-width) solid var(--color-system-blue);
    outline-offset: var(--focus-ring-offset);
  }

  .ck-localCurated__footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-2);
    padding-top: var(--space-2);
    border-top: 1px solid color-mix(in oklab, var(--color-system-black), transparent 88%);
  }

  @media (max-width: 900px) {
    .ck-localCurated__trigger {
      top: auto;
      bottom: var(--space-4);
      right: var(--space-4);
      transform: none;
      min-height: 2.5rem;
      padding-inline: var(--space-4);
    }

    .ck-localCurated__panel {
      width: min(100vw, 26rem);
    }
  }
</style>
