---
import InstanceEmbed from './InstanceEmbed.astro';

type CarouselItem = {
  curatedRef: {
    publicId: string;
    locale: string;
    title?: string;
    embedMode?: 'iframe' | 'indexable';
  };
};

type Props = {
  items: CarouselItem[];
  id?: string;
};

const { items, id = `carousel-${Math.random().toString(36).substr(2, 9)}` } = Astro.props;
---

<div class="ck-carousel">
  {items && items.length > 0 ? (
    <>
      <div class="ck-carousel__track" id={id}>
        {items.concat(items[0]).map((item, index) => (
          <div class="ck-carousel__item" data-index={index}>
            {item.curatedRef ? (
              <InstanceEmbed
                publicId={item.curatedRef.publicId}
                locale={item.curatedRef.locale}
                title={item.curatedRef.title ?? `Widget preview ${index + 1}`}
                embedMode={item.curatedRef.embedMode}
              />
            ) : (
              <div class="ck-media ck-carousel__stub">Missing curatedRef</div>
            )}
          </div>
        ))}
      </div>
      <div class="ck-carousel__dots">
        {items.map((_, index) => (
          <button 
            class={`ck-carousel__dot ${index === 0 ? 'ck-carousel__dot--active' : ''}`} 
            aria-label={`Go to slide ${index + 1}`}
            data-target={index}
          />
        ))}
      </div>
    </>
  ) : (
    <div class="ck-media ck-carousel__stub">No items provided</div>
  )}
</div>

<script>
  function initCarousel(carouselId: string) {
    const track = document.getElementById(carouselId);
    if (!track) return;

    const dotsContainer = track.nextElementSibling as HTMLElement;
    if (!dotsContainer || !dotsContainer.classList.contains('ck-carousel__dots')) return;
    
    const dots = Array.from(dotsContainer.children) as HTMLButtonElement[];
    const items = Array.from(track.children) as HTMLElement[];
    const realItemCount = items.length - 1; // Last item is a clone
    let currentIndex = 0;
    let autoScrollInterval: number | undefined;
    let isAutoScrolling = false;
    const AUTO_SCROLL_DELAY = 3000;

    const updateDots = (index: number) => {
      const normalizedIndex = index >= realItemCount ? 0 : index;
      dots.forEach((dot, i) => {
        if (i === normalizedIndex) {
          dot.classList.add('ck-carousel__dot--active');
        } else {
          dot.classList.remove('ck-carousel__dot--active');
        }
      });
    };

    const scrollToItem = (index: number, behavior: ScrollBehavior = 'smooth') => {
      const item = items[index];
      if (item) {
        if (behavior === 'smooth') isAutoScrolling = true;
        
        track.scrollTo({
          left: item.offsetLeft - track.offsetLeft,
          behavior: behavior
        });
        
        if (behavior === 'auto') {
           updateDots(index);
           currentIndex = index;
        } else {
           currentIndex = index;
           updateDots(index);
        }
      }
    };

    const nextSlide = () => {
      const nextIndex = currentIndex + 1;
      
      if (nextIndex === realItemCount) {
        scrollToItem(nextIndex, 'smooth');
        setTimeout(() => {
           scrollToItem(0, 'auto');
           isAutoScrolling = false;
        }, 600);
      } else {
        scrollToItem(nextIndex, 'smooth');
        setTimeout(() => { isAutoScrolling = false; }, 600);
      }
    };

    const startAutoScroll = () => {
      if (autoScrollInterval) clearInterval(autoScrollInterval);
      autoScrollInterval = window.setInterval(nextSlide, AUTO_SCROLL_DELAY);
    };

    const stopAutoScroll = () => {
      if (autoScrollInterval) clearInterval(autoScrollInterval);
    };

    dots.forEach((dot, index) => {
      dot.addEventListener('click', () => {
        stopAutoScroll();
        scrollToItem(index, 'smooth');
        setTimeout(() => { isAutoScrolling = false; }, 600);
        startAutoScroll();
      });
    });

    track.addEventListener('mouseenter', stopAutoScroll);
    track.addEventListener('mouseleave', startAutoScroll);
    track.addEventListener('touchstart', stopAutoScroll);
    track.addEventListener('touchend', startAutoScroll);

    let isScrolling: number;
    track.addEventListener('scroll', () => {
       if (isAutoScrolling) return;

       window.clearTimeout(isScrolling);
       isScrolling = window.setTimeout(() => {
          const trackCenter = track.scrollLeft + track.offsetWidth / 2;
          let closestIndex = 0;
          let minDistance = Infinity;
          
          items.forEach((item, index) => {
             const itemCenter = item.offsetLeft + item.offsetWidth / 2;
             const distance = Math.abs(trackCenter - itemCenter);
             if (distance < minDistance) {
                minDistance = distance;
                closestIndex = index;
             }
          });
          
          if (closestIndex === realItemCount) {
             scrollToItem(0, 'auto');
             return;
          }

          if (closestIndex !== currentIndex) {
             currentIndex = closestIndex;
             updateDots(currentIndex);
          }
       }, 50);
    });

    startAutoScroll();
  }

  const tracks = document.querySelectorAll('.ck-carousel__track');
  tracks.forEach(track => {
    if (track.id) {
       initCarousel(track.id);
    }
  });
</script>

<style>
  /* Carousel Logic */
  .ck-carousel__track {
    display: flex;
    gap: var(--space-4);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    padding-bottom: var(--space-4);
    width: 100%;
    scrollbar-width: none; 
    -ms-overflow-style: none;
    position: relative;
  }
  
  .ck-carousel__track::-webkit-scrollbar {
    display: none;
  }

  .ck-carousel__item {
    scroll-snap-align: center;
    flex: 0 0 100%;
    min-width: 0;
    scroll-margin: 0 var(--space-4);
  }

  .ck-carousel__stub {
    width: 100%;
    min-height: 280px;
    display: flex;
    align-items: center;
    justify-content: center;
    color: color-mix(in oklab, var(--color-system-black), transparent 56%);
    background: var(--color-system-cloud);
    border-radius: var(--radius-lg);
  }

  /* Dots Navigation */
  .ck-carousel__dots {
    display: flex;
    justify-content: center;
    gap: var(--space-2);
    margin-top: var(--space-4);
  }

  .ck-carousel__dot {
    width: 8px;
    height: 8px;
    border-radius: 100px;
    background-color: color-mix(in oklab, var(--color-system-black), transparent 80%);
    border: none;
    padding: 0;
    cursor: pointer;
    transition: background-color 0.3s ease, width 0.3s ease;
  }

  .ck-carousel__dot:hover {
     background-color: color-mix(in oklab, var(--color-system-black), transparent 60%);
  }

  .ck-carousel__dot--active {
    background-color: var(--color-system-black);
    width: 24px;
  }
</style>
