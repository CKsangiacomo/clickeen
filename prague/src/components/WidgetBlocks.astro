---
import Cta from '../blocks/cta/cta.astro';
import BigBang from '../blocks/big-bang/big-bang.astro';
import ControlMoat from '../blocks/control-moat/control-moat.astro';
import GlobalMoat from '../blocks/global-moat/global-moat.astro';
import Hero from '../blocks/hero/hero.astro';
import LocaleShowcase from '../blocks/locale-showcase/locale-showcase.astro';
import Minibob from '../blocks/minibob/minibob.astro';
import PlatformStrip from '../blocks/platform-strip/platform-strip.astro';
import Split from '../blocks/split/split.astro';
import SplitCarousel from '../blocks/split-carousel/SplitCarousel.astro';
import Steps from '../blocks/steps/steps.astro';
import SubpageCards from '../blocks/subpage-cards/subpage-cards.astro';
import EmbedCarousel from '../blocks/embed-carousel/embed-carousel.astro';
import FeatureExplorer from '../blocks/feature-explorer/feature-explorer.astro';
import MobileShowcase from '../blocks/mobile-showcase/mobile-showcase.astro';
import WidgetSubnav from '../blocks/site/nav/WidgetSubnav.astro';
import LocalCuratedDrawer from './LocalCuratedDrawer.astro';
import { pragueT } from '../lib/i18n';
import { getPragueMarket } from '../lib/markets';
import {
  chooseOverviewHeroLocales,
  chooseShowcaseTiles,
  localeLabel,
  resolveOverviewHeroNamedLocaleCount,
  resolveTokyoInstanceLocales,
  sortLocaleOptions,
} from '../lib/instanceL10n';

type Block = {
  id: string;
  type: string;
  copy: Record<string, any>;
  visual?: { image?: string };
  links?: any;
  align?: string;
  curatedRef?: { publicId?: string; embedMode?: string };
};

type Props = {
  blocks: Block[];
  widget: string;
  market: string;
  locale: string;
  activeSubpage?: 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
  primaryCta: { label: string; href: string };
};

type CuratedSlot = {
  blockId: string;
  blockType: string;
  target: 'block' | 'item' | 'item-public-id';
  itemIndex?: number;
  label: string;
  currentPublicId: string;
};

type CuratedBlock = {
  blockId: string;
  blockType: string;
  blockIndex: number;
  label: string;
  slots: CuratedSlot[];
};

const { blocks, widget, market, locale, activeSubpage = 'overview', primaryCta } = Astro.props;
const localHosts = new Set(['localhost', '127.0.0.1', '::1']);
const localCuratedDrawerEnabled = import.meta.env.DEV && localHosts.has(Astro.url.hostname);
const hasExplicitLocaleShowcase = blocks.some((b) => b && b.type === 'locale-showcase');
const explicitShowcasePublicId =
  blocks.find((b) => b && b.type === 'locale-showcase' && typeof b.curatedRef?.publicId === 'string')?.curatedRef?.publicId ??
  null;
const showcasePublicId =
  explicitShowcasePublicId ??
  blocks.find((b) => b && b.curatedRef && typeof b.curatedRef.publicId === 'string')?.curatedRef?.publicId ??
  `wgt_main_${widget}`;
const defaultShowcaseTitle = await pragueT(locale, 'prague.localeShowcase.title');
const defaultShowcaseSubtitle = await pragueT(locale, 'prague.localeShowcase.subtitle');
const marketConfig = getPragueMarket(market);

const instanceLocalesRaw = await resolveTokyoInstanceLocales(showcasePublicId).catch(() => null);
const fallbackInstanceLocales = marketConfig?.locales?.length ? marketConfig.locales : ['en', 'es', 'zh-hans', 'ja'];
const instanceLocales = instanceLocalesRaw ? sortLocaleOptions(instanceLocalesRaw) : sortLocaleOptions(fallbackInstanceLocales);
const showcaseTiles = chooseShowcaseTiles(instanceLocales);
const showcaseTileEntries = showcaseTiles.map((code) => ({ code, label: localeLabel(code, locale) }));
const showcaseOptionEntries = instanceLocales.map((code) => ({ code, label: localeLabel(code, locale) }));
const overviewHeroLocalePool = marketConfig?.locales?.length ? marketConfig.locales : instanceLocales;
const overviewHeroNamedLocaleCount = resolveOverviewHeroNamedLocaleCount(marketConfig);
const overviewHeroLocaleSelection = chooseOverviewHeroLocales({
  market: marketConfig,
  instanceLocales: overviewHeroLocalePool,
  max: overviewHeroNamedLocaleCount,
});
const overviewHeroSubheadOne = await pragueT(locale, 'prague.hero.overview.subheadOne');
const overviewHeroSubheadTwo = await pragueT(locale, 'prague.hero.overview.subheadTwo');
const overviewHeroSubheadMany = await pragueT(locale, 'prague.hero.overview.subheadMany');
const heroPrimaryCta = primaryCta;
const OVERVIEW_HERO_TOTAL_LOCALES = 29;

function formatLocaleNameList(labels: string[]): string {
  if (!labels.length) return '';
  if (labels.length === 1) return labels[0] || '';
  return labels.join(', ');
}

function renderOverviewHeroSubheadline(args: { selectedLocales: string[] }): string | null {
  const selected = args.selectedLocales;
  if (selected.length === 0) return null;
  const labels = selected.map((code) => localeLabel(code, locale));
  const lang1 = labels[0] || '';
  const lang2 = labels[1] || '';
  if (selected.length === 1 || !lang2) {
    return overviewHeroSubheadOne.replace('{lang1}', lang1);
  }
  if (selected.length === 2) {
    return overviewHeroSubheadTwo.replace('{lang1}', lang1).replace('{lang2}', lang2);
  }
  const more = Math.max(0, OVERVIEW_HERO_TOTAL_LOCALES - selected.length);
  const trailingLanguages = formatLocaleNameList(labels.slice(1));
  return overviewHeroSubheadMany
    .replace('{lang1}', lang1)
    .replace('{lang2}', trailingLanguages)
    .replace('{more}', String(more));
}

function asPublicId(value: unknown): string {
  return typeof value === 'string' ? value.trim() : '';
}

function hasOwnKey(value: unknown, key: string): boolean {
  if (!value || typeof value !== 'object') return false;
  return Object.prototype.hasOwnProperty.call(value, key);
}

function collectCuratedBlocks(inputBlocks: Block[]): CuratedBlock[] {
  const curatedBlocks: CuratedBlock[] = [];

  inputBlocks.forEach((block, blockIndex) => {
    if (!block || typeof block !== 'object') return;
    const blockId = String(block.id || '').trim();
    const blockType = String(block.type || '').trim();
    if (!blockId || !blockType) return;

    const slots: CuratedSlot[] = [];

    if (hasOwnKey(block, 'curatedRef')) {
      const blockCuratedPublicId = asPublicId((block as any)?.curatedRef?.publicId);
      slots.push({
        blockId,
        blockType,
        target: 'block',
        label: 'Block instance',
        currentPublicId: blockCuratedPublicId,
      });
    }

    const items = Array.isArray((block as any).items) ? ((block as any).items as any[]) : [];
    items.forEach((item, itemIndex) => {
      if (!item || typeof item !== 'object') return;
      if (hasOwnKey(item, 'curatedRef')) {
        const itemPublicId = asPublicId((item as any)?.curatedRef?.publicId);
        const itemTitle = typeof (item as any)?.curatedRef?.title === 'string' ? String((item as any).curatedRef.title).trim() : '';
        const itemLabelSuffix = itemTitle ? ` (${itemTitle})` : '';
        slots.push({
          blockId,
          blockType,
          target: 'item',
          itemIndex,
          label: `Item ${itemIndex + 1}${itemLabelSuffix}`,
          currentPublicId: itemPublicId,
        });
        return;
      }

      if (hasOwnKey(item, 'publicId')) {
        const directPublicId = asPublicId((item as any).publicId);
        slots.push({
          blockId,
          blockType,
          target: 'item-public-id',
          itemIndex,
          label: `Item ${itemIndex + 1}`,
          currentPublicId: directPublicId,
        });
      }
    });

    curatedBlocks.push({
      blockId,
      blockType,
      blockIndex,
      label: `${blockType} block`,
      slots,
    });
  });

  return curatedBlocks;
}

const localCuratedBlocks = collectCuratedBlocks(blocks);
const localCuratedSlotCount = localCuratedBlocks.reduce((sum, block) => sum + block.slots.length, 0);
---

{blocks.map((block) => {
  if (!block || !block.type) return null;
  let rendered: any = null;
  switch (block.type) {
    case 'big-bang': {
      const copy = block.copy ?? {};
      rendered = (
        <BigBang
          headline={String(copy.headline ?? '')}
          body={String(copy.body ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
        />
      );
      break;
    }
    case 'hero': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      const explicitHeroItems = Array.isArray((block as any).items) ? ((block as any).items as any[]) : [];
      const mappedHeroItems = explicitHeroItems.map((item: any) => {
        const itemLocale = typeof item?.curatedRef?.locale === 'string' ? item.curatedRef.locale.trim() : '';
        return {
          ...item,
          curatedRef: item.curatedRef ? { ...item.curatedRef, locale: itemLocale || locale } : item.curatedRef,
        };
      });
      const heroPreviewPublicId = curatedPublicId || showcasePublicId;
      const overviewHeroLocales =
        overviewHeroLocaleSelection.locales.length > 0 ? overviewHeroLocaleSelection.locales : showcaseTiles;
      const autoOverviewHeroItems =
        activeSubpage === 'overview' && mappedHeroItems.length === 0 && heroPreviewPublicId
          ? overviewHeroLocales.map((code) => ({
              curatedRef: {
                publicId: heroPreviewPublicId,
                locale: code,
                title: `${widget} overview ${code}`,
                embedMode: curatedEmbedMode,
              },
            }))
          : [];
      const resolvedHeroItems = mappedHeroItems.length > 0 ? mappedHeroItems : autoOverviewHeroItems;
      const dynamicOverviewSubheadline =
        activeSubpage === 'overview' && mappedHeroItems.length === 0
          ? renderOverviewHeroSubheadline({
              selectedLocales: overviewHeroLocales,
            })
          : null;
      rendered = (
        <Hero
          headline={String(copy.headline ?? '')}
          subheadline={dynamicOverviewSubheadline || String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} hero`, embedMode: curatedEmbedMode }
              : undefined
          }
          items={resolvedHeroItems}
        >
          <WidgetSubnav slot="subnav" market={market} locale={locale} widget={widget} active={activeSubpage} variant="inline" />
        </Hero>
      );
      break;
    }
    case 'split': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      rendered = (
        <Split
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          layout={layout}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} split`, embedMode: curatedEmbedMode }
              : undefined
          }
        />
      );
      break;
    }
    case 'split-carousel': {
      const copy = block.copy ?? {};
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      rendered = (
        <SplitCarousel
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          layout={layout}
          items={((block as any).items ?? []).map((item: any) => {
            const itemLocale = typeof item?.curatedRef?.locale === 'string' ? item.curatedRef.locale.trim() : '';
            return {
              ...item,
              curatedRef: item.curatedRef ? { ...item.curatedRef, locale: itemLocale || locale } : item.curatedRef,
            };
          })}
        />
      );
      break;
    }
    case 'steps': {
      const copy = block.copy ?? {};
      rendered = (
        <Steps
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          steps={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
      break;
    }
    case 'subpage-cards': {
      const copy = block.copy ?? {};
      const links = Array.isArray((block as any).links) ? ((block as any).links as any[]) : [];
      rendered = (
        <SubpageCards
          widget={widget}
          market={market}
          locale={locale}
          title={String(copy.title ?? '')}
          subhead={typeof copy.subhead === 'string' ? copy.subhead : undefined}
          items={(copy.items ?? []) as { title: string; body: string }[]}
          links={links as { page: 'templates' | 'examples' | 'features'; iconName?: string }[]}
        />
      );
      break;
    }
    case 'control-moat': {
      const copy = block.copy ?? {};
      rendered = (
        <ControlMoat
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
      break;
    }
    case 'global-moat': {
      const copy = block.copy ?? {};
      rendered = (
        <GlobalMoat
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
      break;
    }
    case 'platform-strip': {
      const copy = block.copy ?? {};
      rendered = (
        <PlatformStrip
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
      break;
    }
    case 'cta-bottom-block': {
      const copy = block.copy ?? {};
      rendered = (
        <Cta
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
        />
      );
      break;
    }
    case 'minibob': {
      const copy = block.copy ?? {};
      rendered = (
        <>
          <Minibob
            widget={widget}
            locale={locale}
            page={activeSubpage}
            heading={String(copy.heading ?? '')}
            subhead={String(copy.subhead ?? '')}
          />
          {!hasExplicitLocaleShowcase ? (
            <LocaleShowcase
              publicId={showcasePublicId}
              title={defaultShowcaseTitle}
              subtitle={defaultShowcaseSubtitle}
              tiles={showcaseTileEntries}
              options={showcaseOptionEntries}
            />
          ) : null}
        </>
      );
      break;
    }
    case 'locale-showcase': {
      const copy = block.copy ?? {};
      const title = typeof copy.title === 'string' && copy.title.trim() ? String(copy.title) : defaultShowcaseTitle;
      const subtitle =
        typeof copy.subtitle === 'string' && copy.subtitle.trim() ? String(copy.subtitle) : defaultShowcaseSubtitle;
      rendered = (
        <LocaleShowcase
          publicId={showcasePublicId}
          title={title}
          subtitle={subtitle}
          tiles={showcaseTileEntries}
          options={showcaseOptionEntries}
        />
      );
      break;
    }
    case 'embed-carousel': {
      const copy = block.copy ?? {};
      rendered = (
        <EmbedCarousel
          items={(block as any).items ?? []}
          options={(block as any).options ?? {}}
        />
      );
      break;
    }
    case 'mobile-showcase': {
      const copy = block.copy ?? {};
      rendered = (
        <MobileShowcase
          items={(block as any).items ?? []}
          options={(block as any).options ?? {}}
        />
      );
      break;
    }
    case 'feature-explorer': {
      const copy = block.copy ?? {};
      rendered = (
        <FeatureExplorer
          categories={(block as any).categories ?? []}
          options={(block as any).options ?? {}}
        />
      );
      break;
    }
    case 'navmeta':
    case 'page-meta':
      return null;
    default:
      throw new Error(`[prague] No renderer for block type \"${block.type}\"`);
  }

  return rendered;
})}
{localCuratedDrawerEnabled && localCuratedBlocks.length > 0 && localCuratedSlotCount > 0 ? (
  <LocalCuratedDrawer widget={widget} page={activeSubpage} blocks={localCuratedBlocks} />
) : null}
