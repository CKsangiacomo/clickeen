---
import Cta from '../blocks/cta/cta.astro';
import BigBang from '../blocks/big-bang/big-bang.astro';
import ControlMoat from '../blocks/control-moat/control-moat.astro';
import GlobalMoat from '../blocks/global-moat/global-moat.astro';
import Hero from '../blocks/hero/hero.astro';
import LocaleShowcase from '../blocks/locale-showcase/locale-showcase.astro';
import Minibob from '../blocks/minibob/minibob.astro';
import PlatformStrip from '../blocks/platform-strip/platform-strip.astro';
import Split from '../blocks/split/split.astro';
import SplitCarousel from '../blocks/split-carousel/SplitCarousel.astro';
import Steps from '../blocks/steps/steps.astro';
import SubpageCards from '../blocks/subpage-cards/subpage-cards.astro';
import EmbedCarousel from '../blocks/embed-carousel/embed-carousel.astro';
import FeatureExplorer from '../blocks/feature-explorer/feature-explorer.astro';
import MobileShowcase from '../blocks/mobile-showcase/mobile-showcase.astro';
import WidgetSubnav from '../blocks/site/nav/WidgetSubnav.astro';
import { pragueT } from '../lib/i18n';
import { getPragueMarket } from '../lib/markets';
import {
  chooseOverviewHeroLocales,
  chooseShowcaseTiles,
  localeLabel,
  resolveTokyoInstanceLocales,
  sortLocaleOptions,
} from '../lib/instanceL10n';

type Block = {
  id: string;
  type: string;
  copy: Record<string, any>;
  visual?: { image?: string };
  links?: any;
  align?: string;
  curatedRef?: { publicId?: string; embedMode?: string };
};

type Props = {
  blocks: Block[];
  widget: string;
  market: string;
  locale: string;
  activeSubpage?: 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
  primaryCta: { label: string; href: string };
};

const { blocks, widget, market, locale, activeSubpage = 'overview', primaryCta } = Astro.props;
const hasExplicitLocaleShowcase = blocks.some((b) => b && b.type === 'locale-showcase');
const explicitShowcasePublicId =
  blocks.find((b) => b && b.type === 'locale-showcase' && typeof b.curatedRef?.publicId === 'string')?.curatedRef?.publicId ??
  null;
const showcasePublicId =
  explicitShowcasePublicId ??
  blocks.find((b) => b && b.curatedRef && typeof b.curatedRef.publicId === 'string')?.curatedRef?.publicId ??
  `wgt_main_${widget}`;
const defaultShowcaseTitle = await pragueT(locale, 'prague.localeShowcase.title');
const defaultShowcaseSubtitle = await pragueT(locale, 'prague.localeShowcase.subtitle');

const instanceLocalesRaw = await resolveTokyoInstanceLocales(showcasePublicId).catch(() => null);
const instanceLocales = instanceLocalesRaw ? sortLocaleOptions(instanceLocalesRaw) : ['en', 'es', 'ja'];
const showcaseTiles = chooseShowcaseTiles(instanceLocales);
const showcaseTileEntries = showcaseTiles.map((code) => ({ code, label: localeLabel(code, locale) }));
const showcaseOptionEntries = instanceLocales.map((code) => ({ code, label: localeLabel(code, locale) }));
const marketConfig = getPragueMarket(market);
const overviewHeroLocaleSelection = chooseOverviewHeroLocales({ market: marketConfig, instanceLocales, max: 3 });
const overviewHeroSubheadOne = await pragueT(locale, 'prague.hero.overview.subheadOne');
const overviewHeroSubheadTwo = await pragueT(locale, 'prague.hero.overview.subheadTwo');
const overviewHeroSubheadMany = await pragueT(locale, 'prague.hero.overview.subheadMany');
const heroPrimaryCta = primaryCta;

function renderOverviewHeroSubheadline(args: { selectedLocales: string[]; availableCount: number }): string | null {
  const selected = args.selectedLocales;
  if (selected.length === 0) return null;
  const labels = selected.map((code) => localeLabel(code, locale));
  const lang1 = labels[0] || '';
  const lang2 = labels[1] || '';
  const more = Math.max(0, Number(args.availableCount || 0) - selected.length);
  if (selected.length === 1 || !lang2) {
    return overviewHeroSubheadOne.replace('{lang1}', lang1);
  }
  if (more <= 0) {
    return overviewHeroSubheadTwo.replace('{lang1}', lang1).replace('{lang2}', lang2);
  }
  return overviewHeroSubheadMany
    .replace('{lang1}', lang1)
    .replace('{lang2}', lang2)
    .replace('{more}', String(more));
}
---

{blocks.map((block) => {
  if (!block || !block.type) return null;
  switch (block.type) {
    case 'big-bang': {
      const copy = block.copy ?? {};
      return (
        <BigBang
          headline={String(copy.headline ?? '')}
          body={String(copy.body ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
        />
      );
    }
    case 'hero': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      const explicitHeroItems = Array.isArray((block as any).items) ? ((block as any).items as any[]) : [];
      const mappedHeroItems = explicitHeroItems.map((item: any) => {
        const itemLocale = typeof item?.curatedRef?.locale === 'string' ? item.curatedRef.locale.trim() : '';
        return {
          ...item,
          curatedRef: item.curatedRef ? { ...item.curatedRef, locale: itemLocale || locale } : item.curatedRef,
        };
      });
      const heroPreviewPublicId = curatedPublicId || showcasePublicId;
      const overviewHeroLocales =
        overviewHeroLocaleSelection.locales.length > 0 ? overviewHeroLocaleSelection.locales : showcaseTiles;
      const autoOverviewHeroItems =
        activeSubpage === 'overview' && mappedHeroItems.length === 0 && heroPreviewPublicId
          ? overviewHeroLocales.map((code) => ({
              curatedRef: {
                publicId: heroPreviewPublicId,
                locale: code,
                title: `${widget} overview ${code}`,
                embedMode: curatedEmbedMode,
              },
            }))
          : [];
      const resolvedHeroItems = mappedHeroItems.length > 0 ? mappedHeroItems : autoOverviewHeroItems;
      const dynamicOverviewSubheadline =
        activeSubpage === 'overview' && mappedHeroItems.length === 0
          ? renderOverviewHeroSubheadline({
              selectedLocales: overviewHeroLocales,
              availableCount:
                overviewHeroLocaleSelection.availableLocales.length > 0
                  ? overviewHeroLocaleSelection.availableLocales.length
                  : instanceLocales.length,
            })
          : null;
      return (
        <Hero
          headline={String(copy.headline ?? '')}
          subheadline={dynamicOverviewSubheadline || String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} hero`, embedMode: curatedEmbedMode }
              : undefined
          }
          items={resolvedHeroItems}
        >
          <WidgetSubnav slot="subnav" market={market} locale={locale} widget={widget} active={activeSubpage} variant="inline" />
        </Hero>
      );
    }
    case 'split': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      return (
        <Split
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          layout={layout}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} split`, embedMode: curatedEmbedMode }
              : undefined
          }
        />
      );
    }
    case 'split-carousel': {
      const copy = block.copy ?? {};
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      return (
        <SplitCarousel
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={undefined}
          layout={layout}
          items={((block as any).items ?? []).map((item: any) => {
            const itemLocale = typeof item?.curatedRef?.locale === 'string' ? item.curatedRef.locale.trim() : '';
            return {
              ...item,
              curatedRef: item.curatedRef ? { ...item.curatedRef, locale: itemLocale || locale } : item.curatedRef,
            };
          })}
        />
      );
    }
    case 'steps': {
      const copy = block.copy ?? {};
      return (
        <Steps
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          steps={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
    }
    case 'subpage-cards': {
      const copy = block.copy ?? {};
      const links = Array.isArray((block as any).links) ? ((block as any).links as any[]) : [];
      return (
        <SubpageCards
          widget={widget}
          market={market}
          locale={locale}
          title={String(copy.title ?? '')}
          subhead={typeof copy.subhead === 'string' ? copy.subhead : undefined}
          items={(copy.items ?? []) as { title: string; body: string }[]}
          links={links as { page: 'templates' | 'examples' | 'features'; iconName?: string }[]}
        />
      );
    }
    case 'control-moat': {
      const copy = block.copy ?? {};
      return (
        <ControlMoat
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
    }
    case 'global-moat': {
      const copy = block.copy ?? {};
      return (
        <GlobalMoat
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
    }
    case 'platform-strip': {
      const copy = block.copy ?? {};
      return (
        <PlatformStrip
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          items={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
          ctaHref={heroPrimaryCta.href}
        />
      );
    }
    case 'cta-bottom-block': {
      const copy = block.copy ?? {};
      return (
        <Cta
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
        />
      );
    }
    case 'minibob': {
      const copy = block.copy ?? {};
      return (
        <>
          <Minibob
            widget={widget}
            locale={locale}
            page={activeSubpage}
            heading={String(copy.heading ?? '')}
            subhead={String(copy.subhead ?? '')}
          />
          {!hasExplicitLocaleShowcase ? (
            <LocaleShowcase
              publicId={showcasePublicId}
              title={defaultShowcaseTitle}
              subtitle={defaultShowcaseSubtitle}
              tiles={showcaseTileEntries}
              options={showcaseOptionEntries}
            />
          ) : null}
        </>
      );
    }
    case 'locale-showcase': {
      const copy = block.copy ?? {};
      const title = typeof copy.title === 'string' && copy.title.trim() ? String(copy.title) : defaultShowcaseTitle;
      const subtitle =
        typeof copy.subtitle === 'string' && copy.subtitle.trim() ? String(copy.subtitle) : defaultShowcaseSubtitle;
      return (
        <LocaleShowcase
          publicId={showcasePublicId}
          title={title}
          subtitle={subtitle}
          tiles={showcaseTileEntries}
          options={showcaseOptionEntries}
        />
      );
    }
    case 'embed-carousel': {
      const copy = block.copy ?? {};
      return (
        <EmbedCarousel
          items={(block as any).items ?? []}
          options={(block as any).options ?? {}}
        />
      );
    }
    case 'mobile-showcase': {
      const copy = block.copy ?? {};
      return (
        <MobileShowcase
          items={(block as any).items ?? []}
          options={(block as any).options ?? {}}
        />
      );
    }
    case 'feature-explorer': {
      const copy = block.copy ?? {};
      return (
        <FeatureExplorer
          categories={(block as any).categories ?? []}
          options={(block as any).options ?? {}}
        />
      );
    }
    case 'navmeta':
    case 'page-meta':
      return null;
    default:
      throw new Error(`[prague] No renderer for block type \"${block.type}\"`);
  }
})}
