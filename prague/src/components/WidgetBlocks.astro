---
import Cta from '../blocks/cta/cta.astro';
import BigBang from '../blocks/big-bang/big-bang.astro';
import Hero from '../blocks/hero/hero.astro';
import Minibob from '../blocks/minibob/minibob.astro';
import Outcomes from '../blocks/outcomes/outcomes.astro';
import Split from '../blocks/split/split.astro';
import Steps from '../blocks/steps/steps.astro';
import WidgetSubnav from '../blocks/site/nav/WidgetSubnav.astro';
import { pragueT } from '../lib/i18n';
import { resolvePragueHref } from '../lib/links';

type Block = {
  id: string;
  type: string;
  copy: Record<string, any>;
  visual?: boolean;
  align?: string;
  curatedRef?: { publicId?: string };
};

type Props = {
  blocks: Block[];
  widget: string;
  locale: string;
  activeSubpage?: 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
};

const { blocks, widget, locale, activeSubpage = 'overview' } = Astro.props;
const personalization = activeSubpage === 'overview' ? { widget, page: activeSubpage, locale } : null;
const hasMinibob = blocks.some((b) => b && b.type === 'minibob');
const createFreeLabel = await pragueT(locale, 'prague.cta.createFree');
const seeTemplatesLabel = await pragueT(locale, 'prague.cta.seeTemplates');
const heroPrimaryCta = {
  label: createFreeLabel,
  href: hasMinibob ? '#minibob' : `/${locale}/create`,
};
const heroSecondaryCta =
  activeSubpage === 'overview'
    ? {
        label: seeTemplatesLabel,
        href: resolvePragueHref({ href: '/widgets/{widget}/templates', locale, widget }),
      }
    : undefined;
---

{blocks.map((block) => {
  if (!block || !block.type) return null;
  switch (block.type) {
    case 'big-bang': {
      const copy = block.copy ?? {};
      return (
        <BigBang
          headline={String(copy.headline ?? '')}
          body={String(copy.body ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
        />
      );
    }
    case 'hero': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      return (
        <Hero
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} hero` }
              : undefined
          }
          personalization={personalization ?? undefined}
        >
          <WidgetSubnav slot="subnav" locale={locale} widget={widget} active={activeSubpage} variant="inline" />
        </Hero>
      );
    }
    case 'split': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      return (
        <Split
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
          layout={layout}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} split` }
              : undefined
          }
        />
      );
    }
    case 'steps': {
      const copy = block.copy ?? {};
      return <Steps title={copy.title as string} subhead={copy.subhead as string} steps={(copy.items ?? []) as { title: string; body: string }[]} />;
    }
    case 'cta': {
      const copy = block.copy ?? {};
      return (
        <Cta
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
        />
      );
    }
    case 'minibob': {
      const copy = block.copy ?? {};
      return <Minibob widget={widget} locale={locale} heading={String(copy.heading ?? '')} subhead={String(copy.subhead ?? '')} />;
    }
    case 'outcomes': {
      const copy = block.copy ?? {};
      return <Outcomes title={copy.title as string} items={(copy.items ?? []) as { title: string; body: string; eyebrow?: string }[]} />;
    }
    case 'navmeta':
    case 'page-meta':
      return null;
    default:
      throw new Error(`[prague] No renderer for block type \"${block.type}\"`);
  }
})}
