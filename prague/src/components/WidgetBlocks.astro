---
import Cta from '../blocks/cta/cta.astro';
import BigBang from '../blocks/big-bang/big-bang.astro';
import Hero from '../blocks/hero/hero.astro';
import LocaleShowcase from '../blocks/locale-showcase/locale-showcase.astro';
import Minibob from '../blocks/minibob/minibob.astro';
import Split from '../blocks/split/split.astro';
import Steps from '../blocks/steps/steps.astro';
import WidgetSubnav from '../blocks/site/nav/WidgetSubnav.astro';
import { pragueT } from '../lib/i18n';
import { resolvePragueHref } from '../lib/links';
import { chooseShowcaseTiles, localeLabel, resolveTokyoInstanceLocales, sortLocaleOptions } from '../lib/instanceL10n';

type Block = {
  id: string;
  type: string;
  copy: Record<string, any>;
  visual?: { image?: string };
  align?: string;
  curatedRef?: { publicId?: string; embedMode?: string };
};

type Props = {
  blocks: Block[];
  widget: string;
  market: string;
  locale: string;
  activeSubpage?: 'overview' | 'templates' | 'examples' | 'features' | 'pricing';
};

const { blocks, widget, market, locale, activeSubpage = 'overview' } = Astro.props;
const personalization = activeSubpage === 'overview' ? { widget, page: activeSubpage, locale } : null;
const hasMinibob = blocks.some((b) => b && b.type === 'minibob');
const showcasePublicId =
  blocks.find((b) => b && b.curatedRef && typeof b.curatedRef.publicId === 'string')?.curatedRef?.publicId ??
  `wgt_main_${widget}`;

// Helper to title-case widget name (faq -> FAQ, countdown -> Countdown)
const titleCaseWidget = (name: string): string => {
  return name
    .split('-')
    .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
    .join(' ');
};

const widgetDisplayName = titleCaseWidget(widget);
const createFreeLabel = `Create a free ${widgetDisplayName} widget`;
const seeTemplatesLabel = await pragueT(locale, 'prague.cta.seeTemplates');
const showcaseTitle = await pragueT(locale, 'prague.localeShowcase.title');
const showcaseSubtitle = await pragueT(locale, 'prague.localeShowcase.subtitle');

const instanceLocalesRaw = await resolveTokyoInstanceLocales(showcasePublicId).catch(() => null);
const instanceLocales = instanceLocalesRaw ? sortLocaleOptions(instanceLocalesRaw) : ['en', 'es', 'ja'];
const showcaseTiles = chooseShowcaseTiles(instanceLocales);
const showcaseOptions = instanceLocales.map((code) => ({ code, label: localeLabel(code, locale) }));
const showcaseTileEntries = showcaseTiles.map((code) => ({ code, label: localeLabel(code, locale) }));
const heroPrimaryCta = {
  label: createFreeLabel,
  href: hasMinibob ? '#minibob' : `/${market}/${locale}/create`,
};
const heroSecondaryCta =
  activeSubpage === 'overview'
    ? {
        label: seeTemplatesLabel,
        href: resolvePragueHref({ href: '/widgets/{widget}/templates', market, locale, widget }),
      }
    : undefined;
---

{blocks.map((block) => {
  if (!block || !block.type) return null;
  switch (block.type) {
    case 'big-bang': {
      const copy = block.copy ?? {};
      return (
        <BigBang
          headline={String(copy.headline ?? '')}
          body={String(copy.body ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
        />
      );
    }
    case 'hero': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      return (
        <Hero
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} hero`, embedMode: curatedEmbedMode }
              : undefined
          }
          personalization={personalization ?? undefined}
        >
          <WidgetSubnav slot="subnav" market={market} locale={locale} widget={widget} active={activeSubpage} variant="inline" />
        </Hero>
      );
    }
    case 'split': {
      const copy = block.copy ?? {};
      const curatedPublicId = block.curatedRef?.publicId;
      const curatedEmbedModeRaw =
        block.curatedRef && typeof block.curatedRef.embedMode === 'string' ? String(block.curatedRef.embedMode) : '';
      const curatedEmbedMode = curatedEmbedModeRaw.trim() === 'indexable' ? 'indexable' : undefined;
      const layout = typeof (block as any).layout === 'string' ? (block as any).layout : '';
      return (
        <Split
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
          secondaryCta={heroSecondaryCta}
          layout={layout}
          curatedRef={
            curatedPublicId
              ? { publicId: curatedPublicId, locale, title: `${widget} ${activeSubpage} split`, embedMode: curatedEmbedMode }
              : undefined
          }
        />
      );
    }
    case 'steps': {
      const copy = block.copy ?? {};
      return (
        <Steps
          widget={widget}
          title={copy.title as string}
          subhead={copy.subhead as string}
          steps={(copy.items ?? []) as { title: string; body: string; icon?: string }[]}
          visual={block.visual}
        />
      );
    }
    case 'cta-bottom-block': {
      const copy = block.copy ?? {};
      return (
        <Cta
          headline={String(copy.headline ?? '')}
          subheadline={String(copy.subheadline ?? '')}
          primaryCta={heroPrimaryCta}
        />
      );
    }
    case 'minibob': {
      const copy = block.copy ?? {};
      return (
        <>
          <Minibob widget={widget} locale={locale} heading={String(copy.heading ?? '')} subhead={String(copy.subhead ?? '')} />
          <LocaleShowcase
            publicId={showcasePublicId}
            title={showcaseTitle}
            subtitle={showcaseSubtitle}
            tiles={showcaseTileEntries}
            options={showcaseOptions}
          />
        </>
      );
    }
    case 'navmeta':
    case 'page-meta':
      return null;
    default:
      throw new Error(`[prague] No renderer for block type \"${block.type}\"`);
  }
})}
