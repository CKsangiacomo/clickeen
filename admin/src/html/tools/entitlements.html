<style>
  .entitlements-section {
    margin-top: 24px;
  }

  .entitlements-table {
    width: 100%;
    border-collapse: collapse;
    table-layout: fixed;
  }

  .entitlements-table__tier {
    width: 56px;
  }

  .entitlements-table__cap-col {
    width: 180px;
  }

  .entitlements-table__token-col {
    width: 200px;
  }

  .entitlements-table__desc-col {
    width: 320px;
  }

  .entitlements-table th,
  .entitlements-table td {
    text-align: left;
    vertical-align: top;
    padding: 6px 12px 6px 0;
    border-bottom: 1px solid var(--role-border);
  }

  .entitlements-table th {
    white-space: nowrap;
  }

  .entitlements-table__token {
    font-family: var(--font-mono);
    white-space: nowrap;
    font-size: var(--fs-10);
  }

  .entitlements-table__token-head {
    font-size: var(--fs-10);
  }

  .entitlements-table__value {
    font-family: var(--font-mono);
  }

  .entitlements-table__desc {
    color: color-mix(in oklab, var(--color-text), transparent 35%);
  }

  .entitlements-table__capability {
    font-weight: 500;
  }
</style>

<h1 class="heading-2">Entitlements Matrix</h1>

<section class="devstudio-page-section" id="entitlements-root" aria-live="polite"></section>

<script type="module">
  const root = document.getElementById('entitlements-root');
  const matrix = window.__CK_ENTITLEMENTS__;
  const meta = window.__CK_ENTITLEMENTS_META__ || {};

  if (!root || !matrix) {
    const error = document.createElement('p');
    error.className = 'body-s';
    error.textContent = 'Missing entitlements data. Ensure @clickeen/ck-policy is available in DevStudio build.';
    root?.appendChild(error);
  } else {
    const tiers = matrix.tiers;
    const groups = {
      flag: [],
      cap: [],
      budget: [],
    };

    Object.entries(matrix.capabilities).forEach(([key, cap]) => {
      groups[cap.kind]?.push({ key, cap });
    });

    const renderTable = (title, entries) => {
      const section = document.createElement('section');
      section.className = 'devstudio-page-section entitlements-section';

      const heading = document.createElement('h2');
      heading.className = 'heading-3';
      heading.textContent = title;
      section.appendChild(heading);

      const table = document.createElement('table');
      table.className = 'body-s entitlements-table';

      const colgroup = document.createElement('colgroup');
      const colCapability = document.createElement('col');
      colCapability.className = 'entitlements-table__cap-col';
      const colDesc = document.createElement('col');
      colDesc.className = 'entitlements-table__desc-col';
      colgroup.append(colCapability, colDesc);
      tiers.forEach(() => {
        const col = document.createElement('col');
        col.className = 'entitlements-table__tier';
        colgroup.appendChild(col);
      });
      const colToken = document.createElement('col');
      colToken.className = 'entitlements-table__token-col';
      colgroup.appendChild(colToken);
      table.appendChild(colgroup);

      const thead = document.createElement('thead');
      const headRow = document.createElement('tr');

      const capHeader = document.createElement('th');
      capHeader.textContent = 'Capability';
      capHeader.className = 'label-s';
      headRow.appendChild(capHeader);

      const descHeader = document.createElement('th');
      descHeader.textContent = 'Description';
      descHeader.className = 'label-s';
      headRow.appendChild(descHeader);

      tiers.forEach((tier) => {
        const th = document.createElement('th');
        th.textContent = tier.replace(/\b\w/g, (c) => c.toUpperCase());
        th.className = 'label-s';
        headRow.appendChild(th);
      });

      const tokenHeader = document.createElement('th');
      tokenHeader.textContent = 'Token';
      tokenHeader.className = 'label-s entitlements-table__token-head';
      headRow.appendChild(tokenHeader);

      thead.appendChild(headRow);
      table.appendChild(thead);

      const tbody = document.createElement('tbody');
      entries.forEach(({ key, cap }) => {
        const row = document.createElement('tr');

        const metaEntry = meta[key] || { label: key, description: '' };

        const nameCell = document.createElement('td');
        nameCell.textContent = metaEntry.label || key;
        nameCell.className = 'body-s entitlements-table__capability';
        row.appendChild(nameCell);

        const descCell = document.createElement('td');
        descCell.textContent = metaEntry.description || '';
        descCell.className = 'body-s entitlements-table__desc';
        row.appendChild(descCell);

        tiers.forEach((tier) => {
          const valueCell = document.createElement('td');
          const value = cap.values[tier];
          let display = String(value);
          if (cap.kind === 'flag') display = value ? '✓' : '✗';
          if (value === null) display = '∞';
          valueCell.textContent = display;
          valueCell.className = 'body-s entitlements-table__value';
          row.appendChild(valueCell);
        });

        const tokenCell = document.createElement('td');
        tokenCell.textContent = key;
        tokenCell.className = 'body-s entitlements-table__token';
        row.appendChild(tokenCell);

        tbody.appendChild(row);
      });

      table.appendChild(tbody);
      section.appendChild(table);
      return section;
    };

    root.appendChild(renderTable('Flags', groups.flag));
    root.appendChild(renderTable('Caps', groups.cap));
    root.appendChild(renderTable('Budgets', groups.budget));
  }
</script>
