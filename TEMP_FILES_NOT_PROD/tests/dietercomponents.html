<!doctype html>
<!--
INTERNAL NOTE · Dieter preview harness
This file exists only to mount Dieter tokens/components in isolation for internal inspection.
Do not add custom styling, overrides, or component affordances here—everything rendered in the iframe must come directly from the Dieter packages so the output stays production-accurate.
The inline CSS below is limited to the preview chrome (nav, layout) and temporary helpers that read existing tokens (e.g. the dark-theme attribute fallback).
-->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dieter Components · Preview</title>

    <!-- Tokens -->
    <link rel="stylesheet" href="../dieter/tokens/tokens.css" />

    <style>
      :root { color-scheme: light; }
      html, body { height: 100%; }
      * { box-sizing: border-box; }
      body {
        margin: 0;
        font-family: "Inter Tight", "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", Arial, sans-serif;
        color: var(--color-text, #212121);
        background: color-mix(in oklab, var(--color-surface, #f6f7f9), white 50%);
      }
      .app {
        display: grid;
        grid-template-columns: 280px 1fr;
        min-height: 100%;
      }
      .rail {
        /* remove strokes; pure white */
        padding: 16px;
        background: #ffffff;
      }
      .rail h1 { margin: 0 0 12px; font: 700 14px/1 var(--font-ui); letter-spacing: .08em; text-transform: uppercase; }
      .rail ul { list-style: none; padding: 0; margin: 0; display: grid; gap: 4px; }
      .rail button.item {
        width: 100%;
        text-align: left;
        padding: 8px 10px;
        border: 0;
        background: transparent;
        border-radius: 8px;
        cursor: pointer;
        font: 500 13px/1.4 var(--font-ui);
        color: color-mix(in oklab, var(--color-text, #111), transparent 15%);
      }
      .rail button.item:hover { background: color-mix(in oklab, var(--color-surface,#f6f7f9), var(--color-text,#111) 6%); }
      .rail button.item[aria-current="true"] { background: color-mix(in oklab, var(--color-surface,#f6f7f9), var(--color-text,#111) 8%); }
      .rail li.divider { margin: 12px 0; height: 1px; background: rgba(0,0,0,0.1); border-radius: 999px; }

      .main { padding: 24px; display: grid; gap: 16px; min-height: 100%; grid-template-rows: 1fr; }
      .section { background: transparent; border: none; border-radius: 12px; display:grid; grid-template-rows: auto auto 1fr; gap: 12px; }
      .section h2 { margin: 0 0 8px; padding: 0 2px; font: 700 12px/1 var(--font-ui); letter-spacing: .08em; text-transform: uppercase; color: color-mix(in oklab, var(--color-text,#111), transparent 30%); }
      .section .content { padding: 0; display:grid; }

      /* Toolbar */
      .toolbar { display: flex; align-items: center; gap: 8px; margin-bottom: 8px; }
      .seg { display: inline-flex; border-radius: 10px; background: #ffffff; box-shadow: 0 1px 2px rgba(0,0,0,.04); }
      .seg button { border: 0; background: transparent; padding: 6px 10px; cursor: pointer; font: 500 12px/1 var(--font-ui); color: rgba(0,0,0,.65); }
      .seg button[aria-pressed="true"] { background: #f0f3f8; color: #111; border-radius: 10px; }

      /* Iframe preview wrapper (edge-to-edge, no strokes) */
      .iframe-wrap { background: transparent; border-radius: 0; padding: 0; min-height: 0; display: grid; }
      #preview-frame { width: 100%; height: 100%; min-height: 0; border: 0; border-radius: 0; background: transparent; }

      .grid { display: grid; gap: 16px; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); align-items: end; }
      .sample { display: grid; gap: 10px; justify-items: center; text-align: center; }
      .sample strong { font: 600 12px/1 var(--font-ui); color: color-mix(in oklab, var(--color-text,#111), transparent 35%); text-transform: uppercase; letter-spacing: .08em; }
      .sample p { margin: 0; font: 400 12px/1.2 var(--font-ui); color: color-mix(in oklab, var(--color-text,#111), transparent 50%); }

      /* (legacy split layout removed) */

      /* Dieter component CSS links injected at runtime */
    </style>
  </head>
  <body>
    <div class="app">
      <nav class="rail">
        <h1>Dieter • Components</h1>
        <ul id="list"></ul>
      </nav>
      <main class="main">
        <section class="section">
          <div class="toolbar">
            <div class="seg" role="group" aria-label="Color scheme">
              <button type="button" id="btn-light" aria-pressed="true">Light</button>
              <button type="button" id="btn-dark" aria-pressed="false">Dark</button>
            </div>
          </div>
          <h2 id="title">Select a component</h2>
          <div class="content">
            <div class="iframe-wrap">
              <iframe id="preview-frame" title="Dieter Preview" sandbox="allow-same-origin"></iframe>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      // Component catalog derived from dieter/components/*.css
      const components = [
        { id: 'button', css: 'button.css' },
        { id: 'segmented', css: 'segmented.css' },
        { id: '__divider__', css: null },
        { id: 'type', css: null },
        { id: 'color', css: null }
      ];

      // Known preview/renderers (type + button + segmented)
      const previews = {
        type: {
          css: [],
          render(container) {
            const weights = [100,200,300,400,500,600,700,800,900];
            const names = {100:'Thin',200:'ExtraLight',300:'Light',400:'Regular',500:'Medium',600:'SemiBold',700:'Bold',800:'ExtraBold',900:'Black'};
            const defaultText = 'Whereas recognition of the inherent dignity';
            container.innerHTML = `
              <div class=\"ty-toolbar\">
                <input id=\"ty-input\" class=\"ty-input\" placeholder=\"Type here to preview text\" value=\"${defaultText}\" />
                <input id=\"ty-size\" class=\"ty-size\" type=\"range\" min=\"10\" max=\"48\" step=\"1\" value=\"16\" />
                <span id=\"ty-size-label\" class=\"ty-size-label\">16px</span>
              </div>
              <div id=\"ty-list\" class=\"ty-list\"></div>
            `;
            const input = container.querySelector('#ty-input');
            const size = container.querySelector('#ty-size');
            const sizeLabel = container.querySelector('#ty-size-label');
            const list = container.querySelector('#ty-list');
            function renderRows(){
              const txt = input.value || defaultText;
              const px = Number(size.value)||16;
              sizeLabel.textContent = px + 'px';
              list.innerHTML = weights.map(w => `
                <div class=\"ty-row\"> 
                  <div class=\"ty-name\">${names[w]} ${w}</div>
                  <div style=\"font-family:var(--font-ui); font-weight:${w}; font-size:${px}px;\">${txt}</div>
                  <div style=\"font-family:var(--font-ui); font-weight:${w}; font-style:italic; font-size:${px}px; opacity:.85\">${txt}</div>
                </div>`).join('');
            }
            input.addEventListener('input', renderRows);
            size.addEventListener('input', renderRows);
            size.addEventListener('change', renderRows);
            renderRows();
          }
        },
        color: {
          css: [],
          render(container) {
            const doc = container.ownerDocument;
            const html = doc.documentElement;

            const readTokenValue = (theme, token) => {
              const previous = html.getAttribute('data-theme');
              html.setAttribute('data-theme', theme === 'dark' ? 'dark' : 'light');
              const style = doc.defaultView.getComputedStyle(html);
              const value = style.getPropertyValue(token).trim();
              if (previous === null) html.removeAttribute('data-theme'); else html.setAttribute('data-theme', previous);
              return value && !/^#?(?:0{3,6}|f{3,6})$/i.test(value) ? normalizeHex(value) : null;
            };

            const palette = {
              red:    { label: 'Red',    token: '--color-system-red',    light: '#FF3B30', dark: '#FF453A' },
              orange: { label: 'Orange', token: '--color-system-orange', light: '#FF9500', dark: '#FF9F0A' },
              yellow: { label: 'Yellow', token: '--color-system-yellow', light: '#FFCC00', dark: '#FFD60A' },
              green:  { label: 'Green',  token: '--color-system-green',  light: '#34C759', dark: '#30D158' },
              mint:   { label: 'Mint',   token: '--color-system-mint',   light: '#00C7BE', dark: '#00D3A7' },
              teal:   { label: 'Teal',   token: '--color-system-teal',   light: '#30B0C7', dark: '#40C8E0' },
              cyan:   { label: 'Cyan',   token: '--color-system-cyan',   light: '#32ADE6', dark: '#64D2FF' },
              blue:   { label: 'Blue',   token: '--color-system-blue',   light: '#007AFF', dark: '#0A84FF' },
              indigo: { label: 'Indigo', token: '--color-system-indigo', light: '#5856D6', dark: '#5E5CE6' },
              purple: { label: 'Purple', token: '--color-system-purple', light: '#AF52DE', dark: '#BF5AF2' },
              pink:   { label: 'Pink',   token: '--color-system-pink',   light: '#FF2D55', dark: '#FF375F' },
              brown:  { label: 'Brown',  token: '--color-system-brown',  light: '#A2845E', dark: '#AC8E68' },
              systemGray:  { label: 'Gray',    token: '--color-system-gray',   light: '#8E8E93', dark: '#8E8E93' },
              systemGray2: { label: 'Gray 2',  token: '--color-system-gray-2', light: '#AEAEB2', dark: '#636366' },
              systemGray3: { label: 'Gray 3',  token: '--color-system-gray-3', light: '#C7C7CC', dark: '#48484A' },
              systemGray4: { label: 'Gray 4',  token: '--color-system-gray-4', light: '#D1D1D6', dark: '#3A3A3C' },
              systemGray5: { label: 'Gray 5',  token: '--color-system-gray-5', light: '#E5E5EA', dark: '#2C2C2E' },
              systemGray6: { label: 'Gray 6',  token: '--color-system-gray-6', light: '#F2F2F7', dark: '#1C1C1E' }
            };

            const contrastAmount = 0.25;
            const derivedPerc = [
              { suffix: '1', ratio: 0.20 },
              { suffix: '2', ratio: 0.40 },
              { suffix: '3', ratio: 0.60 },
              { suffix: '4', ratio: 0.80 },
              { suffix: '5', ratio: 0.90 }
            ];

            const keysSpectrum = ['red','orange','yellow','green','mint','teal','cyan','blue','indigo','purple','pink','brown'];
            const keysNeutrals = ['systemGray','systemGray2','systemGray3','systemGray4','systemGray5','systemGray6'];

            const readBase = (def, theme) => {
              const fallback = (theme === 'dark' ? def.dark : def.light).toUpperCase();
              const value = readTokenValue(theme, def.token);
              if (!value) return fallback;
              const upper = value.toUpperCase();
              if ((upper === '#FFFFFF' || upper === '#000000') && upper != fallback) return fallback;
              return upper;
            };

            const buildRow = (key) => {
              const def = palette[key];
              const light = readBase(def, 'light');
              const dark = readBase(def, 'dark');
              const contrastLight = mixColors(light, '#000000', contrastAmount);
              const contrastDark = mixColors(dark, '#FFFFFF', contrastAmount);
              const derivedLight = derivedPerc.map(p => mixColors(light, '#FFFFFF', p.ratio));
              const derivedDark = derivedPerc.map(p => mixColors(mixColors(dark, '#000000', p.ratio), '#FFFFFF', 0.06));
              return {
                label: def.label,
                token: def.token,
                key,
                light,
                dark,
                contrastLight,
                contrastDark,
                derivedLight,
                derivedDark
              };
            };

            const spectrumRows = keysSpectrum.map(buildRow);
            const neutralRows = keysNeutrals.map(buildRow);

            const derivedHeaders = derivedPerc.map(p => `<div>${Math.round((1 - p.ratio) * 100)}%<br>.${p.suffix}</div>`).join('');
            const derivedHeadersDark = derivedPerc.map(p => `<div>${Math.round((1 - p.ratio) * 100)}% d<br>.${p.suffix}d</div>`).join('');

            const headerRow = `
              <div class="color-row color-header-row">
                <div>Token</div>
                <div>Default (Light)</div>
                <div>Default (Dark)</div>
                <div>Contrast (Light)</div>
                <div>Contrast (Dark)</div>
                ${derivedHeaders}
                ${derivedHeadersDark}
              </div>`;

            const buildCells = (row) => {
              const base = [
                colorCell('light', row.light),
                colorCell('dark', row.dark),
                colorCell('contrast', row.contrastLight),
                colorCell('contrast d', row.contrastDark)
              ];
              const lights = row.derivedLight.map((hex, idx) => colorCell(`${row.key}.${idx + 1}`, hex));
              const darks = row.derivedDark.map((hex, idx) => colorCell(`${row.key}.${idx + 1}d`, hex));
              return [...base, ...lights, ...darks].join('');
            };

            const buildRowHtml = (row) => `
              <div class="color-row">
                <div class="color-name">
                  <div>${row.label}</div>
                  <div class="color-token">${row.token}</div>
                </div>
                ${buildCells(row)}
              </div>`;

            container.innerHTML = `
              <div class="color-table">
                ${headerRow}
                <div class="color-group-title">Spectrum</div>
                ${spectrumRows.map(buildRowHtml).join('')}
                <div class="color-group-title">Neutrals</div>
                ${neutralRows.map(buildRowHtml).join('')}
              </div>`;
          }
        },
        button: {
          css: ['button.css'],
          render(container) {
            const variants = [
              { key: 'primary', label: 'Primary' },
              { key: 'secondary', label: 'Secondary' },
              { key: 'neutral', label: 'Neutral' },
              { key: 'line1', label: 'Line 1' },
              { key: 'line2', label: 'Line 2' }
            ];
            const types = [
              { key: 'ic', label: 'Icon' },
              { key: 'ictxt', label: 'Icon + Text' },
              { key: 'txt', label: 'Text' }
            ];
            const sizes = ['xs','sm','md','lg'];
            const sizeMeta = {
              xs: { label: 'Xsmall' },
              sm: { label: 'Small' },
              md: { label: 'Medium' },
              lg: { label: 'Large' }
            };
            const typeTokens = {
              ictxt: 'class="diet-btn"',
              ic: 'class="diet-btn" · data-footprint="icon-only"',
              txt: 'class="diet-btn" · data-footprint="text-only"'
            };

            const sections = types.map(type => {
              const rows = variants.map(variant => {
                const sizeCols = sizes.map(size => {
                  const meta = sizeMeta[size];
                  const btnLabel = type.key === 'txt' ? meta.label : `${meta.label} Button`;
                  const footprint = type.key === 'ic'
                    ? ` data-footprint="icon-only" aria-label="${variant.label} ${meta.label} icon"`
                    : type.key === 'txt'
                      ? ' data-footprint="text-only"'
                      : '';
                  return `
                    <div class="button-cell button-cell--size">
                      <div class="button-cell-content">
                        <div class="button-copy">
                          <div class="button-meta button-meta--size">${meta.label}</div>
                          <div class="button-attr">class:diet-btn</div>
                          <div class="button-attr">size:${size}</div>
                          <div class="button-attr">variant:${variant.key}</div>
                        </div>
                        <div class="button-visual">
                          <button class="diet-btn" data-size="${size}" data-variant="${variant.key}"${footprint}>
                            ${type.key !== 'txt' ? `<span class="diet-btn__icon">${sunSvg()}</span>` : ''}
                            ${type.key !== 'ic' ? `<span class="diet-btn__label">${btnLabel}</span>` : ''}
                          </button>
                        </div>
                      </div>
                    </div>`;
                }).join('');

                return `
                  <div class="button-row">
                    <div class="button-cell button-cell--variant-name">${variant.label}</div>
                    ${sizeCols}
                  </div>`;
              }).join('');

              return `
                <section class="button-section">
                  <header class="button-section-head">${type.label}</header>
                  ${rows}
                </section>`;
            }).join('');

            container.innerHTML = `<div class="button-table">${sections}</div>`;
          }
        },
        segmented: {
          css: ['segmented.css'],
          render(container) {
            let groupCounter = 0;

            const sizeSlots = [
              { key: 'small', label: 'Small · 20px rail', sizeAttr: '' },
              { key: 'medium', label: 'Medium · 24px rail', sizeAttr: 'md' },
              { key: 'large', label: 'Large · 28px rail', sizeAttr: 'lg' }
            ];

            const variants = [
              {
                heading: 'Icon only',
                footprint: 'icon-only',
                content: 'Icons',
                build(sizeKey, sizeAttr) {
                  const groupName = `seg-icon-${sizeKey}-${groupCounter++}`;
                  return `
                    <div class="diet-segmented"${sizeAttr ? ` data-size="${sizeAttr}"` : ''} role="radiogroup" aria-label="Theme toggle (${sizeKey})">
                      ${buildSegment({ groupName, value: 'light', checked: true, footprint: 'icon-only', iconActive: sunGlyph(), iconInactive: moonGlyph(), sr: 'Light theme' })}
                      ${buildSegment({ groupName, value: 'dark', checked: false, footprint: 'icon-only', iconActive: moonGlyph(), iconInactive: sunGlyph(), sr: 'Dark theme' })}
                    </div>`;
                }
              },
              {
                heading: 'Icon + text',
                footprint: 'icon+text',
                content: 'Icon + labels',
                build(sizeKey, sizeAttr) {
                  const groupName = `seg-icon-text-${sizeKey}-${groupCounter++}`;
                  return `
                    <div class="diet-segmented"${sizeAttr ? ` data-size="${sizeAttr}"` : ''} role="radiogroup" aria-label="Mode (${sizeKey})">
                      ${buildSegment({ groupName, value: 'day', checked: true, iconActive: sunGlyph(), iconInactive: sunGlyph(), label: 'Day', footprint: '', sr: 'Day mode' })}
                      ${buildSegment({ groupName, value: 'night', checked: false, iconActive: moonGlyph(), iconInactive: moonGlyph(), label: 'Night', footprint: '', sr: 'Night mode' })}
                      ${buildSegment({ groupName, value: 'auto', checked: false, iconActive: autoGlyph(), iconInactive: autoGlyph(), label: 'Auto', footprint: '', sr: 'Automatic mode' })}
                    </div>`;
                }
              },
              {
                heading: 'Text only',
                footprint: 'text-only',
                content: 'Labels',
                build(sizeKey, sizeAttr) {
                  const groupName = `seg-text-${sizeKey}-${groupCounter++}`;
                  return `
                    <div class="diet-segmented"${sizeAttr ? ` data-size="${sizeAttr}"` : ''} role="radiogroup" aria-label="Alignment (${sizeKey})">
                      ${buildSegment({ groupName, value: 'left', checked: true, label: 'Left', footprint: 'text-only', sr: 'Align left' })}
                      ${buildSegment({ groupName, value: 'center', checked: false, label: 'Center', footprint: 'text-only', sr: 'Align center' })}
                      ${buildSegment({ groupName, value: 'right', checked: false, label: 'Right', footprint: 'text-only', sr: 'Align right' })}
                    </div>`;
                }
              }
            ];

            const sections = variants.map(variant => {
              const sizeCells = sizeSlots.map(slot => {
                const control = variant.build(slot.key, slot.sizeAttr);
                return `
                  <div class="button-cell button-cell--size">
                    <div class="button-cell-content">
                      <div class="button-copy">
                        <div class="button-meta button-meta--size">${slot.label}</div>
                        <div class="button-attr">class:diet-segmented</div>
                        <div class="button-attr">footprint:${variant.footprint}</div>
                        <div class="button-attr">content:${variant.content}</div>
                        ${slot.sizeAttr ? `<div class="button-attr">data-size:${slot.sizeAttr}</div>` : ''}
                      </div>
                      <div class="button-visual">
                        ${control}
                      </div>
                    </div>
                  </div>
                `;
              }).join('');

              return `
                <section class="button-section">
                  <header class="button-section-head">${variant.heading}</header>
                  <div class="button-row">
                    <div class="button-cell button-cell--variant-name">Sizes</div>
                    ${sizeCells}
                  </div>
                </section>
              `;
            }).join('');

            container.innerHTML = `<div class="button-table">${sections}</div>`;

            function buildSegment({ groupName, value, checked, footprint = '', iconActive = '', iconInactive = '', label = '', sr }) {
              const footprintAttr = footprint ? ` data-footprint="${footprint}"` : '';
              return `
                <label class="diet-segment"${footprintAttr}>
                  <input class="diet-segment__input" type="radio" name="${groupName}" value="${value}" ${checked ? 'checked' : ''}>
                  <span class="diet-segment__surface"></span>
                  ${iconActive ? `<span class="diet-segment__icon diet-segment__icon--active">${iconActive}</span>` : ''}
                  ${iconInactive ? `<span class="diet-segment__icon diet-segment__icon--inactive">${iconInactive}</span>` : ''}
                  ${label ? `<span class="diet-segment__label diet-segment__label--active">${label}</span><span class="diet-segment__label diet-segment__label--inactive">${label}</span>` : ''}
                  <span class="diet-segment__sr">${sr}</span>
                </label>`;
            }
          },
        },
      };

      // Iframe + theme helpers (preview-only)
      const frame = document.getElementById('preview-frame');
      let frameReady = false;
      let frameCssReady = Promise.resolve();
      let darkStyleText = null; // cache extracted dark tokens block

      function buildFrameDoc() {
        const doc = frame.contentDocument;
        doc.open();
        doc.write(`<!doctype html><html><head>
          <meta charset=\"utf-8\"/>
          <link rel=\"preconnect\" href=\"https://fonts.googleapis.com\">
          <link rel=\"preconnect\" href=\"https://fonts.gstatic.com\" crossorigin>
          <link href=\"https://fonts.googleapis.com/css2?family=Inter+Tight:ital,wght@0,100..900;1,100..900&display=swap\" rel=\"stylesheet\">
          <link rel=\"stylesheet\" href=\"../dieter/tokens/tokens.css\"/>
          ${components.filter(c => c.css).map(c => `<link rel=\"stylesheet\" href=\"../dieter/components/${c.css}\"/>`).join('')}
          <style>
            body{margin:0;padding:24px;font-family:var(--font-ui);color:var(--color-text);background:var(--color-bg);} 
            .container{width:100%;margin:0}
            .grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));align-items:end}
            .sample{display:grid;gap:10px;justify-items:center;text-align:center}
            .sample strong{font:600 12px/1 var(--font-ui);color:rgba(0,0,0,.45);text-transform:uppercase;letter-spacing:.08em}
            .sample p{margin:0;font:400 12px/1.2 var(--font-ui);color:rgba(0,0,0,.45)}
            .ty-toolbar{display:flex;gap:12px;align-items:center;margin-bottom:20px}
            .ty-input{flex:1;min-width:240px;padding:12px 14px;border:0;border-radius:12px;background:var(--color-surface);font:500 14px var(--font-ui);color:var(--color-text)}
            .ty-size{width:220px}
            .ty-size-label{font:500 12px var(--font-ui);color:rgba(0,0,0,.5);min-width:48px;text-align:right}
            .ty-list{display:grid;gap:32px}
            .ty-row{padding:12px 0;border-bottom:1px solid rgba(0,0,0,0.08)}
            .ty-name{font:600 12px var(--font-ui);letter-spacing:.06em;text-transform:uppercase;color:rgba(0,0,0,.55);margin-bottom:6px}
            .color-table{display:grid;gap:24px}
            .color-group-title{font:700 12px var(--font-ui);letter-spacing:.08em;text-transform:uppercase;color:rgba(0,0,0,.45);margin-top:12px}
            .color-row{display:grid;grid-template-columns:180px repeat(14,minmax(0,1fr));gap:16px;align-items:flex-start}
            .color-header-row{font:600 11px var(--font-ui);text-transform:uppercase;letter-spacing:.06em;color:rgba(0,0,0,.55);line-height:1.3}
            .color-name{display:grid;gap:6px}
            .color-token{font:500 11px var(--font-ui);color:rgba(0,0,0,.5)}
            .color-cell{display:grid;gap:4px;justify-items:start}
            .color-chip{width:48px;height:48px;border-radius:12px;box-shadow:0 1px 3px rgba(0,0,0,.12)}
            .color-chip-label{font:600 11px var(--font-ui);letter-spacing:.04em;text-transform:uppercase;color:var(--color-text);line-height:1.2}
            .color-rgb{font:500 10px var(--font-ui);color:var(--color-text);line-height:1.2;opacity:.75}
            .button-table{display:grid;gap:32px}
            .button-section{display:grid;gap:10px}
            .button-section-head{font:600 var(--fs-16,1rem)/1.2 var(--font-ui);text-transform:uppercase;letter-spacing:.08em;color:color-mix(in oklab,var(--color-text),transparent 20%);padding-bottom:2px;border-bottom:1px solid color-mix(in oklab,var(--color-border),transparent 50%)}
            .button-row{display:grid;grid-template-columns:minmax(140px,180px) repeat(4,minmax(0,1fr));gap:18px;align-items:start;padding:6px 0;border-bottom:1px solid color-mix(in oklab,var(--color-border),transparent 65%)}
            .button-head{padding:0}
            .button-cell{display:flex;flex-direction:column;gap:6px;color:var(--color-text)}
            .button-cell--variant-name{font:600 var(--fs-14,0.875rem)/1.2 var(--font-ui)}
            .button-meta--size{font:500 var(--fs-13,0.8125rem)/1.2 var(--font-ui);color:color-mix(in oklab,var(--color-text),transparent 25%)}
            .button-cell-content{display:flex;justify-content:space-between;align-items:center;gap:16px}
            .button-copy{display:flex;flex-direction:column;gap:1px;text-align:left;min-width:120px}
            .button-meta--size{font:600 var(--fs-10,0.625rem)/1.1 var(--font-ui);color:color-mix(in oklab,var(--color-text),transparent 25%);text-transform:uppercase;letter-spacing:.04em}
            .button-attr{font:500 var(--fs-9,0.5625rem)/1.05 var(--font-ui);color:color-mix(in oklab,var(--color-text),transparent 50%)}
            .button-visual{display:flex;justify-content:flex-start}
            :root[data-theme="dark"], [data-theme="dark"] {
              --color-bg: #0e0f13;
              --color-surface: #14161b;
              --color-text: #f5f6f8;
              --color-text-muted: rgba(245,246,248,0.72);
              --color-border: rgba(250,250,255,0.18);
              --state-hover-alpha-on-surface: 0.08;
              --state-active-alpha-on-surface: 0.12;
              --state-hover-alpha-on-primary: 0.10;
              --state-active-alpha-on-primary: 0.16;
              --kbd-bg: #eee;
              --kbd-text: #111;
            }
          </style>
        </head><body><div class=\"container\"><div id=\"mount\"></div></div></body></html>`);
        doc.close();
        const links = Array.from(doc.querySelectorAll('link[rel="stylesheet"]'));
        frameCssReady = Promise.all(
          links.map(link => {
            if (link.sheet) return Promise.resolve();
            return new Promise((resolve) => {
              const done = () => resolve();
              link.addEventListener('load', done, { once: true });
              link.addEventListener('error', done, { once: true });
              setTimeout(done, 2000); // safety: unblock if browser suppresses events on file://
            });
          })
        );
        frameReady = true;
      }

      async function ensureDarkStyleText() {
        // Offline-safe: attribute-scoped dark tokens copied from Dieter media block
        if (darkStyleText !== null) return darkStyleText;
        darkStyleText = `html[data-theme=dark]{
  --color-bg:#0e0f13; --color-surface:#14161b; --color-text:#f5f6f8;
  --color-text-muted:rgba(245,246,248,0.72); --color-border:rgba(250,250,255,0.18);
  --state-hover-alpha-on-surface:0.08; --state-active-alpha-on-surface:0.12;
  --state-hover-alpha-on-primary:0.10; --state-active-alpha-on-primary:0.16;
  --kbd-bg:#eee; --kbd-text:#111;
}
html[data-theme=dark],html[data-theme=dark] body{background:var(--color-bg)!important;color:var(--color-text)!important;}`;
        return darkStyleText;
      }

      async function setTheme(theme) {
        if (!frameReady) buildFrameDoc();
        await frameCssReady;
        const doc = frame.contentDocument;
        const id = 'diet-dark-attr';
        let style = doc.getElementById(id);
        if (!style) { style = doc.createElement('style'); style.id = id; doc.head.appendChild(style); }
        const css = await ensureDarkStyleText();
        if (theme === 'dark') {
          doc.documentElement.setAttribute('data-theme','dark');
          style.textContent = css;
        } else {
          doc.documentElement.removeAttribute('data-theme');
          style.textContent = '';
        }
      }

      async function renderInFrame(componentId) {
        if (!frameReady) buildFrameDoc();
        await frameCssReady;
        const doc = frame.contentDocument;
        const mount = doc.getElementById('mount');
        mount.innerHTML = '';
        const p = previews[componentId];
        if (p && typeof p.render === 'function') p.render(mount);
        else mount.textContent = `No preview for ${componentId}`;
      }


      const listEl = document.getElementById('list');
      const btnLight = document.getElementById('btn-light');
      const btnDark = document.getElementById('btn-dark');
      const titleEl = document.getElementById('title');
      let currentComponent = 'button';

      function renderList() {
        listEl.innerHTML = '';
        for (const c of components) {
          if (c.id === '__divider__') {
            const li = document.createElement('li');
            li.className = 'divider';
            listEl.appendChild(li);
            continue;
          }
          const li = document.createElement('li');
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = 'item';
          btn.dataset.componentId = c.id;
          btn.textContent = toTitle(c.id);
          btn.addEventListener('click', () => selectComponent(c.id));
          li.appendChild(btn);
          listEl.appendChild(li);
        }
        syncActiveNav();
      }

      function syncActiveNav() {
        Array.from(listEl.querySelectorAll('.item')).forEach(btn => {
          btn.setAttribute('aria-current', btn.dataset.componentId === currentComponent ? 'true' : 'false');
        });
      }

      async function selectComponent(id) {
        currentComponent = id;
        syncActiveNav();
        titleEl.textContent = toTitle(id);
        await renderInFrame(id);
      }

      // variants list removed; all combinations are rendered directly

      // Theme toggle handlers (preview-only; attribute-scoped dark tokens)
      btnLight.addEventListener('click', async () => {
        btnLight.setAttribute('aria-pressed', 'true');
        btnDark.setAttribute('aria-pressed', 'false');
        await setTheme('light');
        await renderInFrame(currentComponent);
      });
      btnDark.addEventListener('click', async () => {
        btnLight.setAttribute('aria-pressed', 'false');
        btnDark.setAttribute('aria-pressed', 'true');
        await setTheme('dark');
        await renderInFrame(currentComponent);
      });

      function toTitle(id) {
        return id.replace(/[-_]/g, ' ') 
          .split(' ')
          .map(word => word ? word[0].toUpperCase() + word.slice(1).toLowerCase() : '')
          .join(' ');
      }

      // Color helpers
      function parseColor(value) {
        value = value.trim();
        if (value.startsWith('#')) {
          let hex = value.slice(1);
          if (hex.length === 3) hex = hex.split('').map(ch => ch + ch).join('');
          const num = parseInt(hex, 16);
          return {
            r: (num >> 16) & 255,
            g: (num >> 8) & 255,
            b: num & 255
          };
        }
        const match = value.match(/rgba?\(([^)]+)\)/i);
        if (match) {
          const parts = match[1].split(',').map(p => parseFloat(p.trim()));
          return { r: Math.round(parts[0] || 0), g: Math.round(parts[1] || 0), b: Math.round(parts[2] || 0) };
        }
        return { r: 0, g: 0, b: 0 };
      }

      function rgbToHex({ r, g, b }) {
        const toHex = n => n.toString(16).padStart(2, '0');
        return '#' + toHex(r) + toHex(g) + toHex(b);
      }

      function normalizeHex(value) {
        const rgb = parseColor(value);
        return rgbToHex(rgb).toUpperCase();
      }

      function mixColors(color, target, amount) {
        const a = parseColor(color);
        const b = parseColor(target);
        const mix = (x, y) => Math.round(x * (1 - amount) + y * amount);
        return rgbToHex({ r: mix(a.r, b.r), g: mix(a.g, b.g), b: mix(a.b, b.b) }).toUpperCase();
      }

      function colorCell(label, hex) {
        const { r, g, b } = parseColor(hex);
        return `
          <div class="color-cell">
            <div class="color-chip" style="background:${hex}"></div>
            <div class="color-chip-label">${label.toUpperCase()}</div>
            <div class="color-rgb">R ${r} G ${g} B ${b}</div>
          </div>`;
      }
      function sunSvg() {
        return '<svg width="15" height="15" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="1" stroke-linecap="round" aria-hidden="true"><circle cx="6" cy="6" r="2"/><g stroke-dasharray="1.5 1.5"><polyline points="6 10,6 11.5" transform="rotate(0,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(45,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(90,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(135,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(180,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(225,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(270,6,6)" /><polyline points="6 10,6 11.5" transform="rotate(315,6,6)" /></g></svg>';
      }
      function sunGlyph() {
        return '<svg viewBox="0 0 32 32" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><circle cx="16" cy="16" r="6"/><path d="M16 4v4M16 24v4M6.34 6.34l2.83 2.83M22.83 22.83l2.83 2.83M4 16h4M24 16h4M6.34 25.66l2.83-2.83M22.83 9.17l2.83-2.83"/></svg>';
      }

      function moonGlyph() {
        return '<svg viewBox="0 0 24 24" fill="currentColor" aria-hidden="true"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79Z"/></svg>';
      }

      function autoGlyph() {
        return '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M12 3v6"/><path d="M12 21v-6"/><path d="M3 12h6"/><path d="M21 12h-6"/><circle cx="12" cy="12" r="4"/></svg>';
      }

      // initial render
      renderList();

      // auto-select button if present
      setTheme('light').then(() => selectComponent('button'));
    </script>
  </body>
  </html>
