name: cloud-dev roma app deploy

on:
  push:
    branches: [main]
    paths:
      - "roma/**"
      - "bob/**"
      - "scripts/build-bob-cf.mjs"
      - "scripts/build-roma-cf.mjs"
      - "package.json"
      - "pnpm-lock.yaml"
      - "pnpm-workspace.yaml"
      - ".github/workflows/cloud-dev-roma-app.yml"
  workflow_dispatch: {}

concurrency:
  group: cloud-dev-roma
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
      CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      PARIS_BASE_URL: https://paris.dev.clickeen.com
      NEXT_PUBLIC_TOKYO_URL: https://tokyo.dev.clickeen.com

      ROMA_PAGES_PROJECT: roma-dev
      BOB_PAGES_PROJECT: bob-dev
      RUNTIME_PARITY_SUPABASE_BEARER_CLOUD: ${{ secrets.RUNTIME_PARITY_SUPABASE_BEARER }}
      RUNTIME_PARITY_TOKYO_DEV_JWT: ${{ secrets.RUNTIME_PARITY_TOKYO_DEV_JWT }}
      RUNTIME_PARITY_PUBLIC_ID: ${{ vars.RUNTIME_PARITY_PUBLIC_ID }}
      RUNTIME_PARITY_PUBLISH_PUBLIC_ID: ${{ vars.RUNTIME_PARITY_PUBLISH_PUBLIC_ID }}
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with: {}

      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: pnpm

      - uses: supabase/setup-cli@v1
        with:
          version: 2.75.0

      - name: Install deps
        run: pnpm install --frozen-lockfile

      - name: Lint
        run: pnpm lint

      - name: Typecheck
        run: pnpm typecheck

      - name: Contract checks
        run: pnpm test:contracts

      - name: Paris boundary gate
        run: pnpm test:paris-boundary

      - name: Bob bootstrap boundary gate
        run: pnpm test:bob-bootstrap-boundary

      - name: Runtime parity release gates (pre-deploy)
        run: |
          export CK_ADMIN_EMAIL="local.admin@clickeen.local"
          export CK_ADMIN_PASSWORD="ci-local-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-$(openssl rand -hex 8)"
          export PARIS_DEV_JWT="ci-local-${GITHUB_RUN_ID}-${GITHUB_RUN_ATTEMPT}-paris"
          export TOKYO_DEV_JWT="$PARIS_DEV_JWT"
          bash scripts/dev-up.sh --reset > /tmp/dev-up-runtime-parity.log 2>&1 || (tail -n 200 /tmp/dev-up-runtime-parity.log && exit 1)
          pnpm test:runtime-parity:public
          pnpm test:runtime-parity:auth
          pnpm test:runtime-parity:cloud-dev:public
          pnpm test:runtime-parity:cloud-dev:auth
          pnpm test:runtime-parity:cross-env

      - name: Build Bob for Cloudflare Pages
        run: pnpm -C bob build:cf

      - name: Ensure Bob Pages project exists (cloud-dev)
        run: pnpm -C tokyo-worker exec wrangler --cwd ../bob pages project create "$BOB_PAGES_PROJECT" --production-branch main || true

      - name: Align Bob Pages runtime vars (cloud-dev)
        run: |
          printf '%s' "$PARIS_BASE_URL" | pnpm -C tokyo-worker exec wrangler pages secret put PARIS_BASE_URL --project-name "$BOB_PAGES_PROJECT"
          printf '%s' "$NEXT_PUBLIC_TOKYO_URL" | pnpm -C tokyo-worker exec wrangler pages secret put NEXT_PUBLIC_TOKYO_URL --project-name "$BOB_PAGES_PROJECT"

      - name: Deploy Bob Pages (cloud-dev)
        run: pnpm -C tokyo-worker exec wrangler --cwd ../bob pages deploy .cloudflare/output/static --project-name "$BOB_PAGES_PROJECT" --branch main --commit-dirty=true

      - name: Build Roma for Cloudflare Pages
        run: pnpm -C roma build:cf

      - name: Ensure Roma Pages project exists (cloud-dev)
        run: pnpm -C tokyo-worker exec wrangler --cwd ../roma pages project create "$ROMA_PAGES_PROJECT" --production-branch main || true

      - name: Align Roma Pages runtime vars (cloud-dev)
        run: |
          printf '%s' "$PARIS_BASE_URL" | pnpm -C tokyo-worker exec wrangler pages secret put PARIS_BASE_URL --project-name "$ROMA_PAGES_PROJECT"
          printf '%s' "$NEXT_PUBLIC_TOKYO_URL" | pnpm -C tokyo-worker exec wrangler pages secret put NEXT_PUBLIC_TOKYO_URL --project-name "$ROMA_PAGES_PROJECT"

      - name: Deploy Roma Pages (cloud-dev)
        run: pnpm -C tokyo-worker exec wrangler --cwd ../roma pages deploy .vercel/output/static --project-name "$ROMA_PAGES_PROJECT" --branch main --commit-dirty=true

      - name: Runtime parity checks (cloud-dev auth)
        run: node scripts/ci/runtime-parity/index.mjs --env cloud-dev --mode auth --json-out artifacts/runtime-parity-cloud-dev-roma-app-auth.json

      - name: Runtime parity checks (cloud-dev public)
        run: node scripts/ci/runtime-parity/index.mjs --env cloud-dev --mode public --json-out artifacts/runtime-parity-cloud-dev-roma-app-public.json

      - name: Upload runtime parity artifact (roma app)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: runtime-parity-cloud-dev-roma-app
          path: |
            artifacts/runtime-parity-cloud-dev-roma-app-auth.json
            artifacts/runtime-parity-cloud-dev-roma-app-public.json
